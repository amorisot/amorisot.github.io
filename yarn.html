<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fleece to Fashion</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

  :root{
    --bg:#f5f0e8;
    --header:#ede7dc;
    --border:#d9d0c3;
    --text:#4a3f35;
    --text-dim:#8a7e72;
    --accent:#7b9e6b;

    --pasture:#e4ecda;
    --pasture-back:#d6e2c8;
    --mill:#fce8d0;
    --mill-back:#f5d8b8;
    --shop:#d4a5a5;
    --shop-front:#f2e0e0;
    --shop-back:#e8cece;
    --studio:#c4b7d4;
    --studio-front:#ebe4f2;
    --studio-back:#ddd4e8;

    --card-radius:14px;
    --shadow:0 2px 12px rgba(74,63,53,.1);
    --flip-dur:.6s;
  }

  html,body{height:100%;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

  /* â”€â”€ Header â”€â”€ */
  .header{
    position:sticky;top:0;z-index:100;
    display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px 20px;
    padding:10px 20px;
    background:var(--header);border-bottom:1px solid var(--border);
    box-shadow:0 1px 6px rgba(74,63,53,.06);
  }
  .header h1{font-size:1.1rem;font-weight:700;letter-spacing:.02em;white-space:nowrap}
  .header h1 span{font-weight:400;opacity:.65;font-size:.9rem}
  .resources{display:flex;gap:14px;flex-wrap:wrap}
  .res{
    display:flex;align-items:center;gap:5px;
    padding:5px 12px;border-radius:8px;
    background:rgba(255,255,255,.6);border:1px solid var(--border);
    font-size:.82rem;font-weight:600;white-space:nowrap;
  }
  .res .icon{font-size:1rem}
  .res .val{color:var(--accent);min-width:24px;text-align:right;display:inline-block}
  .res .val.pulse{animation:res-pulse .35s ease}
  @keyframes res-pulse{0%{transform:scale(1)}50%{transform:scale(1.18);color:#5a7}100%{transform:scale(1)}}

  /* â”€â”€ Grid â”€â”€ */
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    grid-template-rows:1fr 1fr;
    gap:12px;padding:12px;
    height:calc(100vh - 92px);
    min-height:480px;
  }
  @media(max-width:720px){
    .grid{grid-template-columns:1fr;grid-template-rows:repeat(4,minmax(320px,1fr));height:auto;min-height:auto}
  }

  /* â”€â”€ Flip Card â”€â”€ */
  .flip-card{perspective:1000px}
  .flip-inner{
    position:relative;width:100%;height:100%;
    transition:transform var(--flip-dur) cubic-bezier(.4,.2,.2,1);
    transform-style:preserve-3d;
  }
  .flip-card.flipped .flip-inner{transform:rotateY(180deg)}
  .flip-front,.flip-back{
    position:absolute;inset:0;
    backface-visibility:hidden;
    border-radius:var(--card-radius);
    display:flex;flex-direction:column;
    overflow:hidden;
    box-shadow:var(--shadow);
    border:1px solid var(--border);
  }
  .flip-back{transform:rotateY(180deg);pointer-events:none}
  .flip-card.flipped .flip-front{pointer-events:none}
  .flip-card.flipped .flip-back{pointer-events:auto}

  /* â”€â”€ Pane Chrome â”€â”€ */
  .pane-header{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 14px 6px;flex-shrink:0;
  }
  .pane-header h2{font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:6px}
  .pane-header h2 .emoji{font-size:1.1rem}
  .flip-btn{
    background:none;border:none;cursor:pointer;
    font-size:.78rem;color:var(--text-dim);
    display:flex;align-items:center;gap:3px;
    padding:3px 6px;border-radius:5px;
    transition:background .2s,color .2s;
  }
  .flip-btn:hover{background:rgba(0,0,0,.06);color:var(--text)}
  .flip-btn svg{width:14px;height:14px}

  .pane-body{
    flex:1;min-height:0;display:flex;flex-direction:column;
    padding:4px 14px 14px;gap:6px;
    overflow-y:auto;
    overscroll-behavior:contain;
  }
  .pane-body::-webkit-scrollbar{width:6px}
  .pane-body::-webkit-scrollbar-track{background:transparent}
  .pane-body::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

  .rate-summary{font-size:.76rem;color:var(--text-dim);font-style:italic;padding:2px 0 4px;border-bottom:1px solid rgba(0,0,0,.06);margin-bottom:4px}

  /* â”€â”€ Pane colours â”€â”€ */
  .pane-pasture .flip-front{background:var(--pasture)}
  .pane-pasture .flip-back{background:var(--pasture-back)}
  .pane-mill .flip-front{background:var(--mill)}
  .pane-mill .flip-back{background:var(--mill-back)}
  .pane-shop .flip-front{background:var(--shop-front)}
  .pane-shop .flip-back{background:var(--shop-back)}
  .pane-studio .flip-front{background:var(--studio-front)}
  .pane-studio .flip-back{background:var(--studio-back)}

  /* â”€â”€ Upgrade Row â”€â”€ */
  .upgrade-row{
    display:flex;align-items:center;gap:8px;
    padding:6px 8px;border-radius:8px;
    background:rgba(255,255,255,.35);
    transition:background .15s;
    min-height:40px;
  }
  .upgrade-row:hover{background:rgba(255,255,255,.55)}
  .upgrade-row .u-emoji{font-size:1.1rem;flex-shrink:0;width:24px;text-align:center}
  .upgrade-row .u-info{flex:1;min-width:0}
  .upgrade-row .u-name{font-size:.82rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .upgrade-row .u-desc{font-size:.68rem;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .upgrade-row .u-owned{font-size:.72rem;color:var(--text-dim);flex-shrink:0;min-width:20px;text-align:center}
  .upgrade-row .u-owned.has{color:var(--accent);font-weight:700}
  .upgrade-row .u-buy{
    padding:5px 10px;border:none;border-radius:6px;
    font-size:.74rem;font-weight:700;cursor:pointer;
    color:#fff;background:var(--accent);
    transition:transform .1s,opacity .15s;
    flex-shrink:0;white-space:nowrap;
  }
  .upgrade-row .u-buy:hover{transform:translateY(-1px)}
  .upgrade-row .u-buy:disabled{opacity:.35;cursor:not-allowed;transform:none}
  .upgrade-row .u-buy.one-time-bought{background:#aaa;opacity:.5}

  /* â”€â”€ Tier pips in upgrade rows â”€â”€ */
  .u-tier-dots{display:flex;gap:2px;flex-wrap:wrap;max-width:60px;flex-shrink:0;align-items:center}
  .u-tier-pip{width:6px;height:6px;border-radius:50%;flex-shrink:0}

  /* â”€â”€ Tier distribution in character modal â”€â”€ */
  .tier-distribution{display:flex;gap:3px;flex-wrap:wrap;justify-content:center;margin-bottom:4px}
  .tier-dot{width:10px;height:10px;border-radius:50%;border:1px solid rgba(0,0,0,.15)}
  .tier-summary{font-size:.72rem;color:var(--text-dim);text-align:center}

  /* â”€â”€ Inline Build Progress â”€â”€ */
  .u-build-bar{
    width:60px;height:20px;flex-shrink:0;
    background:rgba(0,0,0,.08);border-radius:4px;
    overflow:hidden;position:relative;
  }
  .u-build-fill{
    height:100%;border-radius:4px;
    background:var(--accent);
    transition:width .3s linear;
  }
  .u-build-bar::after{
    content:'';position:absolute;inset:0;
    background:linear-gradient(90deg,transparent 40%,rgba(255,255,255,.25) 50%,transparent 60%);
    animation:build-shimmer 1.2s ease-in-out infinite;
  }
  @keyframes build-shimmer{
    0%{transform:translateX(-100%)}
    100%{transform:translateX(100%)}
  }

  /* sell fiber button */
  .sell-btn{
    padding:5px 10px;border:none;border-radius:6px;
    font-size:.74rem;font-weight:700;cursor:pointer;
    color:#fff;background:#8a7e60;
    transition:transform .1s,opacity .15s;
    flex-shrink:0;white-space:nowrap;
  }
  .sell-btn:hover{transform:translateY(-1px)}
  .sell-btn:disabled{opacity:.35;cursor:not-allowed;transform:none}

  /* Pane-specific button colors */
  .pane-mill .u-buy{background:#c5944a}
  .pane-shop .u-buy{background:#b07070}
  .pane-studio .u-buy{background:#8a6fa0}

  /* â”€â”€ Section Label â”€â”€ */
  .section-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-dim);padding:6px 0 2px;opacity:.7}

  /* â”€â”€ Studio Progress Bar â”€â”€ */
  .progress-wrap{
    width:100%;background:rgba(0,0,0,.08);border-radius:6px;overflow:hidden;height:22px;position:relative;
  }
  .progress-bar{
    height:100%;background:linear-gradient(90deg,#c4b7d4,#8a6fa0);border-radius:6px;
    transition:width .3s linear;width:0;
  }
  .progress-text{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-size:.72rem;font-weight:700;color:var(--text);
  }
  .project-status{font-size:.76rem;color:var(--text-dim);font-style:italic;text-align:center;padding:2px 0}

  /* â”€â”€ Back Side Visual â”€â”€ */
  .back-visual{
    flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;
    padding:16px;position:relative;overflow:hidden;
  }
  .bouncer{
    font-size:2.4rem;
    animation:bounce 2.4s ease-in-out infinite;
    filter:drop-shadow(0 3px 6px rgba(0,0,0,.08));
  }
  @keyframes bounce{
    0%,100%{transform:translateY(0) scale(1)}
    50%{transform:translateY(-14px) scale(1.06)}
  }
  .pulser{
    font-size:2.4rem;
    animation:gentle-pulse 2s ease-in-out infinite;
    filter:drop-shadow(0 3px 6px rgba(0,0,0,.08));
  }
  @keyframes gentle-pulse{
    0%,100%{transform:scale(1);opacity:.85}
    50%{transform:scale(1.12);opacity:1}
  }
  .spinner{
    font-size:2.8rem;
    animation:spin 3s linear infinite;
    filter:drop-shadow(0 3px 6px rgba(0,0,0,.08));
  }
  @keyframes spin{
    0%{transform:rotate(0deg)}
    100%{transform:rotate(360deg)}
  }
  .back-label{
    margin-top:10px;font-size:.8rem;color:var(--text-dim);font-style:italic;text-align:center;
  }
  .animal-grid{
    display:flex;flex-wrap:wrap;gap:4px;justify-content:center;max-width:90%;
  }
  .animal-grid .mini-animal{font-size:1.2rem;animation:bounce 2.4s ease-in-out infinite}
  .animal-grid .mini-animal:nth-child(odd){animation-delay:-.8s}
  .animal-grid .mini-animal:nth-child(3n){animation-delay:-1.6s}
  .animal-count{font-size:.75rem;color:var(--text-dim);margin-top:6px}

  /* â”€â”€ Pasture Back: Rolling Hills Scene â”€â”€ */
  .pasture-scene{width:100%;height:100%;position:relative;overflow:hidden;border-radius:0 0 var(--card-radius) var(--card-radius)}
  .pasture-sky{
    position:absolute;inset:0;
    transition:background 2s ease;
  }
  .hill{
    position:absolute;bottom:0;left:-10%;width:120%;border-radius:50% 50% 0 0;
  }
  .hill-far{height:55%;background:#a3bf8f;opacity:.5;animation:hill-sway 12s ease-in-out infinite}
  .hill-mid{height:42%;background:#8fb37a;opacity:.7;animation:hill-sway 9s ease-in-out infinite reverse}
  .hill-near{height:30%;background:#7ba368;opacity:.9;animation:hill-sway 7s ease-in-out infinite}
  @keyframes hill-sway{
    0%,100%{transform:translateX(0)}
    50%{transform:translateX(8px)}
  }
  .pasture-animals-scene{
    position:absolute;bottom:0;left:0;right:0;top:40%;
  }
  .scene-animal{
    position:absolute;font-size:1.3rem;
    filter:drop-shadow(0 2px 3px rgba(0,0,0,.15));
    transition:left 3s ease-in-out,top 3s ease-in-out,transform .3s ease,filter .3s ease;
    cursor:pointer;pointer-events:auto;
  }
  .scene-animal.tier-1{filter:drop-shadow(0 0 4px #cd7f32) drop-shadow(0 2px 3px rgba(0,0,0,.15))}
  .scene-animal.tier-2{filter:drop-shadow(0 0 5px #c0c0c0) drop-shadow(0 2px 3px rgba(0,0,0,.15))}
  .scene-animal.tier-3{filter:drop-shadow(0 0 6px #ffd700) drop-shadow(0 0 12px rgba(255,215,0,.3)) drop-shadow(0 2px 3px rgba(0,0,0,.15))}
  .pasture-info{
    position:absolute;bottom:4px;width:100%;text-align:center;
    font-size:.72rem;color:rgba(74,63,53,.6);font-style:italic;
  }

  /* â”€â”€ Mill Back: Spinning Wheel + Conveyor â”€â”€ */
  .mill-scene{width:100%;height:100%;position:relative;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}
  .css-wheel{
    position:relative;width:90px;height:90px;
    animation:spin 3s linear infinite;
  }
  .wheel-rim{
    position:absolute;inset:0;
    border:4px solid #8b6914;border-radius:50%;
    background:radial-gradient(circle,transparent 55%,rgba(139,105,20,.12) 56%);
  }
  .wheel-hub{
    position:absolute;top:50%;left:50%;width:14px;height:14px;
    background:#8b6914;border-radius:50%;
    transform:translate(-50%,-50%);
  }
  .wheel-spoke{
    position:absolute;top:50%;left:50%;width:2px;height:42px;
    background:#8b6914;transform-origin:top center;border-radius:1px;
  }
  .conveyor{
    width:80%;height:24px;position:relative;
    background:rgba(0,0,0,.06);border-radius:12px;overflow:hidden;
  }
  .conveyor-label{font-size:.65rem;color:var(--text-dim);display:flex;justify-content:space-between;width:80%;opacity:.7}
  .conv-dot{
    position:absolute;top:50%;width:10px;height:10px;border-radius:50%;
    transform:translateY(-50%);
    animation:conv-move 2.5s linear infinite;
  }
  @keyframes conv-move{
    0%{left:-10px;background:#a08060;transform:translateY(-50%) scale(.8)}
    40%{background:#b09070}
    60%{background:#c4a0d0}
    100%{left:calc(100% + 10px);background:#8a6fa0;transform:translateY(-50%) scale(1)}
  }
  .mill-rate-label{font-size:.75rem;color:var(--text-dim);font-style:italic;text-align:center}

  /* â”€â”€ Shop Back: Yarn District City Map â”€â”€ */
  .city-scene{width:100%;height:100%;position:relative;overflow:hidden}
  .city-ground{
    position:absolute;inset:0;
    background:
      repeating-linear-gradient(90deg,rgba(0,0,0,.02) 0px,rgba(0,0,0,.02) 1px,transparent 1px,transparent 12px),
      repeating-linear-gradient(0deg,rgba(0,0,0,.02) 0px,rgba(0,0,0,.02) 1px,transparent 1px,transparent 12px),
      linear-gradient(180deg,#e8dcc8 0%,#ddd0b8 60%,#d0c4a8 100%);
  }
  .city-roads{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .city-road-path{fill:none;stroke:rgba(160,140,110,.3);stroke-width:2.5;stroke-dasharray:4 3;stroke-linecap:round}
  .city-buildings{position:absolute;inset:0}
  .city-building{
    position:absolute;transform:translate(-50%,-100%);
    cursor:pointer;transition:transform .2s ease,filter .2s ease;
    display:flex;flex-direction:column;align-items:center;
  }
  .city-building:hover{transform:translate(-50%,-100%) scale(1.12);z-index:5}
  .city-building.active .city-building-body{box-shadow:0 0 10px var(--bldg-glow,rgba(200,180,140,.5))}
  .city-building.active{animation:building-pulse 3s ease-in-out infinite}
  .city-building.idle{filter:grayscale(.4);opacity:.55}
  .city-building.idle .city-building-window{background:rgba(0,0,0,.15)!important}
  @keyframes building-pulse{
    0%,100%{transform:translate(-50%,-100%) scale(1)}
    50%{transform:translate(-50%,-100%) scale(1.04)}
  }
  .city-building-roof{
    clip-path:polygon(50% 0%,0% 100%,100% 100%);
  }
  .city-building.small .city-building-roof{width:28px;height:10px}
  .city-building.medium .city-building-roof{width:38px;height:12px}
  .city-building.large .city-building-roof{width:50px;height:14px}
  .city-building-body{
    display:flex;flex-wrap:nowrap;align-items:flex-start;justify-content:space-evenly;
    gap:3px;padding:4px 3px 10px;border-radius:0 0 2px 2px;position:relative;
    border:1px solid rgba(0,0,0,.08);border-top:none;
  }
  .city-building.small .city-building-body{width:26px;min-height:18px}
  .city-building.medium .city-building-body{width:36px;min-height:24px}
  .city-building.large .city-building-body{width:48px;min-height:28px}
  .city-building-window{
    width:6px;height:6px;border-radius:1px;
    background:#f0d860;box-shadow:0 0 3px rgba(240,216,96,.4);
    border:1px solid rgba(0,0,0,.1);
  }
  .city-building-door{
    width:7px;height:9px;background:rgba(60,40,20,.25);border-radius:2px 2px 0 0;
    position:absolute;bottom:0;left:50%;transform:translateX(-50%);
    border:1px solid rgba(0,0,0,.08);border-bottom:none;
  }
  .city-building-door::after{
    content:'';position:absolute;right:1px;top:50%;width:2px;height:2px;
    border-radius:50%;background:rgba(0,0,0,.2);
  }
  .city-building.large .city-building-door{width:10px;height:11px}
  .city-chimney{
    position:absolute;top:-6px;right:2px;width:4px;height:8px;
    background:#6a5a4a;border-radius:1px 1px 0 0;
  }
  .city-smoke{
    position:absolute;top:-4px;left:50%;transform:translateX(-50%);
    width:4px;height:4px;background:rgba(180,170,160,.5);border-radius:50%;
    animation:smoke-puff 2.5s ease-out infinite;
  }
  .city-smoke::after{
    content:'';position:absolute;top:-6px;left:-1px;
    width:5px;height:5px;background:rgba(180,170,160,.3);border-radius:50%;
    animation:smoke-puff 2.5s ease-out .8s infinite;
  }
  @keyframes smoke-puff{
    0%{opacity:.6;transform:translateX(-50%) translateY(0) scale(.6)}
    100%{opacity:0;transform:translateX(-50%) translateY(-14px) scale(1.2)}
  }
  .city-building-sign{
    margin-top:2px;font-size:.42rem;font-weight:700;color:rgba(80,60,40,.7);
    text-align:center;white-space:nowrap;letter-spacing:.02em;
    text-shadow:0 0 3px rgba(255,255,255,.8);
  }
  .city-building-glow{
    position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);
    width:40px;height:14px;border-radius:50%;pointer-events:none;
  }
  .city-ambient{position:absolute;inset:0;pointer-events:none;overflow:hidden}
  .city-customer{
    position:absolute;bottom:10%;font-size:.7rem;
    animation:city-walk var(--walk-dur,5s) linear forwards;pointer-events:none;
  }
  @keyframes city-walk{
    0%{left:-20px;opacity:0}
    5%{opacity:1}
    90%{opacity:1}
    100%{left:calc(100% + 20px);opacity:0}
  }
  .city-info{
    position:absolute;bottom:0;left:0;right:0;
    padding:3px 8px;font-size:.55rem;color:rgba(80,60,40,.7);
    background:rgba(255,255,255,.4);backdrop-filter:blur(2px);
    display:flex;align-items:center;gap:6px;flex-wrap:wrap;
  }
  .city-info .fo-item{display:inline-flex;align-items:center;gap:1px;font-size:.55rem}
  .city-info .fo-badge{font-size:.45rem;opacity:.6;font-weight:700}

  /* â”€â”€ Studio Back: Knitting Needles + Fabric â”€â”€ */
  .studio-scene{width:100%;height:100%;position:relative;overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px}
  .needles-wrap{position:relative;width:120px;height:80px}
  .needle{
    position:absolute;width:3px;height:90px;
    background:linear-gradient(to bottom,#c0c0c0,#909090);border-radius:2px 2px 0 0;
    bottom:0;
  }
  .needle::before{
    content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);
    width:7px;height:7px;background:#d4d4d4;border-radius:50%;
  }
  .needle-l{left:35%;transform:rotate(-12deg)}
  .needle-r{right:35%;transform:rotate(12deg)}
  .fabric-strip{
    position:absolute;bottom:0;left:50%;transform:translateX(-50%);
    width:50px;border-radius:4px 4px 0 0;
    background:linear-gradient(180deg,#c4b7d4 0%,#a890c0 50%,#8a6fa0 100%);
    transition:height .5s ease;
    overflow:hidden;
  }
  .fabric-strip .stitch-line{
    width:100%;height:4px;
    border-bottom:1px dashed rgba(255,255,255,.3);
  }
  .studio-project-label{font-size:.78rem;color:var(--text-dim);font-style:italic;text-align:center}
  .studio-fo-count{font-size:.72rem;color:var(--text-dim);opacity:.7}

  /* confetti burst on completion */
  .confetti{
    position:absolute;width:6px;height:6px;border-radius:1px;
    animation:confetti-pop 1.2s ease-out forwards;
    pointer-events:none;
  }
  @keyframes confetti-pop{
    0%{transform:translate(0,0) rotate(0deg) scale(1);opacity:1}
    100%{transform:translate(var(--cx),var(--cy)) rotate(720deg) scale(0);opacity:0}
  }
  .completion-emoji{
    position:absolute;font-size:2rem;
    animation:fo-pop 2s ease-out forwards;
    pointer-events:none;
  }
  @keyframes fo-pop{
    0%{transform:scale(0) translateY(0);opacity:0}
    15%{transform:scale(1.4) translateY(-10px);opacity:1}
    30%{transform:scale(1) translateY(-20px);opacity:1}
    100%{transform:scale(.7) translateY(-80px);opacity:0}
  }

  /* ambient floating particles */
  .particle{
    position:absolute;opacity:.2;font-size:1rem;
    animation:float linear infinite;
    pointer-events:none;
  }
  @keyframes float{
    0%{transform:translateY(100%) rotate(0deg)}
    100%{transform:translateY(-120%) rotate(360deg)}
  }

  /* â”€â”€ Ticker Tape â”€â”€ */
  .ticker{
    position:fixed;bottom:0;left:0;right:0;z-index:100;
    background:var(--header);border-top:1px solid var(--border);
    padding:6px 20px;
    font-size:.78rem;font-style:italic;color:var(--text-dim);
    text-align:center;
    transition:opacity .5s;
    height:30px;display:flex;align-items:center;justify-content:center;
  }
  .ticker.fade{opacity:0}

  /* â”€â”€ Milestone Toast â”€â”€ */
  .toast{
    position:fixed;top:-60px;left:50%;transform:translateX(-50%);
    z-index:200;padding:10px 24px;border-radius:10px;
    background:rgba(255,255,255,.95);border:2px solid var(--accent);
    box-shadow:0 4px 20px rgba(0,0,0,.12);
    font-size:.88rem;font-weight:700;color:var(--text);
    transition:top .5s cubic-bezier(.34,1.56,.64,1);
    pointer-events:none;white-space:nowrap;
  }
  .toast.show{top:16px}

  /* â”€â”€ Pasture Weather â”€â”€ */
  .weather-layer{position:absolute;inset:0;pointer-events:none;overflow:hidden}
  .cloud{
    position:absolute;top:8%;
    width:50px;height:18px;background:rgba(255,255,255,.7);border-radius:18px;
    animation:drift-cloud 25s linear infinite;
  }
  .cloud::before,.cloud::after{
    content:'';position:absolute;background:rgba(255,255,255,.7);border-radius:50%;
  }
  .cloud::before{width:24px;height:24px;top:-12px;left:8px}
  .cloud::after{width:32px;height:28px;top:-14px;left:20px}
  .cloud:nth-child(2){top:14%;animation-duration:32s;animation-delay:-10s;width:40px;height:14px}
  .cloud:nth-child(3){top:5%;animation-duration:20s;animation-delay:-18s;width:35px;height:12px;opacity:.5}
  @keyframes drift-cloud{0%{left:-80px}100%{left:calc(100% + 80px)}}
  .raindrop{
    position:absolute;width:2px;height:10px;
    background:rgba(120,160,200,.4);border-radius:0 0 2px 2px;
    animation:rain-fall 1s linear infinite;
  }
  @keyframes rain-fall{0%{top:-10px;opacity:.7}100%{top:100%;opacity:0}}
  .snowflake{
    position:absolute;color:rgba(255,255,255,.8);font-size:.55rem;
    animation:snow-fall 4s linear infinite;
  }
  @keyframes snow-fall{
    0%{top:-10px;transform:translateX(0);opacity:.8}
    50%{transform:translateX(15px)}
    100%{top:100%;transform:translateX(-5px);opacity:0}
  }

  /* â”€â”€ Character Screen â”€â”€ */
  .char-overlay{
    display:none;position:fixed;inset:0;z-index:300;
    background:rgba(30,25,20,.7);
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
    justify-content:center;align-items:center;
    animation:char-overlay-in .3s ease;
  }
  .char-overlay.active{display:flex}
  @keyframes char-overlay-in{from{opacity:0}to{opacity:1}}

  .char-modal{
    position:relative;width:min(420px,92vw);max-height:90vh;
    border-radius:20px;overflow:hidden;
    display:flex;flex-direction:column;align-items:center;
    background:var(--char-bg);
    box-shadow:0 0 40px var(--char-glow-color,rgba(200,195,180,.3)),0 8px 32px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.15);
    border:1px solid rgba(255,255,255,.1);
    animation:char-modal-in .5s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes char-modal-in{0%{opacity:0;transform:scale(.7) translateY(30px)}100%{opacity:1;transform:scale(1) translateY(0)}}

  .char-close{
    position:absolute;top:12px;right:14px;z-index:10;
    width:32px;height:32px;border:none;border-radius:50%;
    background:rgba(0,0,0,.2);color:rgba(255,255,255,.8);
    font-size:1.2rem;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    transition:background .2s,transform .15s;backdrop-filter:blur(4px);
  }
  .char-close:hover{background:rgba(0,0,0,.4);transform:scale(1.1)}

  .char-tier{
    margin-top:16px;padding:4px 16px;border-radius:20px;
    font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.12em;
    background:var(--char-tier-color,#7b9e6b);color:#fff;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
    animation:char-tier-in .6s ease .2s both;
  }
  @keyframes char-tier-in{from{opacity:0;transform:translateY(-10px) scale(.8)}to{opacity:1;transform:translateY(0) scale(1)}}

  .char-stage{
    position:relative;width:100%;height:220px;
    perspective:600px;display:flex;align-items:center;justify-content:center;
    overflow:hidden;cursor:grab;user-select:none;-webkit-user-select:none;
  }
  .char-stage:active{cursor:grabbing}

  .char-platform{
    position:absolute;bottom:20px;width:180px;height:50px;
    transform-style:preserve-3d;transform:rotateX(60deg);
  }
  .char-platform-ring{
    position:absolute;inset:0;
    border:3px solid rgba(255,255,255,.2);border-radius:50%;
    background:radial-gradient(ellipse,rgba(255,255,255,.08) 0%,transparent 70%);
    animation:platform-pulse 3s ease-in-out infinite;
  }
  .char-platform-ring-inner{inset:8px;border-color:rgba(255,255,255,.1);animation-delay:-1.5s}
  @keyframes platform-pulse{0%,100%{opacity:.6}50%{opacity:1}}

  .char-animal{position:relative;z-index:2;perspective:400px}
  .char-emoji{
    font-size:5rem;display:block;
    filter:drop-shadow(0 8px 16px rgba(0,0,0,.25));
  }

  @keyframes char-idle-chew{
    0%,100%{transform:translateY(0) rotate(0deg)}
    25%{transform:translateY(-2px) rotate(-2deg)}
    75%{transform:translateY(-2px) rotate(2deg)}
  }
  @keyframes char-idle-sway{
    0%,100%{transform:translateY(0) rotate(0deg)}
    50%{transform:translateY(-6px) rotate(3deg)}
  }
  @keyframes char-idle-hop{
    0%,60%,100%{transform:translateY(0)}
    30%{transform:translateY(-15px)}
    45%{transform:translateY(-5px)}
  }
  @keyframes char-idle-strut{
    0%,100%{transform:translateY(0) scaleX(1)}
    25%{transform:translateY(-3px) scaleX(1.03)}
    50%{transform:translateY(0) scaleX(1)}
    75%{transform:translateY(-3px) scaleX(.97)}
  }
  @keyframes char-idle-flutter{
    0%,100%{transform:translateY(0) scale(1)}
    25%{transform:translateY(-8px) scale(1.05)}
    50%{transform:translateY(-3px) scale(.98)}
    75%{transform:translateY(-10px) scale(1.03)}
  }

  .char-glow{
    position:absolute;width:120px;height:120px;border-radius:50%;
    background:var(--char-glow-color,rgba(200,195,180,.4));
    filter:blur(30px);z-index:1;
    animation:char-glow-pulse 2.5s ease-in-out infinite;
  }
  @keyframes char-glow-pulse{0%,100%{opacity:.5;transform:scale(1)}50%{opacity:.8;transform:scale(1.15)}}

  .char-particles{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:3}
  .char-particle{
    position:absolute;font-size:.8rem;opacity:0;
    animation:char-particle-float 4s ease-in-out infinite;pointer-events:none;
  }
  @keyframes char-particle-float{
    0%{opacity:0;transform:translate(0,0) scale(.5) rotate(0deg)}
    15%{opacity:.7}85%{opacity:.7}
    100%{opacity:0;transform:translate(var(--px),var(--py)) scale(1) rotate(360deg)}
  }
  .char-particle-puff{
    position:absolute;width:8px;height:8px;border-radius:50%;
    background:var(--char-particle-color,#e8e0d0);opacity:0;
    animation:char-puff-float 5s ease-in-out infinite;pointer-events:none;
  }
  @keyframes char-puff-float{
    0%{opacity:0;transform:translate(0,0) scale(.3)}
    20%{opacity:.5}80%{opacity:.3}
    100%{opacity:0;transform:translate(var(--px),var(--py)) scale(1.2)}
  }

  .char-info{
    width:100%;padding:16px 24px 20px;
    background:rgba(0,0,0,.15);backdrop-filter:blur(4px);
    display:flex;flex-direction:column;gap:6px;
    animation:char-info-in .5s ease .15s both;
  }
  @keyframes char-info-in{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  .char-name{font-size:1.3rem;font-weight:800;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.3)}
  .char-breed{font-size:.85rem;font-weight:600;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.06em}
  .char-tagline{font-size:.78rem;font-style:italic;color:rgba(255,255,255,.5);margin-bottom:4px}
  .char-stats{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0}
  .char-stat{flex:1;min-width:80px;display:flex;flex-direction:column;gap:3px}
  .char-stat-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:rgba(255,255,255,.5);font-weight:700}
  .char-stat-bar{height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
  .char-stat-fill{height:100%;border-radius:3px;background:var(--char-tier-color,#7b9e6b);width:0;transition:width .8s cubic-bezier(.4,0,.2,1) .3s}
  .char-stat-val{font-size:.82rem;font-weight:700;color:#fff}
  .char-stat-count{font-size:1.1rem}
  .char-flavor{font-size:.72rem;color:rgba(255,255,255,.45);font-style:italic;margin-top:2px}
  .char-drag-hint{
    position:absolute;bottom:8px;right:12px;
    font-size:.65rem;color:rgba(255,255,255,.3);
    animation:char-hint-fade 3s ease 1.5s both;pointer-events:none;
  }
  @keyframes char-hint-fade{0%{opacity:1}100%{opacity:0}}

  @media(max-width:720px){
    .char-modal{width:96vw;max-height:85vh;border-radius:16px}
    .char-emoji{font-size:4rem}
    .char-stage{height:180px}
    .char-info{padding:12px 16px 16px}
  }

  /* â”€â”€ Shop Detail Modal â”€â”€ */
  .shop-overlay{
    display:none;position:fixed;inset:0;z-index:300;
    background:rgba(30,25,20,.7);
    backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
    justify-content:center;align-items:center;
    animation:char-overlay-in .3s ease;
  }
  .shop-overlay.active{display:flex}
  .shop-detail{
    position:relative;width:min(440px,92vw);max-height:90vh;overflow-y:auto;
    border-radius:16px;
    background:var(--shop-color,#f2e0e0);
    box-shadow:0 0 30px rgba(0,0,0,.2),0 8px 32px rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.15);
    animation:char-modal-in .4s cubic-bezier(.34,1.56,.64,1);
  }
  .shop-detail-close{
    position:absolute;top:10px;right:12px;z-index:10;
    width:28px;height:28px;border:none;border-radius:50%;
    background:rgba(0,0,0,.15);color:rgba(255,255,255,.8);
    font-size:1.1rem;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    transition:background .2s,transform .15s;
  }
  .shop-detail-close:hover{background:rgba(0,0,0,.3);transform:scale(1.1)}
  .shop-detail-header{
    padding:20px 16px 14px;text-align:center;
    background:linear-gradient(180deg,var(--shop-roof,#9e6060) 0%,var(--shop-color,#d4a5a5) 100%);
    color:#fff;border-radius:16px 16px 0 0;
  }
  .shop-detail-emoji{font-size:2.5rem;margin-bottom:4px}
  .shop-detail-name{font-size:1.1rem;font-weight:800;letter-spacing:.04em}
  .shop-detail-tagline{font-size:.72rem;opacity:.7;font-style:italic;margin-top:2px}
  .shop-detail-scene{
    position:relative;height:80px;overflow:hidden;
    background:linear-gradient(180deg,var(--shop-color,#d4a5a5) 0%,rgba(255,255,255,.3) 100%);
    border-bottom:1px solid rgba(0,0,0,.06);
  }
  .shop-detail-shelf{
    position:absolute;bottom:8px;left:10%;right:10%;
    height:20px;border-bottom:2px solid rgba(120,90,60,.3);
    display:flex;align-items:flex-end;gap:2px;padding:0 4px;flex-wrap:wrap;
  }
  .shop-mini-ball{
    width:8px;height:8px;border-radius:50%;flex-shrink:0;
    animation:yarn-mini-wobble 2s ease-in-out infinite;
  }
  @keyframes yarn-mini-wobble{0%,100%{transform:translateY(0)}50%{transform:translateY(-1px)}}
  .shop-mini-customer{
    position:absolute;bottom:30px;font-size:.9rem;
    animation:shop-browse var(--browse-dur,3s) ease-in-out infinite alternate;
  }
  @keyframes shop-browse{
    0%{transform:translateX(0)}
    100%{transform:translateX(20px)}
  }
  .shop-detail-sections{padding:8px 0}
  .shop-section{
    padding:10px 16px;display:flex;gap:10px;align-items:flex-start;
    border-bottom:1px solid rgba(0,0,0,.05);
  }
  .shop-section:last-child{border-bottom:none}
  .shop-section-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px}
  .shop-section-body{flex:1;min-width:0}
  .shop-section-label{font-size:.7rem;font-weight:700;color:rgba(80,60,40,.7);text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px}
  .shop-section-content{font-size:.78rem;color:rgba(60,40,20,.8);line-height:1.5}
  .shop-section-content em{color:rgba(80,60,40,.6)}
  .shop-music-note{display:inline-block;animation:note-bounce 1s ease-in-out infinite;margin-right:4px}
  @keyframes note-bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
  .shop-event-item{padding:2px 0}
  .shop-stat{font-size:.9rem;font-weight:700;color:rgba(60,40,20,.9)}
  .shop-stat-dim{font-size:.78rem;color:rgba(80,60,40,.4);font-style:italic}

  /* â”€â”€ Character: Passives â”€â”€ */
  .char-passives{width:100%;margin-top:8px}
  .char-passive-name{font-size:.82rem;font-weight:700;color:rgba(255,255,255,.9);margin-bottom:2px}
  .char-passive-desc{font-size:.68rem;color:rgba(255,255,255,.45);font-style:italic;margin-bottom:6px}
  .char-passive-thresholds{display:flex;flex-direction:column;gap:3px}
  .char-passive-threshold{
    display:flex;align-items:center;gap:8px;
    padding:4px 8px;border-radius:6px;
    background:rgba(255,255,255,.05);
    font-size:.72rem;color:rgba(255,255,255,.4);
    transition:all .3s ease;
  }
  .char-passive-threshold.active{background:rgba(255,255,255,.12);color:rgba(255,255,255,.85)}
  .cpt-count{font-weight:700;min-width:60px}
  .cpt-label{flex:1}
  .cpt-check{font-size:.85rem}
  .char-passive-threshold.active .cpt-check{color:#7b9e6b}

  /* â”€â”€ Character: Ability â”€â”€ */
  .char-ability-wrap{width:100%;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,.08)}
  .char-ability-name{font-size:.85rem;font-weight:700;color:rgba(255,255,255,.9);margin-bottom:4px}
  .char-ability-desc{font-size:.68rem;color:rgba(255,255,255,.45);font-style:italic;margin-bottom:8px}
  .char-ability-btn{
    width:100%;padding:8px 16px;border:none;border-radius:8px;
    font-size:.82rem;font-weight:700;cursor:pointer;color:#fff;
    background:linear-gradient(135deg,var(--char-tier-color,#7b9e6b),rgba(0,0,0,.2));
    box-shadow:0 2px 8px rgba(0,0,0,.2);
    transition:transform .15s,opacity .15s,box-shadow .15s;
  }
  .char-ability-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
  .char-ability-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
  .char-ability-cooldown-bar{width:100%;height:4px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin-top:4px;display:none}
  .char-ability-cooldown-fill{height:100%;background:rgba(255,255,255,.25);border-radius:2px;transition:width 1s linear}

  /* â”€â”€ Character: Tier â”€â”€ */
  .char-tier-upgrade{
    width:100%;margin-top:8px;padding-top:8px;
    border-top:1px solid rgba(255,255,255,.08);
    display:flex;align-items:center;gap:10px;
  }
  .char-tier-stars{display:flex;gap:4px;font-size:1.2rem}
  .char-star{transition:color .3s ease}
  .char-tier-btn{
    flex:1;padding:6px 12px;border:none;border-radius:6px;
    font-size:.76rem;font-weight:700;cursor:pointer;
    color:#fff;background:var(--char-tier-color,#7b9e6b);
    transition:transform .1s,opacity .15s;
  }
  .char-tier-btn:hover:not(:disabled){transform:translateY(-1px)}
  .char-tier-btn:disabled{opacity:.35;cursor:not-allowed;transform:none}
  .char-tier-btn.maxed{background:#ffd700;color:#4a3f35;opacity:.8}

  /* â”€â”€ Buff Indicators â”€â”€ */
  .buff-indicators{display:flex;gap:4px;flex-wrap:wrap}
  .buff-pill{
    display:flex;align-items:center;gap:3px;
    padding:3px 8px;border-radius:6px;
    background:rgba(123,158,107,.2);border:1px solid rgba(123,158,107,.3);
    font-size:.68rem;font-weight:600;color:var(--accent);
    animation:buff-pulse 2s ease-in-out infinite;
  }
  @keyframes buff-pulse{0%,100%{opacity:.8}50%{opacity:1}}

  /* â”€â”€ Pasture: Farmer â”€â”€ */
  .scene-farmer{
    position:absolute;font-size:1.1rem;
    filter:drop-shadow(0 2px 3px rgba(0,0,0,.15));
    transition:left 2s ease-in-out,top 2s ease-in-out,transform .3s ease;
  }

  /* â”€â”€ Mill: Piles + Dye Vat â”€â”€ */
  .mill-piles{display:flex;align-items:flex-end;justify-content:space-between;width:80%;gap:8px}
  .mill-pile{display:flex;flex-direction:column;align-items:center;font-size:.85rem;gap:1px;min-width:30px}
  .mill-pile-label{font-size:.6rem;color:var(--text-dim);opacity:.7}
  .mill-pile-items{display:flex;flex-wrap:wrap;gap:1px;justify-content:center}
  .dye-vat{font-size:1.4rem;animation:bubble 2s ease-in-out infinite;opacity:0;transition:opacity .5s}
  .dye-vat.active{opacity:1}
  @keyframes bubble{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-3px) scale(1.05)}}

  /* â”€â”€ Studio: Yarn Ball + FO Gallery â”€â”€ */
  .yarn-supply{
    font-size:1.8rem;transition:transform .5s ease;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.1));
  }
  .fo-gallery{
    display:flex;gap:3px;justify-content:center;flex-wrap:wrap;
    max-width:90%;font-size:.85rem;opacity:.65;
  }
  .fo-gallery-item{display:flex;align-items:center;gap:1px}
  .fo-gallery-count{font-size:.55rem;color:var(--text-dim)}

  /* â”€â”€ World Map â”€â”€ */
  .country-bar{
    position:relative;
    height:140px;
    background:linear-gradient(180deg,#d4e6f1 0%,#dce8d4 60%,#c8d8b8 100%);
    border-bottom:1px solid var(--border);
    overflow:visible;
  }
  .map-svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .map-svg .continent{fill:rgba(139,125,96,.12);stroke:rgba(139,125,96,.2);stroke-width:.5}
  .map-svg .ocean-line{fill:none;stroke:rgba(255,255,255,.15);stroke-width:.3}
  .map-pin{
    position:absolute;transform:translate(-50%,-100%);
    display:flex;flex-direction:column;align-items:center;
    cursor:pointer;transition:transform .2s,filter .2s;
    z-index:2;
  }
  .map-pin:hover{transform:translate(-50%,-100%) scale(1.15)}
  .map-pin .pin-marker{
    width:20px;height:26px;position:relative;
    filter:drop-shadow(0 2px 3px rgba(0,0,0,.2));
  }
  .map-pin .pin-marker svg{width:100%;height:100%}
  .map-pin .pin-flag{
    position:absolute;top:2px;left:50%;transform:translateX(-50%);
    font-size:.55rem;line-height:1;
  }
  .map-pin .pin-label{
    font-size:.6rem;font-weight:700;color:var(--text);
    background:rgba(255,255,255,.85);
    padding:1px 5px;border-radius:4px;margin-top:1px;
    white-space:nowrap;
    box-shadow:0 1px 3px rgba(0,0,0,.1);
  }
  .map-pin .pin-cost{
    font-size:.52rem;color:var(--text-dim);
    background:rgba(255,255,255,.7);
    padding:0 4px;border-radius:3px;margin-top:1px;
  }
  .map-pin.locked .pin-marker{opacity:.35;filter:grayscale(1) drop-shadow(0 2px 3px rgba(0,0,0,.1))}
  .map-pin.locked .pin-label{opacity:.5}
  .map-pin.locked{cursor:default}
  .map-pin.affordable .pin-marker{opacity:.7;filter:grayscale(.3) drop-shadow(0 2px 3px rgba(0,0,0,.15))}
  .map-pin.affordable .pin-label{opacity:.8}
  .map-pin.affordable{cursor:pointer}
  .map-pin.affordable .pin-cost{color:#8a6040;font-weight:700}
  .map-pin.active .pin-marker{filter:drop-shadow(0 2px 6px rgba(123,158,107,.5))}
  .map-pin.active .pin-label{background:var(--accent);color:#fff}
  .map-pin.active .pin-flag{font-size:.65rem}
  @keyframes pin-bounce{
    0%,100%{transform:translate(-50%,-100%)}
    50%{transform:translate(-50%,-108%)}
  }
  .map-pin.active{animation:pin-bounce 2s ease-in-out infinite}
  .map-pin.active:hover{animation:none;transform:translate(-50%,-100%) scale(1.15)}
  .map-yarn-trail{
    position:absolute;pointer-events:none;z-index:1;
    inset:0;width:100%;height:100%;
  }
  .map-yarn-trail line{stroke:var(--accent);stroke-width:1;stroke-dasharray:4 3;opacity:.3}
  .grid.with-country-bar{height:calc(100vh - 232px)}

  /* â”€â”€ Custom SVG icon integration â”€â”€ */
  .u-emoji svg,.icon svg,.emoji svg{display:inline-block;vertical-align:middle}
  .scene-animal svg{display:block}
  .scene-animal{line-height:0}
  .completion-emoji svg{display:block}
  .char-emoji svg{display:block;width:5rem;height:5rem;margin:0 auto}
  .fo-item svg,.fo-gallery-item svg{display:inline-block;vertical-align:middle}
  .dye-vat svg{display:block;margin:0 auto}
  .register svg{display:inline-block;vertical-align:middle}
  .yarn-supply svg{display:block}
  .mill-pile-items svg{display:inline-block}

  @keyframes svg-wool-bounce{0%,100%{transform:scaleY(1)}50%{transform:scaleY(1.08) scaleX(.95)}}
  @keyframes svg-spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  @keyframes svg-wobble{0%,100%{transform:rotate(-2deg)}50%{transform:rotate(2deg)}}
  @keyframes svg-snip{0%,70%,100%{transform:rotate(0deg)}80%{transform:rotate(-8deg)}90%{transform:rotate(5deg)}}
  @keyframes svg-flutter{0%,100%{transform:scaleX(1) rotate(0deg)}25%{transform:scaleX(.7) rotate(5deg)}50%{transform:scaleX(1) rotate(0deg)}75%{transform:scaleX(.7) rotate(-5deg)}}
  @keyframes svg-wag{0%,100%{transform:rotate(0deg)}25%{transform:rotate(15deg)}75%{transform:rotate(-15deg)}}
  @keyframes svg-bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
  @keyframes svg-ear{0%,85%,100%{transform:rotate(0deg)}90%{transform:rotate(-12deg)}95%{transform:rotate(5deg)}}
  @keyframes svg-chew{0%,80%,100%{transform:scaleY(1)}85%{transform:scaleY(.9)}90%{transform:scaleY(1.05)}}

  .svg-wool{animation:svg-wool-bounce 2s ease-in-out infinite;transform-origin:center bottom}
  .svg-spin{animation:svg-spin 4s linear infinite;transform-origin:center center}
  .svg-wobble{animation:svg-wobble 1.5s ease-in-out infinite;transform-origin:center center}
  .svg-snip{animation:svg-snip 3s ease-in-out infinite;transform-origin:center center}
  .svg-flutter{animation:svg-flutter .8s ease-in-out infinite;transform-origin:center center}
  .svg-wag{animation:svg-wag .6s ease-in-out infinite;transform-origin:center center}
  .svg-bob{animation:svg-bob 2s ease-in-out infinite}
  .svg-ear{animation:svg-ear 3s ease-in-out infinite}
  .svg-chew{animation:svg-chew 2.5s ease-in-out infinite;transform-origin:center bottom}
  .svg-spin-fast{animation:svg-spin 1.5s linear infinite;transform-origin:center center}
  .svg-spin-rev{animation:svg-spin 1s linear infinite reverse;transform-origin:center center}
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€ -->
<header class="header">
  <h1>Fleece to Fashion <span>| Idle Knitting</span></h1>
  <div class="resources">
    <div class="res"><span class="icon"><svg width="16" height="16" viewBox="0 0 64 64"><g class="svg-bob"><ellipse cx="32" cy="36" rx="20" ry="22" fill="#e8c84a" stroke="#b8962a" stroke-width="2.5"/><ellipse cx="32" cy="34" rx="20" ry="22" fill="#f0d860" stroke="#c8a830" stroke-width="2"/><text x="32" y="40" text-anchor="middle" font-family="serif" font-weight="bold" font-size="22" fill="#b8962a">$</text></g></svg></span><span class="val" id="res-cash">$50</span></div>
    <div class="res"><span class="icon"><svg width="16" height="16" viewBox="0 0 64 64"><g class="svg-wobble"><path d="M32,58 Q30,40 32,20" fill="none" stroke="#6a8a55" stroke-width="2" stroke-linecap="round"/><path d="M32,42 Q20,34 18,24 Q28,28 32,36" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><path d="M32,34 Q44,26 46,16 Q36,20 32,28" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><path d="M32,26 Q22,18 22,8 Q30,14 32,20" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/></g></svg></span><span>Fiber</span><span class="val" id="res-fiber">0</span></div>
    <div class="res"><span class="icon"><svg width="16" height="16" viewBox="0 0 64 64"><circle cx="30" cy="34" r="20" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,28 Q30,16 48,28" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M12,40 Q30,50 48,40" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/></svg></span><span>Skeins</span><span class="val" id="res-skeins">0</span></div>
    <div class="res"><span class="icon"><svg width="16" height="16" viewBox="0 0 64 64"><circle cx="30" cy="34" r="20" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,28 Q30,16 48,28" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M12,40 Q30,50 48,40" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/></svg></span><span>FOs</span><span class="val" id="res-fos">0</span></div>
    <div class="res" id="save-indicator" style="cursor:pointer;opacity:.6" onclick="saveGame(); showToast('Game saved!')" title="Click to save">
      <span class="icon">ðŸ’¾</span><span class="val" id="save-status">Auto</span>
    </div>
  </div>
  <div class="buff-indicators" id="buff-indicators"></div>
</header>

<!-- â”€â”€ Country Bar â”€â”€ -->
<nav class="country-bar" id="country-bar" style="display:none"></nav>

<!-- â”€â”€ Grid â”€â”€ -->
<main class="grid">

  <!-- Pasture -->
  <div class="flip-card pane-pasture" id="pane-pasture">
    <div class="flip-inner">
      <div class="flip-front">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><path d="M0,44 Q16,32 32,40 Q48,48 64,38 L64,64 L0,64 Z" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><g class="svg-wool"><ellipse cx="40" cy="38" rx="6" ry="4" fill="#f5f0e8" stroke="#6a8a55" stroke-width="1"/><circle cx="36" cy="36" r="2.5" fill="#f5f0e8" stroke="#6a8a55" stroke-width=".8"/><circle cx="40" cy="35" r="2.5" fill="#f5f0e8" stroke="#6a8a55" stroke-width=".8"/></g><ellipse cx="45" cy="37" rx="2" ry="2.5" fill="#4a3f35"/><circle cx="52" cy="12" r="4" fill="#f0d860"/></svg></span> The Pasture</h2>
          <button class="flip-btn" onclick="flip('pane-pasture')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 3v6h6"/></svg> View</button>
        </div>
        <div class="pane-body" id="pasture-body">
          <div class="rate-summary" id="rate-pasture">+0 fiber/s</div>
        </div>
      </div>
      <div class="flip-back">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><path d="M0,44 Q16,32 32,40 Q48,48 64,38 L64,64 L0,64 Z" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><g class="svg-wool"><ellipse cx="40" cy="38" rx="6" ry="4" fill="#f5f0e8" stroke="#6a8a55" stroke-width="1"/><circle cx="36" cy="36" r="2.5" fill="#f5f0e8" stroke="#6a8a55" stroke-width=".8"/><circle cx="40" cy="35" r="2.5" fill="#f5f0e8" stroke="#6a8a55" stroke-width=".8"/></g><ellipse cx="45" cy="37" rx="2" ry="2.5" fill="#4a3f35"/><circle cx="52" cy="12" r="4" fill="#f0d860"/></svg></span> The Pasture</h2>
          <button class="flip-btn" onclick="flip('pane-pasture')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 0-9 9"/><path d="M21 21v-6h-6"/></svg> Back</button>
        </div>
        <div class="back-visual" id="back-pasture">
          <div class="pasture-scene" id="pasture-scene">
            <div class="pasture-sky" id="pasture-sky"></div>
            <div class="weather-layer" id="weather-layer"></div>
            <div class="hill hill-far"></div>
            <div class="hill hill-mid"></div>
            <div class="hill hill-near"></div>
            <div class="pasture-animals-scene" id="pasture-animals"></div>
            <div class="pasture-info" id="pasture-info"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mill -->
  <div class="flip-card pane-mill" id="pane-mill">
    <div class="flip-inner">
      <div class="flip-front">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><rect x="8" y="24" width="48" height="32" rx="2" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><path d="M6,24 L32,10 L58,24 Z" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><rect x="44" y="6" width="8" height="18" fill="#b8864a"/><rect x="26" y="40" width="12" height="16" rx="6" fill="#b8864a" opacity=".3"/><rect x="14" y="32" width="8" height="8" rx="1" fill="#f5f0e8" stroke="#b8864a" stroke-width="1"/><rect x="42" y="32" width="8" height="8" rx="1" fill="#f5f0e8" stroke="#b8864a" stroke-width="1"/></svg></span> The Mill</h2>
          <button class="flip-btn" onclick="flip('pane-mill')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 3v6h6"/></svg> View</button>
        </div>
        <div class="pane-body" id="mill-body">
          <div class="rate-summary" id="rate-mill">Processing: 0 fiber â†’ 0 skeins/s</div>
        </div>
      </div>
      <div class="flip-back">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><rect x="8" y="24" width="48" height="32" rx="2" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><path d="M6,24 L32,10 L58,24 Z" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><rect x="44" y="6" width="8" height="18" fill="#b8864a"/><rect x="26" y="40" width="12" height="16" rx="6" fill="#b8864a" opacity=".3"/><rect x="14" y="32" width="8" height="8" rx="1" fill="#f5f0e8" stroke="#b8864a" stroke-width="1"/><rect x="42" y="32" width="8" height="8" rx="1" fill="#f5f0e8" stroke="#b8864a" stroke-width="1"/></svg></span> The Mill</h2>
          <button class="flip-btn" onclick="flip('pane-mill')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 0-9 9"/><path d="M21 21v-6h-6"/></svg> Back</button>
        </div>
        <div class="back-visual" id="back-mill">
          <div class="mill-scene" id="mill-scene">
            <div class="css-wheel" id="mill-wheel">
              <div class="wheel-rim"></div>
              <div class="wheel-hub"></div>
            </div>
            <div class="mill-piles">
              <div class="mill-pile"><div class="mill-pile-items" id="mill-fiber-pile"></div><div class="mill-pile-label">fiber</div></div>
              <div class="mill-pile"><div class="mill-pile-items" id="mill-skein-pile"></div><div class="mill-pile-label">skeins</div></div>
            </div>
            <div class="conveyor" id="mill-conveyor"></div>
            <div class="conveyor-label"><span><svg width="14" height="14" viewBox="0 0 64 64"><path d="M32,58 Q30,40 32,20" fill="none" stroke="#6a8a55" stroke-width="2" stroke-linecap="round"/><path d="M32,42 Q20,34 18,24 Q28,28 32,36" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><path d="M32,34 Q44,26 46,16 Q36,20 32,28" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><path d="M32,26 Q22,18 22,8 Q30,14 32,20" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/></svg> fiber</span><span><svg width="14" height="14" viewBox="0 0 64 64"><circle cx="30" cy="34" r="20" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,28 Q30,16 48,28" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M12,40 Q30,50 48,40" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/></svg> skeins</span></div>
            <div class="dye-vat" id="mill-dye-vat"><svg width="28" height="28" viewBox="0 0 64 64"><path d="M12,28 L12,48 Q12,54 18,54 L46,54 Q52,54 52,48 L52,28" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><ellipse cx="32" cy="28" rx="20" ry="5" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,34 Q6,34 6,40 Q6,46 12,46" fill="none" stroke="#9e6060" stroke-width="2" stroke-linecap="round"/><path d="M52,34 Q58,34 58,40 Q58,46 52,46" fill="none" stroke="#9e6060" stroke-width="2" stroke-linecap="round"/><path d="M22,28 Q26,24 30,28 Q34,32 38,28" fill="none" stroke="#9e6060" stroke-width="2" opacity=".5"/></svg></div>
            <div class="mill-rate-label" id="mill-rate-label">No equipment yet</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Yarn Shop -->
  <div class="flip-card pane-shop" id="pane-shop">
    <div class="flip-inner">
      <div class="flip-front">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><rect x="8" y="20" width="48" height="36" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M4,20 L60,20 L56,28 Q48,24 40,28 Q32,24 24,28 Q16,24 8,28 Z" fill="#9e6060" stroke="#9e6060" stroke-width="1.5"/><rect x="14" y="32" width="16" height="14" rx="1" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/><circle cx="20" cy="40" r="3" fill="#e4ecda"/><circle cx="26" cy="40" r="3" fill="#c4b7d4"/><rect x="36" y="32" width="14" height="24" rx="2" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/></svg></span> The Yarn Shop</h2>
          <button class="flip-btn" onclick="flip('pane-shop')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 3v6h6"/></svg> View</button>
        </div>
        <div class="pane-body" id="shop-body">
          <div class="rate-summary" id="rate-shop">Selling: 0 skeins/s â€” $0/s</div>
        </div>
      </div>
      <div class="flip-back">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><rect x="8" y="20" width="48" height="36" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M4,20 L60,20 L56,28 Q48,24 40,28 Q32,24 24,28 Q16,24 8,28 Z" fill="#9e6060" stroke="#9e6060" stroke-width="1.5"/><rect x="14" y="32" width="16" height="14" rx="1" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/><circle cx="20" cy="40" r="3" fill="#e4ecda"/><circle cx="26" cy="40" r="3" fill="#c4b7d4"/><rect x="36" y="32" width="14" height="24" rx="2" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/></svg></span> The Yarn District</h2>
          <button class="flip-btn" onclick="flip('pane-shop')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 0-9 9"/><path d="M21 21v-6h-6"/></svg> Back</button>
        </div>
        <div class="back-visual" id="back-shop">
          <div class="city-scene" id="city-scene">
            <div class="city-ground"></div>
            <svg class="city-roads" viewBox="0 0 200 100" preserveAspectRatio="none">
              <path class="city-road-path" d="M5,75 Q25,65 45,60 Q65,55 85,50 Q105,55 125,45 Q145,35 165,30 Q185,20 195,22"/>
              <path class="city-road-path" d="M10,85 Q30,80 50,70 Q70,65 90,68 Q110,70 130,60 Q150,50 170,55 Q190,60 195,58"/>
            </svg>
            <div class="city-buildings" id="city-buildings"></div>
            <div class="city-ambient" id="city-ambient"></div>
            <div class="city-info" id="city-info">Your yarn district awaits...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Studio -->
  <div class="flip-card pane-studio" id="pane-studio">
    <div class="flip-inner">
      <div class="flip-front">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><g class="svg-snip"><circle cx="12" cy="16" r="7" fill="none" stroke="#7a6690" stroke-width="2"/><line x1="17" y1="20" x2="50" y2="30" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/></g><g class="svg-snip" style="animation-direction:reverse"><circle cx="12" cy="48" r="7" fill="none" stroke="#7a6690" stroke-width="2"/><line x1="17" y1="44" x2="50" y2="34" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/></g><circle cx="40" cy="32" r="3" fill="#7a6690"/><circle cx="40" cy="32" r="1.5" fill="white"/></svg></span> The Studio</h2>
          <button class="flip-btn" onclick="flip('pane-studio')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9"/><path d="M3 3v6h6"/></svg> View</button>
        </div>
        <div class="pane-body" id="studio-body">
          <div class="rate-summary" id="rate-studio">No project in progress</div>
        </div>
      </div>
      <div class="flip-back">
        <div class="pane-header">
          <h2><span class="emoji"><svg width="18" height="18" viewBox="0 0 64 64"><g class="svg-snip"><circle cx="12" cy="16" r="7" fill="none" stroke="#7a6690" stroke-width="2"/><line x1="17" y1="20" x2="50" y2="30" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/></g><g class="svg-snip" style="animation-direction:reverse"><circle cx="12" cy="48" r="7" fill="none" stroke="#7a6690" stroke-width="2"/><line x1="17" y1="44" x2="50" y2="34" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/></g><circle cx="40" cy="32" r="3" fill="#7a6690"/><circle cx="40" cy="32" r="1.5" fill="white"/></svg></span> The Studio</h2>
          <button class="flip-btn" onclick="flip('pane-studio')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 0-9 9"/><path d="M21 21v-6h-6"/></svg> Back</button>
        </div>
        <div class="back-visual" id="back-studio">
          <div class="studio-scene" id="studio-scene">
            <div class="yarn-supply" id="studio-yarn-ball"><svg width="28" height="28" viewBox="0 0 64 64"><g class="svg-wobble"><circle cx="30" cy="34" r="20" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,28 Q30,16 48,28" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M12,40 Q30,50 48,40" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M18,16 Q28,34 18,52" fill="none" stroke="#9e6060" stroke-width="1.2" opacity=".35"/><path d="M42,16 Q32,34 42,52" fill="none" stroke="#9e6060" stroke-width="1.2" opacity=".35"/></g></svg></div>
            <div class="needles-wrap">
              <div class="needle needle-l"></div>
              <div class="needle needle-r"></div>
              <div class="fabric-strip" id="studio-fabric" style="height:0px"></div>
            </div>
            <div class="studio-project-label" id="studio-back-label">Waiting for a project...</div>
            <div class="studio-fo-count" id="studio-fo-count"></div>
            <div class="fo-gallery" id="studio-fo-gallery"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- â”€â”€ Animal Character Screen â”€â”€ -->
<div class="shop-overlay" id="shop-overlay">
  <div class="shop-detail" id="shop-detail">
    <button class="shop-detail-close" id="shop-detail-close">&times;</button>
    <div class="shop-detail-header" id="shop-detail-header"></div>
    <div class="shop-detail-scene" id="shop-detail-scene"></div>
    <div class="shop-detail-sections" id="shop-detail-sections"></div>
  </div>
</div>

<div class="char-overlay" id="char-overlay">
  <div class="char-modal" id="char-modal">
    <button class="char-close" id="char-close" aria-label="Close">&times;</button>
    <div class="char-tier" id="char-tier">Common</div>
    <div class="char-stage" id="char-stage">
      <div class="char-platform" id="char-platform">
        <div class="char-platform-ring"></div>
        <div class="char-platform-ring char-platform-ring-inner"></div>
      </div>
      <div class="char-animal" id="char-animal">
        <span class="char-emoji" id="char-emoji"></span>
      </div>
      <div class="char-glow" id="char-glow"></div>
      <div class="char-particles" id="char-particles"></div>
    </div>
    <div class="char-info" id="char-info">
      <div class="char-name" id="char-name"></div>
      <div class="char-breed" id="char-breed"></div>
      <div class="char-tagline" id="char-tagline"></div>
      <div class="char-stats" id="char-stats">
        <div class="char-stat">
          <span class="char-stat-label">Fiber/s</span>
          <div class="char-stat-bar"><div class="char-stat-fill" id="char-stat-fiber"></div></div>
          <span class="char-stat-val" id="char-fiber-val">0</span>
        </div>
        <div class="char-stat">
          <span class="char-stat-label">Owned</span>
          <span class="char-stat-val char-stat-count" id="char-owned-val">0</span>
        </div>
        <div class="char-stat">
          <span class="char-stat-label">Origin</span>
          <span class="char-stat-val" id="char-origin-val">Home Farm</span>
        </div>
      </div>
      <div class="char-flavor" id="char-flavor"></div>
      <div class="char-passives" id="char-passives"></div>
      <div class="char-ability-wrap" id="char-ability-wrap" style="display:none">
        <div class="char-ability-name" id="char-ability-name"></div>
        <div class="char-ability-desc" id="char-ability-desc"></div>
        <button class="char-ability-btn" id="char-ability-btn"><span id="char-ability-btn-text">Activate</span></button>
        <div class="char-ability-cooldown-bar" id="char-ability-cd-bar"><div class="char-ability-cooldown-fill" id="char-ability-cd-fill"></div></div>
      </div>
      <div class="char-tier-upgrade" id="char-tier-upgrade" style="display:none">
        <div class="char-tier-stars" id="char-tier-stars"></div>
        <button class="char-tier-btn" id="char-tier-btn">Upgrade</button>
      </div>
    </div>
    <div class="char-drag-hint" id="char-drag-hint">&#x21c4; Drag to spin</div>
  </div>
</div>

<!-- â”€â”€ Milestone Toast â”€â”€ -->
<div class="toast" id="toast"></div>

<!-- â”€â”€ Ticker Tape â”€â”€ -->
<div class="ticker" id="ticker">Just one more row...</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOM SVG ICONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SVG_ICONS = {
  // â”€â”€ Resources â”€â”€
  cash: '<svg viewBox="0 0 64 64"><g class="svg-bob"><ellipse cx="32" cy="36" rx="20" ry="22" fill="#e8c84a" stroke="#b8962a" stroke-width="2.5"/><ellipse cx="32" cy="34" rx="20" ry="22" fill="#f0d860" stroke="#c8a830" stroke-width="2"/><ellipse cx="32" cy="34" rx="14" ry="16" fill="none" stroke="#c8a830" stroke-width="1.5" opacity=".5"/><text x="32" y="40" text-anchor="middle" font-family="serif" font-weight="bold" font-size="22" fill="#b8962a">$</text></g></svg>',

  fiber: '<svg viewBox="0 0 64 64"><g class="svg-wobble"><path d="M32,58 Q30,40 32,20" fill="none" stroke="#6a8a55" stroke-width="2" stroke-linecap="round"/><path d="M32,42 Q20,34 18,24 Q28,28 32,36" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><path d="M32,34 Q44,26 46,16 Q36,20 32,28" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><path d="M32,26 Q22,18 22,8 Q30,14 32,20" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/></g></svg>',

  skeins: '<svg viewBox="0 0 64 64"><g class="svg-wobble"><circle cx="30" cy="34" r="20" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,28 Q30,16 48,28" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M12,40 Q30,50 48,40" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M18,16 Q28,34 18,52" fill="none" stroke="#9e6060" stroke-width="1.2" opacity=".35"/><path d="M42,16 Q32,34 42,52" fill="none" stroke="#9e6060" stroke-width="1.2" opacity=".35"/></g><line x1="40" y1="18" x2="56" y2="4" stroke="#7a6690" stroke-width="2" stroke-linecap="round"/><circle cx="57" cy="3" r="2" fill="#7a6690"/><line x1="44" y1="22" x2="60" y2="8" stroke="#7a6690" stroke-width="2" stroke-linecap="round"/><circle cx="61" cy="7" r="2" fill="#7a6690"/></svg>',

  // â”€â”€ Pasture Animals â”€â”€
  merino: '<svg viewBox="0 0 64 64"><g class="svg-wool"><ellipse cx="28" cy="30" rx="16" ry="12" fill="#f5f0e8" stroke="#6a8a55" stroke-width="2"/><circle cx="18" cy="23" r="6" fill="#f5f0e8" stroke="#6a8a55" stroke-width="1.5"/><circle cx="28" cy="21" r="6" fill="#f5f0e8" stroke="#6a8a55" stroke-width="1.5"/><circle cx="37" cy="24" r="5" fill="#f5f0e8" stroke="#6a8a55" stroke-width="1.5"/></g><ellipse cx="47" cy="28" rx="5" ry="6" fill="#4a3f35"/><circle cx="49" cy="26" r="1.5" fill="white"/><line x1="20" y1="40" x2="20" y2="52" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/><line x1="28" y1="41" x2="28" y2="52" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/><line x1="34" y1="41" x2="34" y2="52" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/><line x1="40" y1="40" x2="40" y2="52" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/></svg>',

  alpaca: '<svg viewBox="0 0 64 64"><g class="svg-wool"><ellipse cx="32" cy="38" rx="14" ry="10" fill="#f5e6d0" stroke="#b8864a" stroke-width="1.5"/><circle cx="24" cy="34" r="5" fill="#f5e6d0" stroke="#b8864a" stroke-width="1.2"/><circle cx="32" cy="32" r="5" fill="#f5e6d0" stroke="#b8864a" stroke-width="1.2"/><circle cx="40" cy="34" r="5" fill="#f5e6d0" stroke="#b8864a" stroke-width="1.2"/></g><path d="M42,36 Q44,24 42,12" fill="none" stroke="#b8864a" stroke-width="5" stroke-linecap="round"/><path d="M42,36 Q44,24 42,12" fill="none" stroke="#f5e6d0" stroke-width="3" stroke-linecap="round"/><ellipse cx="42" cy="10" rx="5" ry="6" fill="#f5e6d0" stroke="#b8864a" stroke-width="1.5"/><circle cx="44" cy="9" r="1.2" fill="#4a3f35"/><line x1="39" y1="6" x2="37" y2="1" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="44" y1="5" x2="46" y2="1" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><circle cx="41" cy="5" r="3" fill="#f5e6d0" stroke="#b8864a" stroke-width="1"/><line x1="24" y1="46" x2="24" y2="58" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="32" y1="47" x2="32" y2="58" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="38" y1="47" x2="38" y2="58" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="42" y1="46" x2="42" y2="58" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/></svg>',

  rabbit: '<svg viewBox="0 0 64 64"><g class="svg-wool"><ellipse cx="30" cy="38" rx="16" ry="12" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.5"/><circle cx="22" cy="34" r="5" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.2"/><circle cx="30" cy="32" r="5" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.2"/><circle cx="38" cy="34" r="5" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.2"/></g><circle cx="46" cy="30" r="8" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.5"/><circle cx="49" cy="29" r="2" fill="#c44a7a"/><ellipse cx="53" cy="31" rx="1.5" ry="1" fill="#e08aaa"/><g class="svg-ear" style="transform-origin:44px 22px"><ellipse cx="42" cy="14" rx="3" ry="10" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.5"/><ellipse cx="42" cy="14" rx="1.5" ry="7" fill="#e8c0d4"/></g><g class="svg-ear" style="transform-origin:49px 22px;animation-delay:.3s"><ellipse cx="49" cy="14" rx="3" ry="10" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.5"/><ellipse cx="49" cy="14" rx="1.5" ry="7" fill="#e8c0d4"/></g><circle cx="14" cy="38" r="4" fill="#f5e8f0" stroke="#c48aaa" stroke-width="1.2"/><line x1="22" y1="48" x2="22" y2="56" stroke="#c48aaa" stroke-width="2.5" stroke-linecap="round"/><line x1="38" y1="48" x2="38" y2="56" stroke="#c48aaa" stroke-width="2.5" stroke-linecap="round"/></svg>',

  goat: '<svg viewBox="0 0 64 64"><g class="svg-chew"><ellipse cx="30" cy="34" rx="16" ry="11" fill="#e8dce8" stroke="#7a6690" stroke-width="1.5"/></g><path d="M42,32 Q46,24 44,16" fill="none" stroke="#7a6690" stroke-width="4" stroke-linecap="round"/><path d="M42,32 Q46,24 44,16" fill="none" stroke="#e8dce8" stroke-width="2.5" stroke-linecap="round"/><ellipse cx="44" cy="14" rx="6" ry="7" fill="#e8dce8" stroke="#7a6690" stroke-width="1.5"/><path d="M40,10 Q36,2 38,0" fill="none" stroke="#4a3f35" stroke-width="2" stroke-linecap="round"/><path d="M47,9 Q52,2 50,0" fill="none" stroke="#4a3f35" stroke-width="2" stroke-linecap="round"/><circle cx="47" cy="13" r="1.5" fill="#4a3f35"/><path d="M46,18 Q48,24 46,28" fill="none" stroke="#7a6690" stroke-width="1.5" stroke-linecap="round"/><line x1="20" y1="43" x2="20" y2="56" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/><line x1="28" y1="44" x2="28" y2="56" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/><line x1="34" y1="44" x2="34" y2="56" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/><line x1="40" y1="43" x2="40" y2="56" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/></svg>',

  blackface: '<svg viewBox="0 0 64 64"><g class="svg-wool"><ellipse cx="28" cy="32" rx="16" ry="12" fill="#e0dce0" stroke="#7a7080" stroke-width="1.5"/><circle cx="18" cy="26" r="5" fill="#e0dce0" stroke="#7a7080" stroke-width="1.2"/><circle cx="28" cy="24" r="6" fill="#e0dce0" stroke="#7a7080" stroke-width="1.2"/><circle cx="36" cy="26" r="5" fill="#e0dce0" stroke="#7a7080" stroke-width="1.2"/></g><ellipse cx="46" cy="28" rx="6" ry="7" fill="#4a3f35"/><circle cx="49" cy="26" r="1.5" fill="white"/><path d="M42,22 Q36,14 40,8 Q46,6 48,12" fill="none" stroke="#8a7e72" stroke-width="2.5" stroke-linecap="round"/><path d="M50,22 Q56,14 52,8 Q46,6 44,12" fill="none" stroke="#8a7e72" stroke-width="2.5" stroke-linecap="round"/><line x1="18" y1="42" x2="18" y2="54" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/><line x1="26" y1="43" x2="26" y2="54" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/><line x1="34" y1="43" x2="34" y2="54" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/><line x1="40" y1="42" x2="40" y2="54" stroke="#4a3f35" stroke-width="2.5" stroke-linecap="round"/></svg>',

  silkmoth: '<svg viewBox="0 0 64 64"><ellipse cx="32" cy="34" rx="3" ry="10" fill="#f0e8d8" stroke="#b8864a" stroke-width="1.5"/><g class="svg-flutter" style="transform-origin:32px 30px"><path d="M29,28 Q14,18 12,28 Q14,38 29,36" fill="#f8f0e0" stroke="#b8864a" stroke-width="1.5"/><path d="M29,34 Q18,38 16,44 Q22,42 29,38" fill="#f8f0e0" stroke="#b8864a" stroke-width="1.2"/></g><g class="svg-flutter" style="transform-origin:32px 30px;animation-direction:reverse"><path d="M35,28 Q50,18 52,28 Q50,38 35,36" fill="#f8f0e0" stroke="#b8864a" stroke-width="1.5"/><path d="M35,34 Q46,38 48,44 Q42,42 35,38" fill="#f8f0e0" stroke="#b8864a" stroke-width="1.2"/></g><circle cx="32" cy="22" r="4" fill="#f0e8d8" stroke="#b8864a" stroke-width="1.5"/><circle cx="30" cy="21" r="1" fill="#4a3f35"/><circle cx="34" cy="21" r="1" fill="#4a3f35"/><path d="M30,19 Q26,10 22,8" fill="none" stroke="#b8864a" stroke-width="1.2" stroke-linecap="round"/><path d="M34,19 Q38,10 42,8" fill="none" stroke="#b8864a" stroke-width="1.2" stroke-linecap="round"/><circle cx="22" cy="8" r="1.5" fill="#b8864a"/><circle cx="42" cy="8" r="1.5" fill="#b8864a"/></svg>',

  akitainu: '<svg viewBox="0 0 64 64"><ellipse cx="30" cy="34" rx="16" ry="10" fill="#e8c8a0" stroke="#a08050" stroke-width="1.5"/><ellipse cx="48" cy="24" rx="8" ry="9" fill="#e8c8a0" stroke="#a08050" stroke-width="1.5"/><ellipse cx="54" cy="27" rx="4" ry="3" fill="#f0d8b8" stroke="#a08050" stroke-width="1.2"/><circle cx="55" cy="26" r="1.5" fill="#4a3f35"/><circle cx="50" cy="22" r="2" fill="#4a3f35"/><polygon points="42,18 38,6 44,14" fill="#e8c8a0" stroke="#a08050" stroke-width="1.5" stroke-linejoin="round"/><polygon points="50,16 52,4 54,14" fill="#e8c8a0" stroke="#a08050" stroke-width="1.5" stroke-linejoin="round"/><g class="svg-wag" style="transform-origin:14px 30px"><path d="M14,32 Q8,22 12,16 Q16,14 16,20" fill="none" stroke="#a08050" stroke-width="2" stroke-linecap="round"/></g><line x1="20" y1="42" x2="20" y2="54" stroke="#a08050" stroke-width="2.5" stroke-linecap="round"/><line x1="28" y1="43" x2="28" y2="54" stroke="#a08050" stroke-width="2.5" stroke-linecap="round"/><line x1="36" y1="43" x2="36" y2="54" stroke="#a08050" stroke-width="2.5" stroke-linecap="round"/><line x1="42" y1="42" x2="42" y2="54" stroke="#a08050" stroke-width="2.5" stroke-linecap="round"/></svg>',

  wombat: '<svg viewBox="0 0 64 64"><g class="svg-wool"><ellipse cx="32" cy="36" rx="18" ry="14" fill="#8a7e60" stroke="#5a5040" stroke-width="1.5"/></g><ellipse cx="48" cy="30" rx="10" ry="9" fill="#8a7e60" stroke="#5a5040" stroke-width="1.5"/><ellipse cx="52" cy="32" rx="5" ry="4" fill="#a09070"/><ellipse cx="56" cy="30" rx="2.5" ry="2" fill="#5a5040"/><circle cx="52" cy="27" r="2" fill="#4a3f35"/><circle cx="44" cy="22" r="3" fill="#8a7e60" stroke="#5a5040" stroke-width="1.2"/><circle cx="50" cy="21" r="3" fill="#8a7e60" stroke="#5a5040" stroke-width="1.2"/><ellipse cx="20" cy="50" rx="4" ry="3" fill="#8a7e60" stroke="#5a5040" stroke-width="1.2"/><ellipse cx="30" cy="50" rx="4" ry="3" fill="#8a7e60" stroke="#5a5040" stroke-width="1.2"/><ellipse cx="38" cy="50" rx="4" ry="3" fill="#8a7e60" stroke="#5a5040" stroke-width="1.2"/><ellipse cx="46" cy="48" rx="4" ry="3" fill="#8a7e60" stroke="#5a5040" stroke-width="1.2"/></svg>',

  // â”€â”€ Aliases for sheep/alpaca variants â”€â”€
  get shetland() { return this.merino; },
  get icelandic() { return this.merino; },
  get supermerino() { return this.merino; },
  get leadersheep() { return this.blackface; },
  get huacaya() { return this.alpaca; },

  vicuna: '<svg viewBox="0 0 64 64"><g class="svg-wool"><ellipse cx="30" cy="36" rx="14" ry="8" fill="#d4a060" stroke="#a07030" stroke-width="1.5"/></g><path d="M42,34 Q46,24 44,14" fill="none" stroke="#a07030" stroke-width="3.5" stroke-linecap="round"/><path d="M42,34 Q46,24 44,14" fill="none" stroke="#d4a060" stroke-width="2" stroke-linecap="round"/><ellipse cx="44" cy="12" rx="5" ry="6" fill="#d4a060" stroke="#a07030" stroke-width="1.5"/><circle cx="46" cy="11" r="1.2" fill="#4a3f35"/><ellipse cx="42" cy="6" rx="2.5" ry="4" fill="#d4a060" stroke="#a07030" stroke-width="1"/><ellipse cx="48" cy="6" rx="2.5" ry="4" fill="#d4a060" stroke="#a07030" stroke-width="1"/><line x1="20" y1="42" x2="20" y2="56" stroke="#a07030" stroke-width="2" stroke-linecap="round"/><line x1="28" y1="43" x2="28" y2="56" stroke="#a07030" stroke-width="2" stroke-linecap="round"/><line x1="36" y1="43" x2="36" y2="56" stroke="#a07030" stroke-width="2" stroke-linecap="round"/><line x1="42" y1="42" x2="42" y2="56" stroke="#a07030" stroke-width="2" stroke-linecap="round"/></svg>',

  // â”€â”€ Mill Equipment â”€â”€
  spindle: '<svg viewBox="0 0 64 64"><g class="svg-spin" style="transform-origin:32px 32px;animation-duration:3s"><ellipse cx="32" cy="32" rx="14" ry="4" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/></g><line x1="32" y1="6" x2="32" y2="58" stroke="#b8864a" stroke-width="2.5" stroke-linecap="round"/><path d="M32,6 Q36,4 34,8" fill="none" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/><path d="M32,20 Q38,22 34,26 Q28,28 32,30" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".6"/></svg>',

  wheel: '<svg viewBox="0 0 64 64"><line x1="14" y1="50" x2="14" y2="58" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="42" y1="50" x2="42" y2="58" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="8" y1="58" x2="48" y2="58" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/><g class="svg-spin" style="transform-origin:28px 28px"><circle cx="28" cy="28" r="20" fill="none" stroke="#b8864a" stroke-width="2.5"/><circle cx="28" cy="28" r="3.5" fill="#b8864a"/><line x1="28" y1="8" x2="28" y2="48" stroke="#b8864a" stroke-width="1.5"/><line x1="8" y1="28" x2="48" y2="28" stroke="#b8864a" stroke-width="1.5"/><line x1="14" y1="14" x2="42" y2="42" stroke="#b8864a" stroke-width="1.2"/><line x1="42" y1="14" x2="14" y2="42" stroke="#b8864a" stroke-width="1.2"/></g><rect x="50" y="22" width="6" height="12" rx="2" fill="none" stroke="#b8864a" stroke-width="1.5"/></svg>',

  electric: '<svg viewBox="0 0 64 64"><rect x="10" y="20" width="44" height="28" rx="4" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><g class="svg-spin-fast" style="transform-origin:24px 34px"><circle cx="24" cy="34" r="8" fill="none" stroke="#b8864a" stroke-width="2"/><line x1="24" y1="26" x2="24" y2="28" stroke="#b8864a" stroke-width="1.5"/><line x1="24" y1="40" x2="24" y2="42" stroke="#b8864a" stroke-width="1.5"/><line x1="16" y1="34" x2="18" y2="34" stroke="#b8864a" stroke-width="1.5"/><line x1="30" y1="34" x2="32" y2="34" stroke="#b8864a" stroke-width="1.5"/></g><g class="svg-spin-rev" style="transform-origin:42px 34px"><circle cx="42" cy="34" r="6" fill="none" stroke="#b8864a" stroke-width="2"/><line x1="42" y1="28" x2="42" y2="30" stroke="#b8864a" stroke-width="1.5"/><line x1="42" y1="38" x2="42" y2="40" stroke="#b8864a" stroke-width="1.5"/><line x1="36" y1="34" x2="38" y2="34" stroke="#b8864a" stroke-width="1.5"/><line x1="46" y1="34" x2="48" y2="34" stroke="#b8864a" stroke-width="1.5"/></g><path d="M30,8 L26,18 L32,16 L28,24" fill="none" stroke="#e8a830" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',

  kettle: '<svg viewBox="0 0 64 64"><path d="M12,28 L12,48 Q12,54 18,54 L46,54 Q52,54 52,48 L52,28" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><ellipse cx="32" cy="28" rx="20" ry="5" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,34 Q6,34 6,40 Q6,46 12,46" fill="none" stroke="#9e6060" stroke-width="2" stroke-linecap="round"/><path d="M52,34 Q58,34 58,40 Q58,46 52,46" fill="none" stroke="#9e6060" stroke-width="2" stroke-linecap="round"/><path d="M22,28 Q26,24 30,28 Q34,32 38,28" fill="none" stroke="#9e6060" stroke-width="2" opacity=".5"/></svg>',

  speckle: '<svg viewBox="0 0 64 64"><path d="M10,32 Q10,12 32,12 Q54,12 54,32 Q54,52 32,52 Q10,52 10,32 Z" fill="#f5e8d8" stroke="#b8864a" stroke-width="2"/><circle cx="40" cy="40" r="6" fill="#f5f0e8" stroke="#b8864a" stroke-width="1.5"/><circle cx="20" cy="22" r="5" fill="#d4a5a5"/><circle cx="34" cy="18" r="4" fill="#6a8a55"/><circle cx="46" cy="24" r="4" fill="#c4b7d4"/><circle cx="18" cy="36" r="4" fill="#b8864a"/><circle cx="30" cy="42" r="3.5" fill="#7badd4"/></svg>',

  // â”€â”€ Shop â”€â”€
  swift: '<svg viewBox="0 0 64 64"><line x1="32" y1="58" x2="32" y2="30" stroke="#b8864a" stroke-width="2.5" stroke-linecap="round"/><g class="svg-spin" style="transform-origin:32px 24px;animation-duration:3s"><line x1="14" y1="24" x2="50" y2="24" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="22" y1="14" x2="42" y2="34" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><line x1="22" y1="34" x2="42" y2="14" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><circle cx="32" cy="24" r="18" fill="none" stroke="#d4a5a5" stroke-width="3" opacity=".4"/></g><ellipse cx="32" cy="58" rx="10" ry="3" fill="none" stroke="#b8864a" stroke-width="1.5"/></svg>',

  knitnight: '<svg viewBox="0 0 64 64"><path d="M40,8 Q16,8 16,32 Q16,56 40,56 Q26,50 26,32 Q26,14 40,8 Z" fill="#f0d860" stroke="#c8a830" stroke-width="2"/><circle cx="48" cy="14" r="1.5" fill="#f0d860"/><circle cx="54" cy="28" r="1" fill="#f0d860"/><circle cx="50" cy="44" r="1.2" fill="#f0d860"/><line x1="42" y1="50" x2="54" y2="38" stroke="#7a6690" stroke-width="1.5" stroke-linecap="round"/><line x1="46" y1="52" x2="58" y2="40" stroke="#7a6690" stroke-width="1.5" stroke-linecap="round"/></svg>',

  fibermerchant: '<svg viewBox="0 0 64 64"><path d="M10,28 L6,50 Q6,56 14,56 L50,56 Q58,56 58,50 L54,28" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><line x1="20" y1="28" x2="16" y2="56" stroke="#b8864a" stroke-width="1" opacity=".3"/><line x1="32" y1="28" x2="32" y2="56" stroke="#b8864a" stroke-width="1" opacity=".3"/><line x1="44" y1="28" x2="48" y2="56" stroke="#b8864a" stroke-width="1" opacity=".3"/><path d="M14,28 Q32,6 50,28" fill="none" stroke="#b8864a" stroke-width="2.5" stroke-linecap="round"/><line x1="10" y1="28" x2="54" y2="28" stroke="#b8864a" stroke-width="2.5" stroke-linecap="round"/><circle cx="24" cy="24" r="6" fill="#d4a5a5" stroke="#9e6060" stroke-width="1.2"/><circle cx="38" cy="22" r="5" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.2"/><circle cx="32" cy="18" r="4" fill="#c4b7d4" stroke="#7a6690" stroke-width="1.2"/></svg>',

  sable: '<svg viewBox="0 0 64 64"><path d="M18,12 L16,34 Q16,42 24,42 L40,42 Q48,42 48,34 L46,12 Z" fill="#f0d860" stroke="#c8a830" stroke-width="2"/><path d="M18,16 Q8,16 8,26 Q8,34 16,34" fill="none" stroke="#c8a830" stroke-width="2.5" stroke-linecap="round"/><path d="M46,16 Q56,16 56,26 Q56,34 48,34" fill="none" stroke="#c8a830" stroke-width="2.5" stroke-linecap="round"/><rect x="28" y="42" width="8" height="8" fill="#c8a830"/><rect x="20" y="50" width="24" height="4" rx="2" fill="#c8a830" stroke="#a88020" stroke-width="1"/></svg>',

  // â”€â”€ Studio Projects â”€â”€
  swatch: '<svg viewBox="0 0 64 64"><path d="M16,18 L16,46 Q16,52 22,52 L24,52 Q28,52 28,46 L28,26" fill="none" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/><line x1="16" y1="18" x2="44" y2="18" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/><path d="M28,26 Q28,20 34,20 L44,20 Q48,20 48,16 L44,18" fill="none" stroke="#7a6690" stroke-width="2" stroke-linecap="round"/><rect x="32" y="28" width="20" height="24" rx="2" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><line x1="36" y1="28" x2="36" y2="52" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="40" y1="28" x2="40" y2="52" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="44" y1="28" x2="44" y2="52" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="48" y1="28" x2="48" y2="52" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="32" y1="34" x2="52" y2="34" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="32" y1="40" x2="52" y2="40" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="32" y1="46" x2="52" y2="46" stroke="#6a8a55" stroke-width=".8" opacity=".3"/></svg>',

  socks: '<svg viewBox="0 0 64 64"><path d="M14,6 L14,38 Q14,48 24,48 L30,48 Q36,48 36,40 L36,38 L24,38 L24,6 Z" fill="#d4a5a5" stroke="#9e6060" stroke-width="2" stroke-linejoin="round"/><line x1="14" y1="10" x2="24" y2="10" stroke="#9e6060" stroke-width="1" opacity=".3"/><line x1="14" y1="14" x2="24" y2="14" stroke="#9e6060" stroke-width="1" opacity=".3"/><path d="M30,6 L30,38 Q30,48 40,48 L46,48 Q52,48 52,40 L52,38 L40,38 L40,6 Z" fill="#c4b7d4" stroke="#7a6690" stroke-width="2" stroke-linejoin="round"/><line x1="30" y1="10" x2="40" y2="10" stroke="#7a6690" stroke-width="1" opacity=".3"/><line x1="30" y1="14" x2="40" y2="14" stroke="#7a6690" stroke-width="1" opacity=".3"/></svg>',

  beanie: '<svg viewBox="0 0 64 64"><g class="svg-wobble"><circle cx="30" cy="34" r="20" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M12,28 Q30,16 48,28" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M12,40 Q30,50 48,40" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5"/><path d="M18,16 Q28,34 18,52" fill="none" stroke="#9e6060" stroke-width="1.2" opacity=".35"/><path d="M42,16 Q32,34 42,52" fill="none" stroke="#9e6060" stroke-width="1.2" opacity=".35"/></g></svg>',

  shawl: '<svg viewBox="0 0 64 64"><g class="svg-wobble" style="animation-duration:3s"><path d="M52,4 Q32,32 12,58" fill="none" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/><path d="M52,4 Q40,10 38,20 Q44,14 52,4" fill="#e4ecda" stroke="#6a8a55" stroke-width="1"/><path d="M44,14 Q30,20 28,32 Q36,24 44,14" fill="#e4ecda" stroke="#6a8a55" stroke-width="1"/><path d="M36,26 Q22,32 20,42 Q28,34 36,26" fill="#e4ecda" stroke="#6a8a55" stroke-width="1"/><path d="M28,38 Q16,42 14,52 Q22,44 28,38" fill="#e4ecda" stroke="#6a8a55" stroke-width="1"/><path d="M52,4 Q54,14 48,22 Q52,12 52,4" fill="#e4ecda" stroke="#6a8a55" stroke-width="1"/><path d="M44,16 Q48,26 40,34 Q46,24 44,16" fill="#e4ecda" stroke="#6a8a55" stroke-width="1"/></g></svg>',

  sweater: '<svg viewBox="0 0 64 64"><path d="M18,24 L18,54 L46,54 L46,24 Q40,20 32,18 Q24,20 18,24 Z" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M24,16 Q32,12 40,16 Q46,20 46,24 Q40,20 32,18 Q24,20 18,24 Q18,20 24,16 Z" fill="#c4b7d4" stroke="#7a6690" stroke-width="1.5"/><rect x="18" y="30" width="28" height="6" fill="#c4b7d4" opacity=".4"/><path d="M18,33 L22,30 L26,33 L30,30 L34,33 L38,30 L42,33 L46,30" fill="none" stroke="#9e6060" stroke-width="1.2" opacity=".5"/><path d="M18,24 L4,34 L8,38 L18,30" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M46,24 L60,34 L56,38 L46,30" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/></svg>',

  blanket: '<svg viewBox="0 0 64 64"><rect x="8" y="14" width="48" height="40" rx="3" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><rect x="8" y="14" width="48" height="5" rx="3" fill="#7badd4"/><rect x="8" y="19" width="48" height="5" fill="#7b9e6b"/><rect x="8" y="24" width="48" height="5" fill="#b8c86b"/><rect x="8" y="29" width="48" height="5" fill="#e8d060"/><rect x="8" y="34" width="48" height="5" fill="#e8a040"/><rect x="8" y="39" width="48" height="5" fill="#d47070"/><rect x="8" y="44" width="48" height="5" fill="#d4a5a5"/><rect x="8" y="49" width="48" height="5" rx="3" fill="#c4b7d4"/><rect x="8" y="14" width="48" height="40" rx="3" fill="none" stroke="#8a7e72" stroke-width="1.5"/></svg>',

  autocrafter: '<svg viewBox="0 0 64 64"><rect x="16" y="8" width="32" height="24" rx="4" fill="#ede7dc" stroke="#8a7e72" stroke-width="2"/><rect x="22" y="14" width="8" height="6" rx="1" fill="#6a8a55"/><rect x="34" y="14" width="8" height="6" rx="1" fill="#6a8a55"/><path d="M24,26 L27,24 L30,26 L33,24 L36,26 L39,24" fill="none" stroke="#8a7e72" stroke-width="1.5"/><rect x="20" y="32" width="24" height="20" rx="3" fill="#ede7dc" stroke="#8a7e72" stroke-width="2"/><line x1="32" y1="8" x2="32" y2="2" stroke="#8a7e72" stroke-width="2" stroke-linecap="round"/><circle cx="32" cy="2" r="2" fill="#d4a5a5"/><text x="32" y="47" text-anchor="middle" font-size="10" fill="#d4a5a5">&#x2665;</text></svg>',

  // â”€â”€ Section Headers â”€â”€
  pasture_header: '<svg viewBox="0 0 64 64"><path d="M0,44 Q16,32 32,40 Q48,48 64,38 L64,64 L0,64 Z" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.5"/><path d="M0,50 Q20,42 40,48 Q56,54 64,46 L64,64 L0,64 Z" fill="#6a8a55" opacity=".2"/><line x1="6" y1="38" x2="6" y2="50" stroke="#b8864a" stroke-width="1.5"/><line x1="16" y1="34" x2="16" y2="46" stroke="#b8864a" stroke-width="1.5"/><line x1="6" y1="42" x2="16" y2="38" stroke="#b8864a" stroke-width="1"/><line x1="6" y1="46" x2="16" y2="42" stroke="#b8864a" stroke-width="1"/><g class="svg-wool"><ellipse cx="40" cy="38" rx="6" ry="4" fill="#f5f0e8" stroke="#6a8a55" stroke-width="1"/><circle cx="36" cy="36" r="2.5" fill="#f5f0e8" stroke="#6a8a55" stroke-width=".8"/><circle cx="40" cy="35" r="2.5" fill="#f5f0e8" stroke="#6a8a55" stroke-width=".8"/></g><ellipse cx="45" cy="37" rx="2" ry="2.5" fill="#4a3f35"/><circle cx="52" cy="12" r="4" fill="#f0d860"/></svg>',

  mill_header: '<svg viewBox="0 0 64 64"><rect x="8" y="24" width="48" height="32" rx="2" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><path d="M6,24 L32,10 L58,24 Z" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><rect x="44" y="6" width="8" height="18" fill="#b8864a"/><rect x="26" y="40" width="12" height="16" rx="6" fill="#b8864a" opacity=".3"/><rect x="14" y="32" width="8" height="8" rx="1" fill="#f5f0e8" stroke="#b8864a" stroke-width="1"/><rect x="42" y="32" width="8" height="8" rx="1" fill="#f5f0e8" stroke="#b8864a" stroke-width="1"/></svg>',

  shop_header: '<svg viewBox="0 0 64 64"><rect x="8" y="20" width="48" height="36" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><path d="M4,20 L60,20 L56,28 Q48,24 40,28 Q32,24 24,28 Q16,24 8,28 Z" fill="#9e6060" stroke="#9e6060" stroke-width="1.5"/><rect x="14" y="32" width="16" height="14" rx="1" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/><circle cx="20" cy="40" r="3" fill="#e4ecda"/><circle cx="26" cy="40" r="3" fill="#c4b7d4"/><circle cx="23" cy="36" r="3" fill="#fce8d0"/><rect x="36" y="32" width="14" height="24" rx="2" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/><circle cx="46" cy="44" r="1.5" fill="#9e6060"/></svg>',

  studio_header: '<svg viewBox="0 0 64 64"><g class="svg-snip"><circle cx="12" cy="16" r="7" fill="none" stroke="#7a6690" stroke-width="2"/><line x1="17" y1="20" x2="50" y2="30" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/></g><g class="svg-snip" style="animation-direction:reverse"><circle cx="12" cy="48" r="7" fill="none" stroke="#7a6690" stroke-width="2"/><line x1="17" y1="44" x2="50" y2="34" stroke="#7a6690" stroke-width="2.5" stroke-linecap="round"/></g><circle cx="40" cy="32" r="3" fill="#7a6690"/><circle cx="40" cy="32" r="1.5" fill="white"/><path d="M50,30 Q56,28 60,32 Q56,36 50,34" fill="none" stroke="#9e6060" stroke-width="1.5" opacity=".5" stroke-linecap="round"/></svg>',

  // â”€â”€ Specials â”€â”€
  husbander: '<svg viewBox="0 0 64 64"><circle cx="32" cy="18" r="10" fill="#f5e6d0" stroke="#b8864a" stroke-width="2"/><circle cx="29" cy="16" r="1.5" fill="#4a3f35"/><circle cx="35" cy="16" r="1.5" fill="#4a3f35"/><path d="M29,22 Q32,25 35,22" fill="none" stroke="#4a3f35" stroke-width="1.2" stroke-linecap="round"/><path d="M20,10 L44,10 L44,14 Q44,8 32,6 Q20,8 20,14 Z" fill="#6a8a55" stroke="#6a8a55" stroke-width="1"/><rect x="18" y="10" width="28" height="3" rx="1" fill="#6a8a55"/><rect x="24" y="30" width="16" height="24" rx="3" fill="#6a8a55" stroke="#6a8a55" stroke-width="1"/><line x1="24" y1="36" x2="12" y2="44" stroke="#f5e6d0" stroke-width="3" stroke-linecap="round"/><line x1="40" y1="36" x2="52" y2="44" stroke="#f5e6d0" stroke-width="3" stroke-linecap="round"/><line x1="10" y1="44" x2="10" y2="32" stroke="#b8864a" stroke-width="2" stroke-linecap="round"/></svg>',

  blocking: '<svg viewBox="0 0 64 64"><rect x="8" y="8" width="48" height="48" rx="2" fill="#e4ecda" stroke="#6a8a55" stroke-width="2"/><line x1="8" y1="20" x2="56" y2="20" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="8" y1="32" x2="56" y2="32" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="8" y1="44" x2="56" y2="44" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="20" y1="8" x2="20" y2="56" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="32" y1="8" x2="32" y2="56" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="44" y1="8" x2="44" y2="56" stroke="#6a8a55" stroke-width=".8" opacity=".3"/><line x1="14" y1="4" x2="14" y2="12" stroke="#8a7e72" stroke-width="1.5" stroke-linecap="round"/><line x1="50" y1="4" x2="50" y2="12" stroke="#8a7e72" stroke-width="1.5" stroke-linecap="round"/><line x1="14" y1="52" x2="14" y2="60" stroke="#8a7e72" stroke-width="1.5" stroke-linecap="round"/><line x1="50" y1="52" x2="50" y2="60" stroke="#8a7e72" stroke-width="1.5" stroke-linecap="round"/></svg>',

  // â”€â”€ Scotland â”€â”€
  harrismill: '<svg viewBox="0 0 64 64"><rect x="10" y="24" width="44" height="30" rx="2" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><path d="M8,24 L32,12 L56,24" fill="none" stroke="#b8864a" stroke-width="2"/><rect x="18" y="30" width="10" height="10" fill="none" stroke="#b8864a" stroke-width="1.5"/><line x1="18" y1="33" x2="28" y2="33" stroke="#b8864a" stroke-width=".8" opacity=".5"/><line x1="18" y1="36" x2="28" y2="36" stroke="#b8864a" stroke-width=".8" opacity=".5"/><line x1="21" y1="30" x2="21" y2="40" stroke="#b8864a" stroke-width=".8" opacity=".5"/><line x1="25" y1="30" x2="25" y2="40" stroke="#b8864a" stroke-width=".8" opacity=".5"/><rect x="36" y="30" width="10" height="10" fill="none" stroke="#b8864a" stroke-width="1.5"/><rect x="26" y="42" width="12" height="12" rx="6" fill="#b8864a" opacity=".3"/></svg>',

  heatherdye: '<svg viewBox="0 0 64 64"><path d="M14,30 L14,48 Q14,54 20,54 L44,54 Q50,54 50,48 L50,30" fill="#c4b7d4" stroke="#7a6690" stroke-width="2"/><ellipse cx="32" cy="30" rx="18" ry="5" fill="#c4b7d4" stroke="#7a6690" stroke-width="2"/><path d="M24,18 Q24,12 28,14 Q26,8 32,10 Q30,4 36,8 Q40,6 40,12 Q44,10 42,16 Q38,14 36,18" fill="#9b6bb5" stroke="#7a6690" stroke-width="1.2"/><circle cx="30" cy="12" r="2" fill="#d4a5d4"/><circle cx="36" cy="10" r="1.5" fill="#d4a5d4"/></svg>',

  highlandshop: '<svg viewBox="0 0 64 64"><path d="M4,48 L24,18 L32,28 L44,14 L60,48 Z" fill="#e0dce0" stroke="#7a7080" stroke-width="1.5"/><path d="M24,18 L28,22 L20,22 Z" fill="white" stroke="#7a7080" stroke-width="1"/><path d="M44,14 L50,22 L38,22 Z" fill="white" stroke="#7a7080" stroke-width="1"/><rect x="20" y="40" width="24" height="16" rx="2" fill="#d4a5a5" stroke="#9e6060" stroke-width="1.5"/><rect x="28" y="44" width="8" height="12" rx="1" fill="#9e6060" opacity=".4"/><circle cx="34" cy="50" r="1" fill="#f5f0e8"/></svg>',

  tweed_cap: '<svg viewBox="0 0 64 64"><g class="svg-wobble"><ellipse cx="32" cy="36" rx="22" ry="10" fill="#b8864a" stroke="#8a6630" stroke-width="2"/><path d="M12,34 Q12,18 32,16 Q52,18 52,34" fill="#b8864a" stroke="#8a6630" stroke-width="2"/><ellipse cx="32" cy="34" rx="22" ry="3" fill="#8a6630" opacity=".3"/><path d="M10,36 L6,38 Q4,40 8,40 L14,38" fill="#b8864a" stroke="#8a6630" stroke-width="1.5"/><circle cx="32" cy="16" r="3" fill="#8a6630"/></g></svg>',

  fair_isle: '<svg viewBox="0 0 64 64"><path d="M18,24 L18,54 L46,54 L46,24 Q40,20 32,18 Q24,20 18,24 Z" fill="#e0dce0" stroke="#7a7080" stroke-width="2"/><path d="M24,16 Q32,12 40,16 Q46,20 46,24 Q40,20 32,18 Q24,20 18,24 Q18,20 24,16 Z" fill="#7a7080" stroke="#7a7080" stroke-width="1"/><rect x="18" y="30" width="28" height="8" fill="#7a7080"/><path d="M18,32 L22,30 L26,34 L30,30 L34,34 L38,30 L42,34 L46,30" fill="none" stroke="#e0dce0" stroke-width="1.5"/><path d="M18,36 L22,38 L26,34 L30,38 L34,34 L38,38 L42,34 L46,38" fill="none" stroke="#d4a5a5" stroke-width="1.5"/><path d="M18,24 L4,34 L8,38 L18,30" fill="#e0dce0" stroke="#7a7080" stroke-width="2"/><path d="M46,24 L60,34 L56,38 L46,30" fill="#e0dce0" stroke="#7a7080" stroke-width="2"/></svg>',

  kilt: '<svg viewBox="0 0 64 64"><g class="svg-wobble"><rect x="12" y="10" width="40" height="8" rx="2" fill="#8a6630" stroke="#6a4a20" stroke-width="1.5"/><path d="M12,18 L12,54 L52,54 L52,18 Z" fill="#7a7080" stroke="#5a5060" stroke-width="1.5"/><line x1="20" y1="18" x2="20" y2="54" stroke="#d4a5a5" stroke-width="2" opacity=".6"/><line x1="32" y1="18" x2="32" y2="54" stroke="#d4a5a5" stroke-width="2" opacity=".6"/><line x1="44" y1="18" x2="44" y2="54" stroke="#d4a5a5" stroke-width="2" opacity=".6"/><line x1="12" y1="28" x2="52" y2="28" stroke="#6a8a55" stroke-width="1.5" opacity=".5"/><line x1="12" y1="40" x2="52" y2="40" stroke="#6a8a55" stroke-width="1.5" opacity=".5"/><path d="M34,18 L34,54 L52,54 L52,18 Z" fill="#7a7080" stroke="#5a5060" stroke-width="1" opacity=".3"/></g></svg>',

  tweedfinish: '<svg viewBox="0 0 64 64"><rect x="14" y="32" width="36" height="22" rx="2" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><line x1="14" y1="40" x2="50" y2="40" stroke="#b8864a" stroke-width="1" opacity=".5"/><rect x="28" y="8" width="8" height="28" rx="2" fill="#b8864a" stroke="#8a6630" stroke-width="1.5"/><rect x="20" y="6" width="24" height="8" rx="2" fill="#8a7e72" stroke="#5a5040" stroke-width="1.5"/></svg>',

  // â”€â”€ Peru â”€â”€
  dehairer: '<svg viewBox="0 0 64 64"><rect x="8" y="18" width="48" height="30" rx="4" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><g class="svg-spin" style="transform-origin:24px 30px;animation-duration:2s"><circle cx="24" cy="30" r="8" fill="none" stroke="#8a7e72" stroke-width="2"/><line x1="24" y1="22" x2="24" y2="24" stroke="#8a7e72" stroke-width="2"/><line x1="24" y1="36" x2="24" y2="38" stroke="#8a7e72" stroke-width="2"/></g><g class="svg-spin-rev" style="transform-origin:42px 30px;animation-duration:2s"><circle cx="42" cy="30" r="6" fill="none" stroke="#8a7e72" stroke-width="2"/><line x1="42" y1="24" x2="42" y2="26" stroke="#8a7e72" stroke-width="2"/><line x1="42" y1="34" x2="42" y2="36" stroke="#8a7e72" stroke-width="2"/></g><path d="M4,26 L8,26" fill="none" stroke="#b8864a" stroke-width="3" stroke-linecap="round"/><path d="M56,26 L60,26" fill="none" stroke="#d4a5a5" stroke-width="3" stroke-linecap="round"/><rect x="8" y="48" width="12" height="8" rx="2" fill="#b8864a"/><rect x="44" y="48" width="12" height="8" rx="2" fill="#b8864a"/></svg>',

  cochineal: '<svg viewBox="0 0 64 64"><path d="M14,30 L14,48 Q14,54 20,54 L44,54 Q50,54 50,48 L50,30" fill="#c44a4a" stroke="#8a2020" stroke-width="2"/><ellipse cx="32" cy="30" rx="18" ry="5" fill="#c44a4a" stroke="#8a2020" stroke-width="2"/><ellipse cx="32" cy="30" rx="12" ry="3" fill="#e06060" opacity=".5"/><circle cx="22" cy="18" r="3" fill="#c44a4a" stroke="#8a2020" stroke-width="1"/><circle cx="20" cy="12" r="2" fill="#c44a4a" stroke="#8a2020" stroke-width="1"/><circle cx="26" cy="14" r="2" fill="#c44a4a" stroke="#8a2020" stroke-width="1"/></svg>',

  luxuryshop: '<svg viewBox="0 0 64 64"><rect x="10" y="24" width="44" height="32" rx="2" fill="#f5e6d0" stroke="#b8864a" stroke-width="2"/><path d="M6,24 L58,24 L54,30 Q48,26 40,30 Q32,26 24,30 Q16,26 10,30 Z" fill="#b8864a" stroke="#b8864a" stroke-width="1"/><rect x="16" y="32" width="14" height="12" rx="1" fill="#f5f0e8" stroke="#b8864a" stroke-width="1.5"/><circle cx="20" cy="38" r="3" fill="#d4a5a5"/><circle cx="26" cy="38" r="3" fill="#c4b7d4"/><rect x="36" y="32" width="12" height="24" rx="2" fill="#f5f0e8" stroke="#b8864a" stroke-width="1.5"/><path d="M44,10 L46,16 L52,16 L47,20 L49,26 L44,22 L39,26 L41,20 L36,16 L42,16 Z" fill="#f0d860" stroke="#c8a830" stroke-width="1"/></svg>',

  chullo: '<svg viewBox="0 0 64 64"><g class="svg-wobble"><path d="M14,32 Q14,14 32,12 Q50,14 50,32" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><rect x="14" y="32" width="36" height="6" rx="1" fill="#c4b7d4" stroke="#7a6690" stroke-width="1.5"/><path d="M14,38 L14,48 Q14,50 16,50 L22,50 Q24,50 24,48 L24,38" fill="#d4a5a5" stroke="#9e6060" stroke-width="1.5"/><path d="M40,38 L40,48 Q40,50 42,50 L48,50 Q50,50 50,48 L50,38" fill="#d4a5a5" stroke="#9e6060" stroke-width="1.5"/><line x1="14" y1="22" x2="50" y2="22" stroke="#6a8a55" stroke-width="2" opacity=".6"/><line x1="14" y1="26" x2="50" y2="26" stroke="#e8a830" stroke-width="2" opacity=".6"/><circle cx="32" cy="8" r="4" fill="#f0d860" stroke="#c8a830" stroke-width="1.5"/><circle cx="19" cy="52" r="3" fill="#f0d860" stroke="#c8a830" stroke-width="1"/><circle cx="45" cy="52" r="3" fill="#f0d860" stroke="#c8a830" stroke-width="1"/></g></svg>',

  poncho: '<svg viewBox="0 0 64 64"><g class="svg-wobble" style="animation-duration:3s"><path d="M32,10 L8,48 L56,48 Z" fill="#f5e6d0" stroke="#b8864a" stroke-width="2"/><ellipse cx="32" cy="14" rx="6" ry="4" fill="#f5e6d0" stroke="#b8864a" stroke-width="1.5"/><line x1="16" y1="32" x2="48" y2="32" stroke="#d4a5a5" stroke-width="2" opacity=".6"/><line x1="12" y1="38" x2="52" y2="38" stroke="#9e6060" stroke-width="2" opacity=".5"/><line x1="20" y1="26" x2="44" y2="26" stroke="#6a8a55" stroke-width="1.5" opacity=".5"/><line x1="10" y1="48" x2="14" y2="54" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/><line x1="18" y1="48" x2="20" y2="54" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/><line x1="26" y1="48" x2="27" y2="54" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/><line x1="38" y1="48" x2="37" y2="54" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/><line x1="46" y1="48" x2="44" y2="54" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/><line x1="54" y1="48" x2="50" y2="54" stroke="#b8864a" stroke-width="1.5" stroke-linecap="round"/></g></svg>',

  vicscarf: '<svg viewBox="0 0 64 64"><g class="svg-wobble" style="animation-duration:4s"><path d="M10,12 Q20,8 32,12 Q44,16 54,12 Q54,20 54,28 Q44,32 32,28 Q20,24 10,28 Q10,20 10,12 Z" fill="#f5e8d8" stroke="#b8864a" stroke-width="1.5"/><path d="M10,28 Q20,24 32,28 Q44,32 54,28 Q54,36 54,44 Q44,48 32,44 Q20,40 10,44 Q10,36 10,28 Z" fill="#f5e8d8" stroke="#b8864a" stroke-width="1.5"/><circle cx="20" cy="18" r="2" fill="none" stroke="#b8864a" stroke-width=".8" opacity=".5"/><circle cx="32" cy="20" r="2" fill="none" stroke="#b8864a" stroke-width=".8" opacity=".5"/><circle cx="44" cy="18" r="2" fill="none" stroke="#b8864a" stroke-width=".8" opacity=".5"/><circle cx="20" cy="34" r="2" fill="none" stroke="#b8864a" stroke-width=".8" opacity=".5"/><circle cx="32" cy="36" r="2" fill="none" stroke="#b8864a" stroke-width=".8" opacity=".5"/><circle cx="44" cy="34" r="2" fill="none" stroke="#b8864a" stroke-width=".8" opacity=".5"/><line x1="12" y1="44" x2="14" y2="52" stroke="#b8864a" stroke-width="1" opacity=".5"/><line x1="20" y1="46" x2="21" y2="52" stroke="#b8864a" stroke-width="1" opacity=".5"/><line x1="28" y1="44" x2="28" y2="52" stroke="#b8864a" stroke-width="1" opacity=".5"/><line x1="36" y1="44" x2="36" y2="52" stroke="#b8864a" stroke-width="1" opacity=".5"/><line x1="44" y1="46" x2="43" y2="52" stroke="#b8864a" stroke-width="1" opacity=".5"/><line x1="52" y1="44" x2="50" y2="52" stroke="#b8864a" stroke-width="1" opacity=".5"/></g></svg>',

  andeanblock: '<svg viewBox="0 0 64 64"><path d="M4,52 L20,20 L28,30 L40,16 L60,52 Z" fill="#e0dce0" stroke="#8a7e72" stroke-width="1.5"/><path d="M20,20 L24,26 L16,26 Z" fill="white" stroke="#8a7e72" stroke-width="1"/><path d="M40,16 L46,24 L34,24 Z" fill="white" stroke="#8a7e72" stroke-width="1"/><line x1="14" y1="42" x2="14" y2="36" stroke="#8a7e72" stroke-width="1.5" stroke-linecap="round"/><circle cx="14" cy="35" r="1.5" fill="#d4a5a5"/><line x1="50" y1="42" x2="50" y2="36" stroke="#8a7e72" stroke-width="1.5" stroke-linecap="round"/><circle cx="50" cy="35" r="1.5" fill="#d4a5a5"/><line x1="32" y1="44" x2="32" y2="38" stroke="#8a7e72" stroke-width="1.5" stroke-linecap="round"/><circle cx="32" cy="37" r="1.5" fill="#6a8a55"/></svg>',

  // â”€â”€ Iceland â”€â”€
  lopimill: '<svg viewBox="0 0 64 64"><rect x="10" y="22" width="44" height="30" rx="4" fill="#e0dce0" stroke="#7a7080" stroke-width="2"/><g class="svg-spin" style="transform-origin:32px 36px;animation-duration:2.5s"><circle cx="32" cy="36" r="12" fill="none" stroke="#7a7080" stroke-width="2"/><path d="M32,24 Q40,30 32,36 Q24,42 32,48" fill="none" stroke="#8898a8" stroke-width="2" stroke-linecap="round"/><circle cx="32" cy="36" r="3" fill="#7a7080"/></g><rect x="44" y="8" width="8" height="14" fill="#7a7080"/><path d="M46,8 Q48,2 50,8" fill="none" stroke="#8898a8" stroke-width="1.5"/></svg>',

  reykshop: '<svg viewBox="0 0 64 64"><rect x="10" y="24" width="44" height="32" rx="2" fill="#8898a8" stroke="#5a6878" stroke-width="2"/><path d="M8,24 L32,14 L56,24" fill="none" stroke="#5a6878" stroke-width="2"/><rect x="16" y="32" width="14" height="12" rx="1" fill="#f5f0e8" stroke="#5a6878" stroke-width="1.5"/><circle cx="20" cy="38" r="3" fill="#e0dce0"/><circle cx="26" cy="38" r="3" fill="#c4b7d4"/><rect x="36" y="32" width="12" height="24" rx="2" fill="#f5f0e8" stroke="#5a6878" stroke-width="1.5"/><circle cx="42" cy="44" r="1.5" fill="#5a6878"/></svg>',

  lopapeysa: '<svg viewBox="0 0 64 64"><path d="M18,24 L18,54 L46,54 L46,24 Q40,20 32,18 Q24,20 18,24 Z" fill="#e0dce0" stroke="#7a7080" stroke-width="2"/><path d="M24,16 Q32,12 40,16 Q46,20 46,24 Q40,20 32,18 Q24,20 18,24 Q18,20 24,16 Z" fill="#5a6878" stroke="#5a6878" stroke-width="1"/><path d="M20,22 L24,20 L28,22 L32,20 L36,22 L40,20 L44,22" fill="none" stroke="#e0dce0" stroke-width="1.5"/><path d="M18,26 L22,24 L26,26 L30,24 L34,26 L38,24 L42,26 L46,24" fill="none" stroke="#d4a5a5" stroke-width="1.2"/><path d="M18,24 L4,34 L8,38 L18,30" fill="#e0dce0" stroke="#7a7080" stroke-width="2"/><path d="M46,24 L60,34 L56,38 L46,30" fill="#e0dce0" stroke="#7a7080" stroke-width="2"/></svg>',

  vikinghood: '<svg viewBox="0 0 64 64"><g class="svg-wobble"><path d="M16,28 Q16,10 32,8 Q48,10 48,28" fill="#8898a8" stroke="#5a6878" stroke-width="2"/><path d="M16,28 L12,50 Q12,54 16,54 L22,54 Q24,52 24,48 L24,28" fill="#8898a8" stroke="#5a6878" stroke-width="1.5"/><path d="M40,28 L40,48 Q40,52 42,54 L48,54 Q52,54 52,50 L48,28" fill="#8898a8" stroke="#5a6878" stroke-width="1.5"/><ellipse cx="32" cy="28" rx="16" ry="3" fill="#5a6878" opacity=".3"/><line x1="16" y1="20" x2="48" y2="20" stroke="#e0dce0" stroke-width="2" opacity=".5"/><line x1="16" y1="24" x2="48" y2="24" stroke="#d4a5a5" stroke-width="1.5" opacity=".5"/></g></svg>',

  iceblanket: '<svg viewBox="0 0 64 64"><rect x="8" y="14" width="48" height="40" rx="3" fill="#1a2040" stroke="#5a6878" stroke-width="1.5"/><rect x="8" y="14" width="48" height="6" rx="3" fill="#4a8080"/><rect x="8" y="20" width="48" height="6" fill="#5aa080"/><rect x="8" y="26" width="48" height="6" fill="#80c060"/><rect x="8" y="32" width="48" height="6" fill="#60a0a0"/><rect x="8" y="38" width="48" height="6" fill="#4a6090"/><rect x="8" y="44" width="48" height="5" fill="#3a4070"/><rect x="8" y="49" width="48" height="5" rx="3" fill="#2a3060"/><rect x="8" y="14" width="48" height="40" rx="3" fill="none" stroke="#5a6878" stroke-width="1.5"/><circle cx="44" cy="18" r="1" fill="white" opacity=".6"/><circle cx="20" cy="22" r=".8" fill="white" opacity=".4"/><circle cx="50" cy="36" r=".8" fill="white" opacity=".5"/></svg>',

  hotspring: '<svg viewBox="0 0 64 64"><ellipse cx="32" cy="44" rx="22" ry="12" fill="#7badd4" stroke="#5a8aaa" stroke-width="2"/><ellipse cx="32" cy="44" rx="16" ry="8" fill="#8abcdd" opacity=".5"/><path d="M20,40 Q22,34 20,28" fill="none" stroke="#d0d8e0" stroke-width="2" stroke-linecap="round" opacity=".6"><animate attributeName="d" values="M20,40 Q22,34 20,28;M20,40 Q18,34 20,28;M20,40 Q22,34 20,28" dur="2s" repeatCount="indefinite"/></path><path d="M32,38 Q34,30 32,22" fill="none" stroke="#d0d8e0" stroke-width="2.5" stroke-linecap="round" opacity=".6"><animate attributeName="d" values="M32,38 Q34,30 32,22;M32,38 Q30,30 32,22;M32,38 Q34,30 32,22" dur="2.5s" repeatCount="indefinite"/></path><path d="M44,40 Q46,34 44,28" fill="none" stroke="#d0d8e0" stroke-width="2" stroke-linecap="round" opacity=".6"><animate attributeName="d" values="M44,40 Q46,34 44,28;M44,40 Q42,34 44,28;M44,40 Q46,34 44,28" dur="2.2s" repeatCount="indefinite"/></path></svg>',

  // â”€â”€ Japan â”€â”€
  silkreel: '<svg viewBox="0 0 64 64"><rect x="12" y="24" width="40" height="24" rx="2" fill="#f5e8d8" stroke="#b8864a" stroke-width="1.5"/><g class="svg-spin" style="transform-origin:24px 36px;animation-duration:2s"><circle cx="24" cy="36" r="8" fill="none" stroke="#c44a6a" stroke-width="2"/><circle cx="24" cy="36" r="2" fill="#c44a6a"/></g><g class="svg-spin-rev" style="transform-origin:42px 36px;animation-duration:2s"><circle cx="42" cy="36" r="6" fill="none" stroke="#c44a6a" stroke-width="2"/><circle cx="42" cy="36" r="1.5" fill="#c44a6a"/></g><path d="M24,28 Q33,24 42,30" fill="none" stroke="#f0d860" stroke-width="1.5" opacity=".6"/><line x1="12" y1="48" x2="12" y2="56" stroke="#b8864a" stroke-width="2"/><line x1="52" y1="48" x2="52" y2="56" stroke="#b8864a" stroke-width="2"/></svg>',

  shibori: '<svg viewBox="0 0 64 64"><path d="M14,30 L14,48 Q14,54 20,54 L44,54 Q50,54 50,48 L50,30" fill="#2a4080" stroke="#1a2860" stroke-width="2"/><ellipse cx="32" cy="30" rx="18" ry="5" fill="#2a4080" stroke="#1a2860" stroke-width="2"/><ellipse cx="32" cy="30" rx="12" ry="3" fill="#3a60a0" opacity=".5"/><circle cx="24" cy="18" r="5" fill="#f5f0e8" stroke="#1a2860" stroke-width="1.2"/><circle cx="24" cy="18" r="2" fill="#2a4080"/><circle cx="38" cy="14" r="4" fill="#f5f0e8" stroke="#1a2860" stroke-width="1.2"/><circle cx="38" cy="14" r="1.5" fill="#2a4080"/></svg>',

  tokyoshop: '<svg viewBox="0 0 64 64"><rect x="10" y="20" width="44" height="36" rx="2" fill="#f5e8f0" stroke="#c44a6a" stroke-width="2"/><rect x="10" y="20" width="44" height="8" fill="#c44a6a"/><rect x="16" y="32" width="14" height="12" rx="1" fill="#f5f0e8" stroke="#c44a6a" stroke-width="1.5"/><circle cx="20" cy="38" r="3" fill="#d4a5a5"/><circle cx="26" cy="38" r="3" fill="#7badd4"/><rect x="36" y="32" width="12" height="24" rx="2" fill="#f5f0e8" stroke="#c44a6a" stroke-width="1.5"/><circle cx="38" cy="22" r="2" fill="#f0d860"/><circle cx="44" cy="24" r="1.5" fill="#f0d860"/><circle cx="50" cy="22" r="1" fill="#f0d860"/></svg>',

  furoshiki: '<svg viewBox="0 0 64 64"><g class="svg-wobble" style="animation-duration:3s"><rect x="16" y="16" width="32" height="32" rx="2" fill="#c44a6a" stroke="#8a2040" stroke-width="1.5" transform="rotate(45,32,32)"/><path d="M32,10 Q36,4 40,8" fill="none" stroke="#c44a6a" stroke-width="2.5" stroke-linecap="round"/><path d="M32,10 Q28,4 24,8" fill="none" stroke="#c44a6a" stroke-width="2.5" stroke-linecap="round"/><circle cx="32" cy="32" r="4" fill="#f0d860" opacity=".6"/></g></svg>',

  kimono: '<svg viewBox="0 0 64 64"><path d="M20,16 L20,54 L44,54 L44,16 Q38,20 32,22 Q26,20 20,16 Z" fill="#c44a6a" stroke="#8a2040" stroke-width="2"/><path d="M20,16 Q26,20 32,22 Q38,20 44,16 L38,10 Q32,8 26,10 Z" fill="#f5e8f0" stroke="#8a2040" stroke-width="1.5"/><path d="M32,22 L32,54" fill="none" stroke="#8a2040" stroke-width="1" opacity=".3"/><path d="M20,16 L6,28 L10,32 L20,24" fill="#c44a6a" stroke="#8a2040" stroke-width="2"/><path d="M44,16 L58,28 L54,32 L44,24" fill="#c44a6a" stroke="#8a2040" stroke-width="2"/><circle cx="28" cy="36" r="3" fill="#f0d860" opacity=".5"/><circle cx="36" cy="44" r="2.5" fill="#f0d860" opacity=".4"/></svg>',

  obi: '<svg viewBox="0 0 64 64"><g class="svg-wobble" style="animation-duration:3s"><rect x="8" y="20" width="48" height="24" rx="2" fill="#c44a6a" stroke="#8a2040" stroke-width="2"/><rect x="24" y="18" width="16" height="28" rx="2" fill="#f0d860" stroke="#c8a830" stroke-width="1.5"/><path d="M32,46 L32,56 Q28,58 26,54 L28,48" fill="none" stroke="#c44a6a" stroke-width="2.5" stroke-linecap="round"/><path d="M32,46 L32,56 Q36,58 38,54 L36,48" fill="none" stroke="#c44a6a" stroke-width="2.5" stroke-linecap="round"/><line x1="8" y1="28" x2="24" y2="28" stroke="#f0d860" stroke-width="1" opacity=".4"/><line x1="8" y1="36" x2="24" y2="36" stroke="#f0d860" stroke-width="1" opacity=".4"/><line x1="40" y1="28" x2="56" y2="28" stroke="#f0d860" stroke-width="1" opacity=".4"/><line x1="40" y1="36" x2="56" y2="36" stroke="#f0d860" stroke-width="1" opacity=".4"/></g></svg>',

  wabisabi: '<svg viewBox="0 0 64 64"><path d="M14,28 L14,44 Q14,52 24,52 L40,52 Q50,52 50,44 L50,28" fill="#8a7e60" stroke="#5a5040" stroke-width="2"/><ellipse cx="32" cy="28" rx="18" ry="5" fill="#8a7e60" stroke="#5a5040" stroke-width="2"/><ellipse cx="32" cy="28" rx="14" ry="3.5" fill="#a09070" opacity=".5"/><path d="M50,34 Q56,36 56,42 Q56,46 50,44" fill="none" stroke="#5a5040" stroke-width="2" stroke-linecap="round"/><path d="M24,28 Q28,32 36,28" fill="none" stroke="#5a5040" stroke-width="1" opacity=".3"/></svg>',

  // â”€â”€ Australia â”€â”€
  megamill: '<svg viewBox="0 0 64 64"><rect x="6" y="28" width="52" height="26" rx="2" fill="#fce8d0" stroke="#b8864a" stroke-width="2"/><rect x="12" y="18" width="20" height="10" fill="#fce8d0" stroke="#b8864a" stroke-width="1.5"/><rect x="42" y="6" width="10" height="22" fill="#b8864a"/><rect x="48" y="10" width="8" height="18" fill="#b8864a"/><g class="svg-spin" style="transform-origin:20px 40px;animation-duration:1.5s"><circle cx="20" cy="40" r="6" fill="none" stroke="#8a7e72" stroke-width="2"/><line x1="20" y1="34" x2="20" y2="36" stroke="#8a7e72" stroke-width="2"/></g><g class="svg-spin-rev" style="transform-origin:38px 40px;animation-duration:1.5s"><circle cx="38" cy="40" r="6" fill="none" stroke="#8a7e72" stroke-width="2"/><line x1="38" y1="34" x2="38" y2="36" stroke="#8a7e72" stroke-width="2"/></g></svg>',

  eucadye: '<svg viewBox="0 0 64 64"><path d="M14,32 L14,48 Q14,54 20,54 L44,54 Q50,54 50,48 L50,32" fill="#6a8a55" stroke="#4a6a35" stroke-width="2"/><ellipse cx="32" cy="32" rx="18" ry="5" fill="#6a8a55" stroke="#4a6a35" stroke-width="2"/><ellipse cx="32" cy="32" rx="12" ry="3" fill="#8aaa70" opacity=".5"/><path d="M24,26 Q20,16 24,10 Q28,16 24,26" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.2"/><path d="M34,22 Q30,12 34,6 Q38,12 34,22" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.2"/><path d="M42,26 Q38,18 42,12 Q46,18 42,26" fill="#e4ecda" stroke="#6a8a55" stroke-width="1.2"/></svg>',

  sydneyshop: '<svg viewBox="0 0 64 64"><rect x="6" y="22" width="52" height="34" rx="2" fill="#d4a5a5" stroke="#9e6060" stroke-width="2"/><rect x="6" y="22" width="52" height="8" fill="#9e6060"/><rect x="12" y="34" width="18" height="12" rx="1" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/><rect x="34" y="34" width="18" height="12" rx="1" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/><rect x="24" y="48" width="16" height="8" rx="2" fill="#f5f0e8" stroke="#9e6060" stroke-width="1.5"/><circle cx="32" cy="52" r="1.5" fill="#9e6060"/></svg>',

  surfscarf: '<svg viewBox="0 0 64 64"><g class="svg-wobble" style="animation-duration:3s"><rect x="8" y="16" width="48" height="32" rx="4" fill="#7badd4" stroke="#5a8aaa" stroke-width="1.5"/><path d="M8,28 Q16,22 24,28 Q32,34 40,28 Q48,22 56,28" fill="none" stroke="white" stroke-width="2" opacity=".6"/><path d="M8,36 Q16,30 24,36 Q32,42 40,36 Q48,30 56,36" fill="none" stroke="white" stroke-width="1.5" opacity=".4"/><line x1="10" y1="48" x2="12" y2="54" stroke="#5a8aaa" stroke-width="1" opacity=".5"/><line x1="18" y1="48" x2="19" y2="54" stroke="#5a8aaa" stroke-width="1" opacity=".5"/><line x1="26" y1="48" x2="26" y2="54" stroke="#5a8aaa" stroke-width="1" opacity=".5"/><line x1="38" y1="48" x2="38" y2="54" stroke="#5a8aaa" stroke-width="1" opacity=".5"/><line x1="46" y1="48" x2="45" y2="54" stroke="#5a8aaa" stroke-width="1" opacity=".5"/><line x1="54" y1="48" x2="52" y2="54" stroke="#5a8aaa" stroke-width="1" opacity=".5"/></g></svg>',

  outback: '<svg viewBox="0 0 64 64"><path d="M20,16 L20,54 L44,54 L44,16 Q38,20 32,22 Q26,20 20,16 Z" fill="#b8864a" stroke="#8a6630" stroke-width="2"/><path d="M20,16 Q14,20 14,30 L20,28" fill="#b8864a" stroke="#8a6630" stroke-width="1.5"/><path d="M44,16 Q50,20 50,30 L44,28" fill="#b8864a" stroke="#8a6630" stroke-width="1.5"/><path d="M20,16 L32,22 L44,16 L38,10 Q32,8 26,10 Z" fill="#f5e6d0" stroke="#8a6630" stroke-width="1.5"/><line x1="32" y1="22" x2="32" y2="48" stroke="#8a6630" stroke-width="1" opacity=".3"/><circle cx="30" cy="30" r="1.5" fill="#8a6630"/><circle cx="30" cy="38" r="1.5" fill="#8a6630"/><rect x="22" y="38" width="8" height="10" rx="1" fill="#8a6630" opacity=".2"/></svg>',

  dreaming: '<svg viewBox="0 0 64 64"><rect x="8" y="8" width="48" height="48" rx="3" fill="#b8864a" stroke="#8a6630" stroke-width="1.5"/><circle cx="32" cy="32" r="8" fill="none" stroke="#f0d860" stroke-width="2"/><circle cx="32" cy="32" r="3" fill="#f0d860"/><circle cx="32" cy="32" r="16" fill="none" stroke="#d4a5a5" stroke-width="1.5" stroke-dasharray="4 3"/><circle cx="20" cy="16" r="3" fill="#f0d860" opacity=".6"/><circle cx="44" cy="16" r="3" fill="#d4a5a5" opacity=".6"/><circle cx="16" cy="44" r="3" fill="#6a8a55" opacity=".6"/><circle cx="48" cy="44" r="3" fill="#7badd4" opacity=".6"/><path d="M20,16 Q26,24 32,24" fill="none" stroke="#f0d860" stroke-width="1" opacity=".5" stroke-dasharray="2 2"/><path d="M44,16 Q38,24 32,24" fill="none" stroke="#d4a5a5" stroke-width="1" opacity=".5" stroke-dasharray="2 2"/></svg>',

  lanolin: '<svg viewBox="0 0 64 64"><g class="svg-bob"><path d="M32,8 Q44,28 44,40 Q44,52 32,54 Q20,52 20,40 Q20,28 32,8 Z" fill="#f0d860" stroke="#c8a830" stroke-width="2"/><ellipse cx="32" cy="42" rx="8" ry="6" fill="white" opacity=".3"/></g></svg>',
};

function icon(id, size) {
  const svg = SVG_ICONS[id];
  if (!svg) return null;
  return svg.replace('<svg ', '<svg width="' + size + '" height="' + size + '" ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPGRADE & PROJECT DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PASTURE_UPGRADES = [
  { id: 'merino',  name: 'Merino Sheep',   emoji: 'ðŸ‘', baseCost: 10,    fiberPerSec: 1,   desc: '+1 fiber/s' },
  { id: 'alpaca',  name: 'Suri Alpaca',    emoji: 'ðŸ¦™', baseCost: 150,   fiberPerSec: 5,   desc: '+5 fiber/s â€” incredible drape!' },
  { id: 'rabbit',  name: 'Angora Rabbit',  emoji: 'ðŸ‡', baseCost: 1000,  fiberPerSec: 25,  desc: '+25 fiber/s â€” maximum halo & fuzz!' },
  { id: 'goat',    name: 'Cashmere Goat',  emoji: 'ðŸ', baseCost: 5000,  fiberPerSec: 100, desc: '+100 fiber/s â€” pure luxury.' },
];

const PASTURE_SPECIAL = [
  { id: 'husbander', name: 'Animal Husbander', emoji: 'ðŸ‘¨â€ðŸŒ¾', baseCost: 500, desc: 'Auto-buys best animal every 60s', oneTime: true },
];

const MILL_PROCESSING = [
  { id: 'spindle',  name: 'Drop Spindle',          emoji: 'ðŸªµ', baseCost: 50,   processPerSec: 1,  desc: '+1 fiberâ†’skein/s' },
  { id: 'wheel',    name: 'Ashford Spinning Wheel', emoji: 'ðŸŽ¡', baseCost: 500,  processPerSec: 10, desc: '+10 fiberâ†’skein/s' },
  { id: 'electric', name: 'Electric Carder',        emoji: 'âš¡', baseCost: 3000, processPerSec: 50, desc: '+50 fiberâ†’skein/s' },
];

const MILL_DYE = [
  { id: 'kettle',  name: 'Kettle Dyeing',      emoji: 'ðŸ«•', baseCost: 1000, multiplier: 2, desc: 'All skeins worth 2x cash', oneTime: true },
  { id: 'speckle', name: 'Speckled Indie Dye',  emoji: 'ðŸŽ¨', baseCost: 5000, multiplier: 5, desc: 'All skeins worth 5x cash', oneTime: true },
];

const SHOP_FIBER = [
  { id: 'fibermerchant', name: 'Fiber Merchant', emoji: 'ðŸ§º', baseCost: 100, desc: 'Auto-sells 5 fiber/s at $2 each', oneTime: true },
];

const SHOP_UPGRADES = [
  { id: 'swift',     name: 'Swift & Ball Winder', emoji: 'ðŸ§µ', baseCost: 200,  skeinsPerSec: 2,  desc: '+2 skeins sold/s' },
  { id: 'knitnight', name: 'Host Knit Night',     emoji: 'ðŸŒ™', baseCost: 1000, skeinsPerSec: 10, desc: '+10 skeins sold/s' },
];

const SHOP_SPECIAL = [
  { id: 'sable', name: 'Achieve S.A.B.L.E.', emoji: 'ðŸ†', baseCost: 10000, passiveIncome: 500, desc: '+$500/s passive income!', oneTime: true },
];

const CITY_SHOPS = [
  {
    id: 'fiber_market', name: 'The Fiber Market', upgradeIds: ['fibermerchant'],
    buildingColor: '#c8b090', roofColor: '#8a7060', mapX: 15, mapY: 70, size: 'small',
    chimneySmoke: false,
    music: [
      'A busker playing fiddle on reclaimed barn wood',
      'Birdsong & the rustle of burlap sacks',
      'Someone enthusiastically haggling nearby',
    ],
    events: ['Fleece Grading Saturday', 'Meet the Shepherd: Farm Tour Sign-ups', 'Raw Wool Flash Sale at 2pm'],
    flavorText: 'Where fleece meets finance.',
    openCondition: () => getOwned('fibermerchant') > 0,
  },
  {
    id: 'yarn_emporium', name: 'Woolly Wonders', upgradeIds: ['swift'],
    buildingColor: '#d4a5a5', roofColor: '#9e6060', mapX: 40, mapY: 55, size: 'medium',
    chimneySmoke: false,
    music: [
      'Lo-fi folk guitar & the clink of swift mechanisms',
      'Acoustic covers of 90s songs, but cozy',
      'Soft piano & the satisfying thwap of a ball winder',
    ],
    events: ['New Arrivals: Speckled Merino in 12 colorways', 'Winding Circle: Bring your own swift!', 'Sample skein swap meet this Friday'],
    flavorText: 'The beating heart of the yarn district.',
    openCondition: () => getOwned('swift') > 0,
  },
  {
    id: 'knit_cafe', name: 'The Purl Cafe', upgradeIds: ['knitnight'],
    buildingColor: '#c4b7d4', roofColor: '#7a6690', mapX: 62, mapY: 68, size: 'medium',
    chimneySmoke: true,
    music: [
      'Jazz piano & the gentle click of needles',
      'Bossa nova & someone frogging under their breath',
      'Vinyl crackle & a cat purring on a WIP pile',
    ],
    events: ['Knit Night every Thursday 7pm', 'Beginner Sock Workshop (BYO DPNs)', 'Stitch & Sip: Wine + Cables edition'],
    flavorText: 'Coffee, yarn, and good company.',
    openCondition: () => getOwned('knitnight') > 0,
  },
  {
    id: 'trophy_hall', name: 'Hall of S.A.B.L.E.', upgradeIds: ['sable'],
    buildingColor: '#f0d6a8', roofColor: '#b89040', mapX: 50, mapY: 30, size: 'large',
    chimneySmoke: false,
    music: [
      'An orchestra playing triumphant fanfares',
      'Choral "ahhhs" every time someone enters',
      'The gentle echo of yarn being reverently shelved',
    ],
    events: ['Grand Tour: View the Stash Collection', 'S.A.B.L.E. Achievement Ceremony', 'Rare Yarn Auction (by invitation only)'],
    flavorText: 'Stash Acquired Beyond Life Expectancy.',
    openCondition: () => getOwned('sable') > 0,
  },
  {
    id: 'highland_shop', name: 'Highland Boutique', upgradeIds: ['highlandshop'],
    buildingColor: '#8a9a7a', roofColor: '#5a6a4a', mapX: 20, mapY: 35, size: 'medium',
    chimneySmoke: false,
    music: [
      'Bagpipes in the distance (tastefully quiet)',
      'A crackling hearth & Scottish folk ballads',
      'Rain on a stone roof & someone humming Auld Lang Syne',
    ],
    events: ['Harris Tweed Trunk Show', 'Fair Isle Pattern Reading Workshop', 'Whisky & Wool Tasting Evening'],
    flavorText: 'Heritage wool from the Highlands.',
    openCondition: () => state.unlockedCountries.includes('scotland'),
  },
  {
    id: 'luxury_shop', name: 'Maison du Fil', upgradeIds: ['luxuryshop'],
    buildingColor: '#d4c4d8', roofColor: '#9a7aa0', mapX: 68, mapY: 42, size: 'medium',
    chimneySmoke: false,
    music: [
      '\u00c9dith Piaf & the whisper of tissue paper',
      'Ambient harp & someone saying "magnifique"',
      'French caf\u00e9 accordion, very gently',
    ],
    events: ['Alpaca Fiber Tasting (yes, really)', 'Trunk Show: Hand-dyed Peruvian Skeins', 'Lecture: The History of Vicuna'],
    flavorText: 'Luxury fibers, impeccably curated.',
    openCondition: () => state.unlockedCountries.includes('peru'),
  },
  {
    id: 'reyk_shop', name: 'Reykjavik Wool', upgradeIds: ['reykshop'],
    buildingColor: '#a8c4d4', roofColor: '#6a8a9a', mapX: 82, mapY: 28, size: 'medium',
    chimneySmoke: false,
    music: [
      'Sigur R\u00f3s & the wind outside',
      'A cozy silence broken only by knitting needles',
      'Icelandic folk songs & hot chocolate sounds',
    ],
    events: ['Lopapeysa Knit-Along (bring your pattern)', 'Viking Wool History Walk', 'Northern Lights Knitting: Rooftop Session'],
    flavorText: 'Wool as rugged as the landscape.',
    openCondition: () => state.unlockedCountries.includes('iceland'),
  },
  {
    id: 'tokyo_lab', name: 'Harajuku Yarn Lab', upgradeIds: ['tokyoshop'],
    buildingColor: '#e8a8b8', roofColor: '#c45a6a', mapX: 75, mapY: 55, size: 'medium',
    chimneySmoke: false,
    music: [
      'City pop & the hum of silk reeling machines',
      'Lo-fi beats & someone unboxing mini skeins',
      'Ambient rain on Tokyo streets & synth pads',
    ],
    events: ['Silk Dyeing: Shibori Masterclass', 'Harajuku Yarn Crawl (5 shops, 1 day)', 'Chiengora Blending Demo'],
    flavorText: 'Where tradition meets innovation.',
    openCondition: () => state.unlockedCountries.includes('japan'),
  },
  {
    id: 'sydney_warehouse', name: 'Sydney Warehouse', upgradeIds: ['sydneyshop'],
    buildingColor: '#d4c090', roofColor: '#b89040', mapX: 88, mapY: 15, size: 'large',
    chimneySmoke: false,
    music: [
      'Indie folk & forklifts beeping in the distance',
      'Triple J radio & the thud of yarn bales',
      'Didgeridoo ambient & someone counting skeins',
    ],
    events: ['Warehouse Sale: 50% off last season', 'Superfine Merino Grading Day', 'Outback Fiber Festival Tickets on Sale'],
    flavorText: 'Industrial-scale yarn paradise.',
    openCondition: () => state.unlockedCountries.includes('australia'),
  },
];

const STUDIO_PROJECTS = [
  { id: 'swatch',  name: 'Gauge Swatch',           emoji: 'ðŸ§·', skeinCost: 10,    seconds: 3,   basePayout: 100,    desc: '10 skeins, 3s â†’ $100' },
  { id: 'socks',   name: 'Vanilla Socks',           emoji: 'ðŸ§¦', skeinCost: 100,   seconds: 10,  basePayout: 1500,   desc: '100 skeins, 10s â†’ $1,500' },
  { id: 'beanie',  name: 'Brioche Beanie',           emoji: 'ðŸ§¶', skeinCost: 500,   seconds: 30,  basePayout: 10000,  desc: '500 skeins, 30s â†’ $10,000' },
  { id: 'shawl',   name: 'Hitchhiker Shawl',         emoji: 'ðŸª¶', skeinCost: 800,   seconds: 20,  basePayout: 6000,   desc: '800 skeins, 20s â†’ $6,000' },
  { id: 'sweater', name: 'Fair Isle Yoke Sweater',    emoji: 'ðŸ§¥', skeinCost: 2500,  seconds: 60,  basePayout: 100000, desc: '2,500 skeins, 60s â†’ $100,000' },
  { id: 'blanket', name: 'Temperature Blanket',       emoji: 'ðŸŒ¡ï¸', skeinCost: 10000, seconds: 120, basePayout: 500000, desc: '10,000 skeins, 2min â†’ $500,000' },
];

const STUDIO_UPGRADE = [
  { id: 'blocking', name: 'Blocking Mats & T-Pins', emoji: 'ðŸ“', baseCost: 50000, desc: 'Doubles all project payouts', oneTime: true },
];

const STUDIO_SPECIAL = [
  { id: 'autocrafter', name: 'Knitting Machine', emoji: 'ðŸ¤–', baseCost: 5000, desc: 'Auto-starts a random project every 10s', oneTime: true },
];

const ANIMAL_NAMES = [
  'Mabel','Barnaby','Clover','Humphrey','Dotty','Professor Fluffington',
  'Rosie','Pip','Butterscotch','Hazel','Juniper','Mochi',
  'Biscuit','Thistle','Winifred','Cashew','Petunia','Marmalade',
  'Sage','Pebble','Truffle','Nutmeg','Bramble','Fern',
  'Maple','Clementine','Toffee','Willow','Poppy','Sprout',
];

const ANIMAL_VIBES = {
  merino: {
    tier:'Common', tierColor:'#7b9e6b',
    gradient:'linear-gradient(135deg,#e8e4d8 0%,#d4cfc0 50%,#c9c2b0 100%)',
    glowColor:'rgba(200,195,180,0.6)',
    particleEmoji:['~','~','~'], particleColor:'#e8e0d0',
    tagline:'Soft, reliable, the backbone of any flock.',
    personality:'Gentle and dependable. Merinos never miss a shearing day.',
    idleAnimation:'chew',
  },
  alpaca: {
    tier:'Uncommon', tierColor:'#c4956a',
    gradient:'linear-gradient(135deg,#f5e6d0 0%,#e8d0b0 50%,#d4b896 100%)',
    glowColor:'rgba(212,184,150,0.6)',
    particleEmoji:['ðŸŒ¸','ðŸŒº','ðŸŒ¼'], particleColor:'#f0c8a0',
    tagline:'Incredible drape. Incredible drama.',
    personality:'Regal and slightly judgy. Will spit if provoked.',
    idleAnimation:'sway',
  },
  rabbit: {
    tier:'Rare', tierColor:'#b07070',
    gradient:'linear-gradient(135deg,#f8e8f0 0%,#e8c8d8 50%,#d8a8c0 100%)',
    glowColor:'rgba(232,200,216,0.6)',
    particleEmoji:['âœ¨','ðŸ’«','â­'], particleColor:'#f0d0e0',
    tagline:'Maximum halo. Maximum fuzz. Maximum chaos.',
    personality:'Hyperactive and adorable. Sheds everywhere.',
    idleAnimation:'hop',
  },
  goat: {
    tier:'Legendary', tierColor:'#8a6fa0',
    gradient:'linear-gradient(135deg,#e0d8f0 0%,#c4b0d8 50%,#a890c0 100%)',
    glowColor:'rgba(168,144,192,0.6)',
    particleEmoji:['ðŸ’Ž','âœ¨','ðŸ’«'], particleColor:'#c8b8d8',
    tagline:'Pure luxury. Pure attitude.',
    personality:'Will eat your favorite sweater. Worth it.',
    idleAnimation:'strut',
  },
  shetland: {
    tier:'Rare', tierColor:'#6a8a5a',
    gradient:'linear-gradient(135deg,#c8d8b8 0%,#a0b890 50%,#88a078 100%)',
    glowColor:'rgba(136,160,120,0.6)',
    particleEmoji:['ðŸƒ','ðŸŒ¿','ðŸŒ¾'], particleColor:'#a8c098',
    tagline:'Fine & Fair Isle ready.',
    personality:'Hardy and traditional. Weathers any storm.',
    idleAnimation:'chew',
  },
  blackface: {
    tier:'Epic', tierColor:'#5a5a6a',
    gradient:'linear-gradient(135deg,#8090a0 0%,#607080 50%,#405060 100%)',
    glowColor:'rgba(80,96,112,0.5)',
    particleEmoji:['ðŸŒ§ï¸','ðŸ”ï¸','ðŸ’¨'], particleColor:'#8898a8',
    tagline:'Rugged highland wool.',
    personality:'Tough as the highlands. Stares you down.',
    idleAnimation:'strut',
  },
  huacaya: {
    tier:'Epic', tierColor:'#c49060',
    gradient:'linear-gradient(135deg,#fff0e0 0%,#f0d8b8 50%,#e0c098 100%)',
    glowColor:'rgba(240,216,184,0.6)',
    particleEmoji:['â˜ï¸','ðŸŒ¤ï¸','âœ¨'], particleColor:'#f8e8d0',
    tagline:'Fluffy cloud fiber.',
    personality:'Round, fluffy, basically a cloud with legs.',
    idleAnimation:'sway',
  },
  vicuna: {
    tier:'Mythic', tierColor:'#d4a030',
    gradient:'linear-gradient(135deg,#f8f0d0 0%,#f0d898 50%,#e8c060 100%)',
    glowColor:'rgba(248,210,80,0.5)',
    particleEmoji:['ðŸŒŸ','ðŸ’›','âœ¨'], particleColor:'#f8e088',
    tagline:'The rarest fiber on Earth.',
    personality:'Mystical and elusive. Protected by ancient law.',
    idleAnimation:'sway',
  },
  icelandic: {
    tier:'Epic', tierColor:'#607890',
    gradient:'linear-gradient(135deg,#d0e0f0 0%,#a8c0d8 50%,#80a0c0 100%)',
    glowColor:'rgba(128,160,192,0.5)',
    particleEmoji:['â„ï¸','ðŸŒ¨ï¸','ðŸ’¨'], particleColor:'#c0d8f0',
    tagline:'Dual-coated: tog & thel.',
    personality:'Viking-tough. Laughs at blizzards.',
    idleAnimation:'chew',
  },
  leadersheep: {
    tier:'Mythic', tierColor:'#4a6080',
    gradient:'linear-gradient(135deg,#b0c8e0 0%,#8098b8 50%,#607898 100%)',
    glowColor:'rgba(96,120,152,0.5)',
    particleEmoji:['ðŸŒŒ','â­','ðŸ”®'], particleColor:'#90a8c8',
    tagline:'Ancient and intelligent.',
    personality:'Knows the way. Always has. Always will.',
    idleAnimation:'strut',
  },
  silkmoth: {
    tier:'Legendary', tierColor:'#b090c0',
    gradient:'linear-gradient(135deg,#f0e8f8 0%,#d8c8e8 50%,#c0a8d8 100%)',
    glowColor:'rgba(192,168,216,0.5)',
    particleEmoji:['ðŸ¦‹','âœ¨','ðŸŒ¸'], particleColor:'#d8c0e8',
    tagline:'Bombyx mori silk.',
    personality:'Delicate, beautiful, and surprisingly industrious.',
    idleAnimation:'flutter',
  },
  akitainu: {
    tier:'Mythic', tierColor:'#c08050',
    gradient:'linear-gradient(135deg,#f8e0c8 0%,#e0c0a0 50%,#c8a080 100%)',
    glowColor:'rgba(200,160,128,0.5)',
    particleEmoji:['ðŸ¾','ðŸ’«','ðŸŒŸ'], particleColor:'#e0c8a8',
    tagline:'Luxury chiengora blend.',
    personality:'Loyal and magnificent. Best boy/girl.',
    idleAnimation:'hop',
  },
  supermerino: {
    tier:'Legendary', tierColor:'#90a870',
    gradient:'linear-gradient(135deg,#f0f0e0 0%,#d8e0c0 50%,#c0d0a0 100%)',
    glowColor:'rgba(192,208,160,0.5)',
    particleEmoji:['ðŸŒ¾','â˜€ï¸','âœ¨'], particleColor:'#d8e0b8',
    tagline:'Under 15 micron luxury.',
    personality:'Premium in every way. The champagne of sheep.',
    idleAnimation:'chew',
  },
  wombat: {
    tier:'Mythic', tierColor:'#8a7060',
    gradient:'linear-gradient(135deg,#e0d0c0 0%,#c0b0a0 50%,#a09080 100%)',
    glowColor:'rgba(160,144,128,0.5)',
    particleEmoji:['ðŸŒ¿','ðŸª¨','â­'], particleColor:'#c8b8a0',
    tagline:'Adorable bulk producer.',
    personality:'Cube poops and fiber? Multitasking legend.',
    idleAnimation:'hop',
  },
};
const DEFAULT_VIBE = {
  tier:'Common', tierColor:'#7b9e6b',
  gradient:'linear-gradient(135deg,#e8e4d8 0%,#d4cfc0 50%,#c9c2b0 100%)',
  glowColor:'rgba(200,195,180,0.6)',
  particleEmoji:['~','~','~'], particleColor:'#e8e0d0',
  tagline:'A fine fiber friend.',
  personality:'Every animal has a story.',
  idleAnimation:'chew',
};
function getAnimalVibe(id) { return ANIMAL_VIBES[id] || DEFAULT_VIBE; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANIMAL POWERS, ABILITIES & TIERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TIER_DEFS = [
  { name:'Bronze', stars:1, fiberBonus:0.25, color:'#cd7f32' },
  { name:'Silver', stars:2, fiberBonus:0.75, color:'#c0c0c0' },
  { name:'Gold',   stars:3, fiberBonus:1.50, color:'#ffd700' },
];

const ANIMAL_POWERS = {
  merino: {
    passive: { name:'Flock Mentality', desc:'Merinos produce bonus fiber at flock size.',
      thresholds:[{count:5,bonus:0.10,label:'+10% merino fiber'},{count:10,bonus:0.25,label:'+25% merino fiber'},{count:20,bonus:0.50,label:'+50% merino fiber'}],
      type:'self_fiber' },
    ability: { name:'Shearing Frenzy', desc:'Instantly generates 60s worth of all fiber.', emoji:'âœ‚ï¸', cooldown:90, duration:0, effect:'instant_fiber_60s' },
    tiers: { costMultiplier:[10,50,250] },
  },
  alpaca: {
    passive: { name:'Luxury Markup', desc:'Alpacas boost shop sale price.',
      thresholds:[{count:3,bonus:0.10,label:'+10% shop price'},{count:8,bonus:0.20,label:'+20% shop price'},{count:15,bonus:0.40,label:'+40% shop price'}],
      type:'shop_price' },
    ability: { name:'Fashion Show', desc:'Doubles shop sell price for 30s.', emoji:'ðŸ’ƒ', cooldown:120, duration:30, effect:'double_shop_price' },
    tiers: { costMultiplier:[10,50,250] },
  },
  rabbit: {
    passive: { name:'Fiber Drift', desc:'Rabbit fluff drifts through the air, adding flat fiber.',
      thresholds:[{count:2,bonus:1,label:'+1 fiber/s'},{count:5,bonus:3,label:'+3 fiber/s'},{count:12,bonus:8,label:'+8 fiber/s'}],
      type:'flat_fiber' },
    ability: { name:'Zoomies', desc:'Doubles ALL production speed for 15s.', emoji:'ðŸ’¨', cooldown:90, duration:15, effect:'double_all_production' },
    tiers: { costMultiplier:[10,50,250] },
  },
  goat: {
    passive: { name:'Cashmere Premium', desc:'Goats boost all income streams.',
      thresholds:[{count:1,bonus:0.05,label:'+5% all income'},{count:3,bonus:0.15,label:'+15% all income'},{count:8,bonus:0.30,label:'+30% all income'}],
      type:'all_income' },
    ability: { name:'Headbutt', desc:'Instantly completes current build or project.', emoji:'ðŸðŸ’¥', cooldown:120, duration:0, effect:'instant_complete' },
    tiers: { costMultiplier:[10,50,250] },
  },
  shetland: {
    passive: { name:'Fair Isle Tradition', desc:'Shetlands boost studio project payouts.',
      thresholds:[{count:3,bonus:0.10,label:'+10% project payout'},{count:8,bonus:0.25,label:'+25% project payout'},{count:15,bonus:0.50,label:'+50% project payout'}],
      type:'project_payout' },
    ability: { name:'Highland Gust', desc:'Triples fiber generation for 20s.', emoji:'ðŸ’¨', cooldown:100, duration:20, effect:'triple_fiber' },
    tiers: { costMultiplier:[10,50,250] },
  },
  blackface: {
    passive: { name:'Rugged Resilience', desc:'Blackface sheep reduce build times.',
      thresholds:[{count:2,bonus:0.10,label:'-10% build time'},{count:5,bonus:0.25,label:'-25% build time'},{count:10,bonus:0.40,label:'-40% build time'}],
      type:'build_speed' },
    ability: { name:'Ram Charge', desc:'Instantly generates 30s of all cash income.', emoji:'ðŸðŸ’¨', cooldown:90, duration:0, effect:'instant_cash_30s' },
    tiers: { costMultiplier:[10,50,250] },
  },
  huacaya: {
    passive: { name:'Cloud Softness', desc:'Huacaya boost mill processing speed.',
      thresholds:[{count:2,bonus:0.10,label:'+10% processing'},{count:6,bonus:0.25,label:'+25% processing'},{count:12,bonus:0.50,label:'+50% processing'}],
      type:'mill_speed' },
    ability: { name:'Fluff Burst', desc:'Instantly converts all fiber to skeins.', emoji:'â˜ï¸', cooldown:60, duration:0, effect:'instant_convert_fiber' },
    tiers: { costMultiplier:[10,50,250] },
  },
  vicuna: {
    passive: { name:'Fiber of the Gods', desc:'Vicuna boost dye multiplier effect.',
      thresholds:[{count:1,bonus:0.15,label:'+15% dye value'},{count:3,bonus:0.30,label:'+30% dye value'},{count:6,bonus:0.60,label:'+60% dye value'}],
      type:'dye_bonus' },
    ability: { name:'Golden Fleece', desc:'Next project completion pays 5x.', emoji:'ðŸŒŸ', cooldown:180, duration:-1, effect:'next_project_5x' },
    tiers: { costMultiplier:[10,50,250] },
  },
  icelandic: {
    passive: { name:'Dual Coat', desc:'Icelandic sheep produce bonus fiber and skeins.',
      thresholds:[{count:2,bonus:0.10,label:'+10% fiber & skeins'},{count:5,bonus:0.20,label:'+20% fiber & skeins'},{count:10,bonus:0.40,label:'+40% fiber & skeins'}],
      type:'fiber_and_skeins' },
    ability: { name:'Viking Rally', desc:'Auto-crafter runs every 2s for 30s.', emoji:'âš”ï¸', cooldown:120, duration:30, effect:'fast_autocraft' },
    tiers: { costMultiplier:[10,50,250] },
  },
  leadersheep: {
    passive: { name:'Flock Leader', desc:'Leader sheep boost all animals\' fiber.',
      thresholds:[{count:1,bonus:0.05,label:'+5% all fiber'},{count:3,bonus:0.12,label:'+12% all fiber'},{count:5,bonus:0.20,label:'+20% all fiber'}],
      type:'all_fiber' },
    ability: { name:'Pathfinder', desc:'Reduces country unlock costs by 20% for 60s.', emoji:'ðŸ§­', cooldown:180, duration:60, effect:'country_discount' },
    tiers: { costMultiplier:[10,50,250] },
  },
  silkmoth: {
    passive: { name:'Silk Thread', desc:'Silk moths boost skein sell value.',
      thresholds:[{count:2,bonus:0.10,label:'+10% skein value'},{count:5,bonus:0.25,label:'+25% skein value'},{count:10,bonus:0.50,label:'+50% skein value'}],
      type:'shop_price' },
    ability: { name:'Silk Cocoon', desc:'Generates 120s of fiber instantly.', emoji:'ðŸ¦‹', cooldown:150, duration:0, effect:'instant_fiber_120s' },
    tiers: { costMultiplier:[10,50,250] },
  },
  akitainu: {
    passive: { name:'Loyal Companion', desc:'Akita reduces husbander interval.',
      thresholds:[{count:1,bonus:0.15,label:'-15% husbander wait'},{count:3,bonus:0.30,label:'-30% husbander wait'},{count:5,bonus:0.50,label:'-50% husbander wait'}],
      type:'husbander_speed' },
    ability: { name:'Good Boy', desc:'Husbander buys 5 animals instantly.', emoji:'ðŸ¾', cooldown:120, duration:0, effect:'instant_buy_5' },
    tiers: { costMultiplier:[10,50,250] },
  },
  supermerino: {
    passive: { name:'Superfine Quality', desc:'Superfine merinos boost all sheep fiber.',
      thresholds:[{count:2,bonus:0.15,label:'+15% all sheep fiber'},{count:5,bonus:0.30,label:'+30% all sheep fiber'},{count:10,bonus:0.50,label:'+50% all sheep fiber'}],
      type:'sheep_fiber' },
    ability: { name:'Shearing Station', desc:'Doubles all fiber for 30s.', emoji:'âœ‚ï¸âœ‚ï¸', cooldown:100, duration:30, effect:'double_fiber' },
    tiers: { costMultiplier:[10,50,250] },
  },
  wombat: {
    passive: { name:'Bulk Producer', desc:'Wombats generate passive cash from cuteness.',
      thresholds:[{count:1,bonus:100,label:'+$100/s'},{count:3,bonus:500,label:'+$500/s'},{count:5,bonus:2000,label:'+$2000/s'}],
      type:'flat_cash' },
    ability: { name:'Cubic Output', desc:'Instantly sells all skeins at 3x price.', emoji:'ðŸª¨', cooldown:90, duration:0, effect:'instant_sell_3x' },
    tiers: { costMultiplier:[10,50,250] },
  },
};

const MILESTONES = [
  { id: 'fo1',      test: () => state.fos >= 1,            msg: 'ðŸ§¶ First FO! Cast off!' },
  { id: 'fo10',     test: () => state.fos >= 10,           msg: 'ðŸ§¶ 10 FOs â€” Time to open an Etsy shop!' },
  { id: 'fo50',     test: () => state.fos >= 50,           msg: 'ðŸ§¶ 50 FOs â€” Master Knitter Unlocked!' },
  { id: 'cash1k',   test: () => state.cash >= 1000,        msg: 'ðŸ’° $1K â€” Enough for one trip to the yarn store!' },
  { id: 'cash100k', test: () => state.cash >= 100000,      msg: 'ðŸ’° $100K Yarn Empire!' },
  { id: 'cash1m',   test: () => state.cash >= 1000000,     msg: 'ðŸ’° Millionaire! But still can\'t afford cashmere.' },
  { id: 'alpaca1',  test: () => getOwned('alpaca') >= 1,   msg: 'ðŸ¦™ First Alpaca â€” Hello, drape!' },
  { id: 'goat1',    test: () => getOwned('goat') >= 1,     msg: 'ðŸ First Cashmere Goat â€” Pure luxury!' },
  { id: 'sable',    test: () => getOwned('sable') >= 1,    msg: 'ðŸ† S.A.B.L.E. â€” Stash Acquired Beyond Life Expectancy!' },
  { id: 'country1',   test: () => state.unlockedCountries.length >= 2, msg: 'ðŸŒ Going International! First country unlocked!' },
  { id: 'country3',   test: () => state.unlockedCountries.length >= 4, msg: 'ðŸŒ Global Yarn Empire! Four countries!' },
  { id: 'allcountry', test: () => state.unlockedCountries.length >= 6, msg: 'ðŸŒ Yarn World Domination! All countries unlocked!' },
  { id: 'cash10m',    test: () => state.cash >= 10000000,  msg: 'ðŸ’° $10M â€” Yarn billionaire vibes!' },
  { id: 'cash100m',   test: () => state.cash >= 100000000, msg: 'ðŸ’° $100M â€” You could buy all of Ravelry!' },
  { id: 'tier_bronze', test: () => Object.values(state.animalTiers).some(arr => Array.isArray(arr) && arr.some(t => t >= 1)), msg: 'ðŸ¥‰ First Bronze upgrade â€” Your animals are leveling up!' },
  { id: 'tier_silver', test: () => Object.values(state.animalTiers).some(arr => Array.isArray(arr) && arr.some(t => t >= 2)), msg: 'ðŸ¥ˆ Silver tier â€” Getting fancy!' },
  { id: 'tier_gold',   test: () => Object.values(state.animalTiers).some(arr => Array.isArray(arr) && arr.some(t => t >= 3)), msg: 'ðŸ¥‡ Gold tier â€” Top of the flock!' },
  { id: 'merino20',    test: () => getOwned('merino') >= 20, msg: 'ðŸ‘ 20 Merinos â€” Flock Mentality maxed!' },
  { id: 'goat8',       test: () => getOwned('goat') >= 8,    msg: 'ðŸ 8 Goats â€” The cashmere just keeps coming!' },
];

const TICKER_MESSAGES = [
  "Just one more row...",
  "Did I drop a stitch?",
  "I definitely have enough yarn for this... right?",
  "Time to weave in the ends...",
  "Is it frogging if I only rip back two rows?",
  "My stash is organized. Don't open that closet.",
  "Gauge swatches are important. I just choose to ignore them.",
  "I'm not hoarding yarn, I'm curating a collection.",
  "Knitting: cheaper than therapy. Probably.",
  "The yarn told me to buy it.",
  "Don't worry I'll block it.",
  "This yarn is blue like your eyeball.",
  "I will never knit you socks.",
  "The sleeves take the longest. And the second one takes longer.",
  "The best place to knit is on the TTC.",
  "Swatches are optional.",
  "This yarn is too rough for you.",
  "One second let me check Ravelry...",
  "It's not a mistake, it's a design feature.",
  "Yarn chicken: the noblest of gambles.",
  "My WIP pile is a lifestyle choice.",
  "I need this yarn. For a project. I'll decide which one later.",
  "Frogging: rip-it, rip-it, rip-it.",
  "Life's too short for acrylic.",
  "The second sock is always harder.",
  "I knit so I don't unravel.",
  "The merinos are having a shearing frenzy!",
  "The alpacas are strutting the runway.",
  "Rabbit zoomies detected. Hold on to your yarn.",
  "The goat headbutted the timeline into submission.",
  "Highland winds are blowing extra fiber today.",
  "The ram charges through obstacles. And fences.",
  "Huacaya fluff levels: maximum cloud.",
  "Vicuna fiber is literally worth its weight in gold.",
  "The Viking Rally has begun! Skeins incoming!",
  "The leadersheep knows the way. Follow.",
  "Bronze is just the beginning.",
  "Silver tier unlocked? Fancy hooves!",
  "Gold tier animals deserve gold-plated hay.",
];

const COUNTRY_TICKER = {
  scotland: [
    "Aye, that's a bonnie skein!",
    "Harris Tweed: 100% pure virgin wool, woven at 48 inches wide.",
    "Fair Isle patterns are actually from a tiny island.",
  ],
  peru: [
    "Vicuna fiber: worth more than gold per gram.",
    "The Incas called it the Fiber of the Gods.",
    "Alpaca fiber comes in 22 natural colors.",
  ],
  iceland: [
    "Lopapeysa has no seams. It's knitted in one piece.",
    "Icelandic sheep have been unchanged since Vikings brought them.",
    "The tog is the outer coat, the thel is the inner. Both are wonderful.",
  ],
  japan: [
    "A single silk cocoon unwinds to 900 meters of thread.",
    "Shibori dyeing dates back to the 8th century.",
    "Wabi-sabi: beauty in imperfection.",
  ],
  australia: [
    "A merino fleece can have 100 million fibers.",
    "Superfine merino: softer than cashmere, stronger than steel (per gram).",
    "Shearing day is the most important day on the station.",
  ],
};

const COST_SCALE = 1.15;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTRY DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const COUNTRIES = [
  {
    id: 'home', name: 'Home Farm', flag: 'ðŸ¡', cost: 0, desc: 'Where it all began',
    mapX: 20, mapY: 35, pinColor: '#7b9e6b',
    animals: null, millProcessing: null, millDye: null,
    shopUpgrades: null, studioProjects: null, studioUpgrade: null,
  },
  {
    id: 'scotland', name: 'Scotland', flag: 'ðŸ´ó §ó ¢ó ³ó £ó ´ó ¿', cost: 1000000, desc: 'Highland wool & heritage tweeds',
    mapX: 19, mapY: 24, pinColor: '#5a7a9a',
    animals: [
      { id: 'shetland',  name: 'Shetland Sheep',    emoji: 'ðŸ‘', baseCost: 8000,   fiberPerSec: 80,  desc: '+80 fiber/s â€” Fine & Fair Isle ready' },
      { id: 'blackface', name: 'Scottish Blackface', emoji: 'ðŸ', baseCost: 15000,  fiberPerSec: 200, desc: '+200 fiber/s â€” Rugged highland wool' },
    ],
    millProcessing: [
      { id: 'harrismill', name: 'Harris Tweed Mill', emoji: 'ðŸ­', baseCost: 50000, processPerSec: 200, desc: '+200 fiberâ†’skein/s' },
    ],
    millDye: [
      { id: 'heatherdye', name: 'Heather Dyeing', emoji: 'ðŸ’œ', baseCost: 25000, multiplier: 8, desc: 'Skeins worth 8x cash', oneTime: true },
    ],
    shopUpgrades: [
      { id: 'highlandshop', name: 'Highland Boutique', emoji: 'ðŸ”ï¸', baseCost: 100000, skeinsPerSec: 50, desc: '+50 skeins sold/s' },
    ],
    studioProjects: [
      { id: 'tweed_cap', name: 'Harris Tweed Cap',  emoji: 'ðŸ§¢', skeinCost: 2000,  seconds: 25,  basePayout: 80000,   desc: '2,000 skeins, 25s â†’ $80,000' },
      { id: 'fair_isle', name: 'Fair Isle Pullover', emoji: 'ðŸ§¥', skeinCost: 8000,  seconds: 90,  basePayout: 400000,  desc: '8,000 skeins, 90s â†’ $400,000' },
      { id: 'kilt',      name: 'Tartan Kilt',       emoji: 'ðŸŽ­', skeinCost: 15000, seconds: 150, basePayout: 1000000, desc: '15,000 skeins, 2.5min â†’ $1,000,000' },
    ],
    studioUpgrade: [
      { id: 'tweedfinish', name: 'Tweed Finishing Press', emoji: 'ðŸ”¨', baseCost: 200000, desc: 'Doubles Scottish project payouts', oneTime: true },
    ],
  },
  {
    id: 'peru', name: 'Peru', flag: 'ðŸ‡µðŸ‡ª', cost: 2500000, desc: 'Luxurious South American fibers',
    mapX: 14, mapY: 62, pinColor: '#c4734a',
    animals: [
      { id: 'huacaya', name: 'Huacaya Alpaca', emoji: 'ðŸ¦™', baseCost: 20000,  fiberPerSec: 150, desc: '+150 fiber/s â€” Fluffy cloud fiber' },
      { id: 'vicuna',  name: 'Vicuna',         emoji: 'ðŸ¦Œ', baseCost: 100000, fiberPerSec: 500, desc: '+500 fiber/s â€” The rarest fiber on Earth' },
    ],
    millProcessing: [
      { id: 'dehairer', name: 'Industrial Dehairer', emoji: 'ðŸ”§', baseCost: 80000, processPerSec: 300, desc: '+300 fiberâ†’skein/s' },
    ],
    millDye: [
      { id: 'cochineal', name: 'Cochineal Dyeing', emoji: 'ðŸ”´', baseCost: 60000, multiplier: 10, desc: 'Skeins worth 10x cash', oneTime: true },
    ],
    shopUpgrades: [
      { id: 'luxuryshop', name: 'Luxury Yarn Boutique', emoji: 'âœ¨', baseCost: 200000, skeinsPerSec: 80, desc: '+80 skeins sold/s' },
    ],
    studioProjects: [
      { id: 'chullo',   name: 'Chullo Hat',         emoji: 'ðŸŽ©', skeinCost: 3000,  seconds: 20,  basePayout: 120000,  desc: '3,000 skeins, 20s â†’ $120,000' },
      { id: 'poncho',   name: 'Alpaca Poncho',      emoji: 'ðŸ§£', skeinCost: 12000, seconds: 100, basePayout: 600000,  desc: '12,000 skeins, 100s â†’ $600,000' },
      { id: 'vicscarf', name: 'Vicuna Lace Scarf',  emoji: 'ðŸª¶', skeinCost: 25000, seconds: 180, basePayout: 2000000, desc: '25,000 skeins, 3min â†’ $2,000,000' },
    ],
    studioUpgrade: [
      { id: 'andeanblock', name: 'Andean Blocking Kit', emoji: 'ðŸ”ï¸', baseCost: 300000, desc: 'Doubles Peruvian project payouts', oneTime: true },
    ],
  },
  {
    id: 'iceland', name: 'Iceland', flag: 'ðŸ‡®ðŸ‡¸', cost: 5000000, desc: 'Viking wool & Lopi traditions',
    mapX: 30, mapY: 20, pinColor: '#7aaac4',
    animals: [
      { id: 'icelandic',   name: 'Icelandic Sheep', emoji: 'ðŸ‘', baseCost: 40000,  fiberPerSec: 300, desc: '+300 fiber/s â€” Dual-coated: tog & thel' },
      { id: 'leadersheep', name: 'Leader Sheep',     emoji: 'ðŸ', baseCost: 200000, fiberPerSec: 800, desc: '+800 fiber/s â€” Ancient and intelligent' },
    ],
    millProcessing: [
      { id: 'lopimill', name: 'Lopi Spinning Mill', emoji: 'ðŸŒ€', baseCost: 150000, processPerSec: 500, desc: '+500 fiberâ†’skein/s' },
    ],
    millDye: null,
    shopUpgrades: [
      { id: 'reykshop', name: 'Reykjavik Wool Shop', emoji: 'ðŸª', baseCost: 400000, skeinsPerSec: 120, desc: '+120 skeins sold/s' },
    ],
    studioProjects: [
      { id: 'lopapeysa',  name: 'Lopapeysa Sweater', emoji: 'ðŸ§¥', skeinCost: 10000, seconds: 80,  basePayout: 500000,  desc: '10,000 skeins, 80s â†’ $500,000' },
      { id: 'vikinghood', name: 'Viking Hood',        emoji: 'â›‘ï¸', skeinCost: 5000,  seconds: 40,  basePayout: 200000,  desc: '5,000 skeins, 40s â†’ $200,000' },
      { id: 'iceblanket', name: 'Aurora Blanket',     emoji: 'ðŸŒŒ', skeinCost: 30000, seconds: 200, basePayout: 3000000, desc: '30,000 skeins, 3.3min â†’ $3,000,000' },
    ],
    studioUpgrade: [
      { id: 'hotspring', name: 'Hot Spring Felting', emoji: 'â™¨ï¸', baseCost: 500000, desc: 'Doubles Icelandic project payouts', oneTime: true },
    ],
  },
  {
    id: 'japan', name: 'Japan', flag: 'ðŸ‡¯ðŸ‡µ', cost: 10000000, desc: 'Silk & precision blending',
    mapX: 70, mapY: 32, pinColor: '#c45a6a',
    animals: [
      { id: 'silkmoth', name: 'Silk Moth Colony',      emoji: 'ðŸ¦‹', baseCost: 80000,  fiberPerSec: 400,  desc: '+400 fiber/s â€” Bombyx mori silk' },
      { id: 'akitainu', name: 'Akita Dog (Chiengora)', emoji: 'ðŸ•', baseCost: 300000, fiberPerSec: 1000, desc: '+1000 fiber/s â€” Luxury blend' },
    ],
    millProcessing: [
      { id: 'silkreel', name: 'Silk Reeling Machine', emoji: 'ðŸŽŽ', baseCost: 250000, processPerSec: 800, desc: '+800 fiberâ†’skein/s' },
    ],
    millDye: [
      { id: 'shibori', name: 'Shibori Dyeing', emoji: 'ðŸ”µ', baseCost: 200000, multiplier: 15, desc: 'Skeins worth 15x cash', oneTime: true },
    ],
    shopUpgrades: [
      { id: 'tokyoshop', name: 'Harajuku Yarn Lab', emoji: 'ðŸ™ï¸', baseCost: 800000, skeinsPerSec: 200, desc: '+200 skeins sold/s' },
    ],
    studioProjects: [
      { id: 'furoshiki', name: 'Furoshiki Wrap',     emoji: 'ðŸŽ', skeinCost: 8000,  seconds: 30,  basePayout: 300000,   desc: '8,000 skeins, 30s â†’ $300,000' },
      { id: 'kimono',   name: 'Silk Haori Jacket',  emoji: 'ðŸ‘˜', skeinCost: 20000, seconds: 120, basePayout: 1500000,  desc: '20,000 skeins, 2min â†’ $1,500,000' },
      { id: 'obi',      name: 'Master Obi Belt',    emoji: 'ðŸŽ—ï¸', skeinCost: 50000, seconds: 240, basePayout: 5000000,  desc: '50,000 skeins, 4min â†’ $5,000,000' },
    ],
    studioUpgrade: [
      { id: 'wabisabi', name: 'Wabi-Sabi Finishing', emoji: 'ðŸµ', baseCost: 1000000, desc: 'Doubles Japanese project payouts', oneTime: true },
    ],
  },
  {
    id: 'australia', name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º', cost: 20000000, desc: 'Merino premium & industrial scale',
    mapX: 80, mapY: 66, pinColor: '#b89040',
    animals: [
      { id: 'supermerino', name: 'Superfine Merino', emoji: 'ðŸ‘', baseCost: 150000, fiberPerSec: 600,  desc: '+600 fiber/s â€” <15 micron luxury' },
      { id: 'wombat',      name: 'Fiber Wombat',     emoji: 'ðŸ¦¡', baseCost: 500000, fiberPerSec: 2000, desc: '+2000 fiber/s â€” Adorable bulk producer' },
    ],
    millProcessing: [
      { id: 'megamill', name: 'Mega Processing Plant', emoji: 'ðŸ—ï¸', baseCost: 500000, processPerSec: 1500, desc: '+1500 fiberâ†’skein/s' },
    ],
    millDye: [
      { id: 'eucadye', name: 'Eucalyptus Eco Dye', emoji: 'ðŸŒ¿', baseCost: 400000, multiplier: 20, desc: 'Skeins worth 20x cash', oneTime: true },
    ],
    shopUpgrades: [
      { id: 'sydneyshop', name: 'Sydney Yarn Warehouse', emoji: 'ðŸ¬', baseCost: 1500000, skeinsPerSec: 500, desc: '+500 skeins sold/s' },
    ],
    studioProjects: [
      { id: 'surfscarf', name: 'Surf Scarf',         emoji: 'ðŸ„', skeinCost: 15000, seconds: 40,  basePayout: 800000,   desc: '15,000 skeins, 40s â†’ $800,000' },
      { id: 'outback',   name: 'Outback Vest',       emoji: 'ðŸ¦˜', skeinCost: 30000, seconds: 100, basePayout: 2500000,  desc: '30,000 skeins, 100s â†’ $2,500,000' },
      { id: 'dreaming',  name: 'Dreamtime Tapestry', emoji: 'ðŸŒŸ', skeinCost: 80000, seconds: 300, basePayout: 10000000, desc: '80,000 skeins, 5min â†’ $10,000,000' },
    ],
    studioUpgrade: [
      { id: 'lanolin', name: 'Lanolin Finishing', emoji: 'ðŸ’§', baseCost: 2000000, desc: 'Doubles Australian project payouts', oneTime: true },
    ],
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const state = {
  cash: 50,
  fiber: 0,
  skeins: 0,
  fos: 0,
  owned: {},          // id â†’ count
  dyeMultiplier: 1,
  activeProject: null, // { id, elapsed, duration, payout, emoji }
  activeBuild: null,   // { id, elapsed, duration }
  husbandryTimer: 0,   // ticks since last auto-buy
  autocraftTimer: 0,   // ticks since last auto-craft
  milestonesHit: {},   // id â†’ true
  animalNames: [],     // assigned animal names
  foTypes: {},         // projectId â†’ count of completions
  lastSaveTime: Date.now(),
  currentCountry: 'home',
  unlockedCountries: ['home'],
  animalTiers: {},       // animalId â†’ [tier, tier, ...] array per instance
  abilityCooldowns: {},  // animalId â†’ Date.now() when ready
  activeBuffs: {},       // buffKey â†’ { expiresAt: timestamp }
  goldenFleece: false,   // vicuna next-project-5x flag
};

function getOwned(id) { return state.owned[id] || 0; }
function getCost(baseCost, id) { return Math.floor(baseCost * Math.pow(COST_SCALE, getOwned(id))); }

// â”€â”€ Per-instance tier helpers â”€â”€
function isAnimalId(id) { return !!ANIMAL_POWERS[id]; }

function getAnimalTierArray(id) {
  if (!state.animalTiers[id]) state.animalTiers[id] = [];
  const arr = state.animalTiers[id];
  const owned = getOwned(id);
  while (arr.length < owned) arr.push(0);
  if (arr.length > owned) arr.length = owned;
  return arr;
}

function getInstanceTierCost(animalId, currentTier) {
  if (currentTier >= 3) return Infinity;
  const p = ANIMAL_POWERS[animalId];
  if (!p) return Infinity;
  const u = getAllPastureUpgrades().find(x => x.id === animalId);
  if (!u) return Infinity;
  return Math.floor(u.baseCost * p.tiers.costMultiplier[currentTier]);
}

function upgradeNextInstance(animalId) {
  const tiers = getAnimalTierArray(animalId);
  if (tiers.length === 0) return;
  const minTier = Math.min(...tiers);
  if (minTier >= 3) return;
  const idx = tiers.indexOf(minTier);
  const cost = getInstanceTierCost(animalId, minTier);
  if (state.cash < cost) return;
  state.cash -= cost;
  tiers[idx] = minTier + 1;
  const td = TIER_DEFS[minTier];
  showToast(`â­ ${td.name} tier! +${Math.round(td.fiberBonus * 100)}% fiber`);
  updateUI();
}

// â”€â”€ Country helpers: resolvers (for UI) and aggregators (for tick/rates) â”€â”€
function getActiveCountry() {
  return COUNTRIES.find(c => c.id === state.currentCountry) || COUNTRIES[0];
}

// Aggregators: combine items across ALL unlocked countries (for production)
function getAllPastureUpgrades() {
  const all = [...PASTURE_UPGRADES];
  COUNTRIES.forEach(c => {
    if (c.animals && state.unlockedCountries.includes(c.id)) all.push(...c.animals);
  });
  return all;
}
function getAllMillProcessing() {
  const all = [...MILL_PROCESSING];
  COUNTRIES.forEach(c => {
    if (c.millProcessing && state.unlockedCountries.includes(c.id)) all.push(...c.millProcessing);
  });
  return all;
}
function getAllShopUpgrades() {
  const all = [...SHOP_UPGRADES];
  COUNTRIES.forEach(c => {
    if (c.shopUpgrades && state.unlockedCountries.includes(c.id)) all.push(...c.shopUpgrades);
  });
  return all;
}
function getAllStudioProjects() {
  const all = [...STUDIO_PROJECTS];
  COUNTRIES.forEach(c => {
    if (c.studioProjects && state.unlockedCountries.includes(c.id)) all.push(...c.studioProjects);
  });
  return all;
}

// One-time upgrade check (includes country items)
function isOneTimeUpgrade(id) {
  const sources = [PASTURE_SPECIAL, MILL_DYE, SHOP_SPECIAL, SHOP_FIBER, STUDIO_UPGRADE, STUDIO_SPECIAL];
  COUNTRIES.forEach(c => {
    if (c.millDye) sources.push(c.millDye);
    if (c.studioUpgrade) sources.push(c.studioUpgrade);
  });
  return sources.flat().some(u => u.id === id && u.oneTime);
}

// Recalculate dye multiplier from all owned dye upgrades
function recalcDyeMultiplier() {
  let best = 1;
  MILL_DYE.forEach(d => { if (getOwned(d.id) > 0) best = Math.max(best, d.multiplier); });
  COUNTRIES.forEach(c => {
    if (c.millDye && state.unlockedCountries.includes(c.id)) {
      c.millDye.forEach(d => { if (getOwned(d.id) > 0) best = Math.max(best, d.multiplier); });
    }
  });
  state.dyeMultiplier = best;
}

// Get country-specific studio upgrade multiplier for a project
function getCountryProjectMultiplier(projId) {
  let mult = 1;
  COUNTRIES.forEach(c => {
    if (c.studioProjects && c.studioProjects.some(p => p.id === projId)) {
      if (c.studioUpgrade) {
        c.studioUpgrade.forEach(u => { if (getOwned(u.id) > 0) mult = 2; });
      }
    }
  });
  return mult;
}

// â”€â”€ Passive & Buff Helpers â”€â”€

function getPassiveBonus(animalId) {
  const p = ANIMAL_POWERS[animalId];
  if (!p?.passive) return 0;
  const owned = getOwned(animalId);
  let bonus = 0;
  for (const t of p.passive.thresholds) { if (owned >= t.count) bonus = t.bonus; }
  return bonus;
}

const SHEEP_IDS = ['merino','shetland','blackface','icelandic','leadersheep','supermerino'];

// Type-level passive multiplier (excludes per-instance tier)
function getAnimalPassiveMultiplier(animalId) {
  let mult = 1;
  const p = ANIMAL_POWERS[animalId];
  if (p?.passive?.type === 'self_fiber') mult *= (1 + getPassiveBonus(animalId));
  const leaderBonus = getPassiveBonus('leadersheep');
  if (leaderBonus > 0) mult *= (1 + leaderBonus);
  if (SHEEP_IDS.includes(animalId)) {
    const smBonus = getPassiveBonus('supermerino');
    if (smBonus > 0) mult *= (1 + smBonus);
  }
  return mult;
}

// Total fiber from all instances of an animal type (per-instance tiers + type passives)
function getAnimalTotalFiber(animalId, baseFiberPerSec) {
  const tiers = getAnimalTierArray(animalId);
  if (tiers.length === 0) return 0;
  let sum = 0;
  for (const tier of tiers) {
    const tierMult = tier === 0 ? 1 : 1 + TIER_DEFS[tier - 1].fiberBonus;
    sum += baseFiberPerSec * tierMult;
  }
  return sum * getAnimalPassiveMultiplier(animalId);
}

// Backward-compatible wrapper: average multiplier across instances (for display)
function getAnimalFiberMultiplier(animalId) {
  const tiers = getAnimalTierArray(animalId);
  const owned = tiers.length || 1;
  let tierSum = 0;
  for (const tier of tiers) {
    tierSum += tier === 0 ? 1 : 1 + TIER_DEFS[tier - 1].fiberBonus;
  }
  const avgTier = tiers.length > 0 ? tierSum / owned : 1;
  return avgTier * getAnimalPassiveMultiplier(animalId);
}

function getPassiveShopPriceMultiplier() {
  let mult = 1;
  ['alpaca','silkmoth'].forEach(id => {
    const b = getPassiveBonus(id);
    if (b > 0 && ANIMAL_POWERS[id]?.passive?.type === 'shop_price') mult *= (1 + b);
  });
  return mult;
}

function getPassiveIncomeMultiplier() {
  const b = getPassiveBonus('goat');
  return b > 0 ? 1 + b : 1;
}

function getFlatPassiveFiber() {
  const b = getPassiveBonus('rabbit');
  return b > 0 ? b : 0;
}

function getFlatPassiveCash() {
  const b = getPassiveBonus('wombat');
  return b > 0 ? b : 0;
}

function getMillSpeedMultiplier() {
  const b = getPassiveBonus('huacaya');
  return b > 0 ? 1 + b : 1;
}

function getProjectPayoutMultiplier() {
  const b = getPassiveBonus('shetland');
  return b > 0 ? 1 + b : 1;
}

function isBuffActive(key) {
  const buff = state.activeBuffs[key];
  return buff && Date.now() < buff.expiresAt;
}

function getBuffRemaining(key) {
  const buff = state.activeBuffs[key];
  return buff ? Math.max(0, Math.ceil((buff.expiresAt - Date.now()) / 1000)) : 0;
}

function getAbilityCooldownRemaining(animalId) {
  const readyAt = state.abilityCooldowns[animalId];
  return readyAt ? Math.max(0, Math.ceil((readyAt - Date.now()) / 1000)) : 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const el = (id) => document.getElementById(id);

function flip(paneId) {
  document.getElementById(paneId).classList.toggle('flipped');
}

function pulseVal(element) {
  element.classList.remove('pulse');
  void element.offsetWidth;
  element.classList.add('pulse');
}

function fmt(n) {
  if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e4) return (n / 1e3).toFixed(1) + 'K';
  return n.toLocaleString();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getBuildDuration(cost) {
  let dur = Math.min(4, Math.max(1, Math.ceil(Math.log10(cost)) - 1));
  const bfBonus = getPassiveBonus('blackface');
  if (bfBonus > 0) dur = Math.max(1, Math.round(dur * (1 - bfBonus)));
  return dur;
}

function completeBuild(id) {
  state.owned[id] = getOwned(id) + 1;
  if (isAnimalId(id)) {
    if (!state.animalTiers[id]) state.animalTiers[id] = [];
    state.animalTiers[id].push(0);
  }
  recalcDyeMultiplier();
}

function startBuild(id, baseCost) {
  if (state.activeBuild) return;
  const oneTime = isOneTimeUpgrade(id);
  if (oneTime && getOwned(id) > 0) return;
  const cost = oneTime ? baseCost : getCost(baseCost, id);
  if (state.cash < cost) return;
  state.cash -= cost;
  state.activeBuild = {
    id,
    elapsed: 0,
    duration: getBuildDuration(cost),
  };
  updateUI();
}

function sellFiber() {
  const amount = Math.min(10, state.fiber);
  if (amount <= 0) return;
  state.fiber -= amount;
  state.cash += amount * 2;
  updateUI();
}

function startProject(proj) {
  if (state.activeProject) return;
  if (state.skeins < proj.skeinCost) return;
  state.skeins -= proj.skeinCost;
  const blockingMult = getOwned('blocking') > 0 ? 2 : 1;
  const countryMult = getCountryProjectMultiplier(proj.id);
  state.activeProject = {
    id: proj.id,
    elapsed: 0,
    duration: proj.seconds,
    payout: proj.basePayout * blockingMult * countryMult * state.dyeMultiplier,
    emoji: proj.emoji,
    name: proj.name,
  };
  updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderUpgradeRow(u) {
  const owned = getOwned(u.id);
  const isOneTime = u.oneTime;
  const bought = isOneTime && owned > 0;
  const cost = isOneTime ? u.baseCost : getCost(u.baseCost, u.id);
  const building = state.activeBuild !== null;
  const isThisBuild = building && state.activeBuild.id === u.id;
  const canAfford = state.cash >= cost && !bought && !building;

  const row = document.createElement('div');
  row.className = 'upgrade-row';

  let actionHtml;
  if (isThisBuild) {
    const pct = Math.min(100, (state.activeBuild.elapsed / state.activeBuild.duration) * 100);
    actionHtml = `<div class="u-build-bar"><div class="u-build-fill" style="width:${pct}%"></div></div>`;
  } else if (bought) {
    actionHtml = `<button class="u-buy one-time-bought" disabled>Owned</button>`;
  } else {
    actionHtml = `<button class="u-buy" ${!canAfford ? 'disabled' : ''}>${building ? '...' : '$' + fmt(cost)}</button>`;
  }

  // Tier pips for animals
  let tierHtml = '';
  if (isAnimalId(u.id) && owned > 0) {
    const tiers = getAnimalTierArray(u.id);
    const TIER_COLORS = ['#999', '#cd7f32', '#c0c0c0', '#ffd700'];
    tierHtml = '<span class="u-tier-dots">' +
      tiers.map(t => `<span class="u-tier-pip" style="background:${TIER_COLORS[t]}"></span>`).join('') +
      '</span>';
  }

  row.innerHTML = `
    <span class="u-emoji">${icon(u.id, 22) || u.emoji}</span>
    <div class="u-info">
      <div class="u-name">${u.name}</div>
      <div class="u-desc">${u.desc}</div>
    </div>
    ${tierHtml}
    ${!isOneTime ? `<span class="u-owned ${owned > 0 ? 'has' : ''}">${owned}</span>` : ''}
    ${actionHtml}
  `;
  if (!bought && !isThisBuild && !building) {
    row.querySelector('.u-buy').addEventListener('click', () => startBuild(u.id, u.baseCost));
  }
  return row;
}

function renderProjectRow(proj) {
  const canStart = !state.activeProject && state.skeins >= proj.skeinCost;
  const isActive = state.activeProject && state.activeProject.id === proj.id;
  const blockingMult = getOwned('blocking') > 0 ? 2 : 1;
  const countryMult = getCountryProjectMultiplier(proj.id);
  const effectivePayout = proj.basePayout * blockingMult * countryMult * state.dyeMultiplier;

  const row = document.createElement('div');
  row.className = 'upgrade-row';
  row.innerHTML = `
    <span class="u-emoji">${icon(proj.id, 22) || proj.emoji}</span>
    <div class="u-info">
      <div class="u-name">${proj.name}</div>
      <div class="u-desc">${proj.skeinCost} skeins, ${proj.seconds}s â†’ $${fmt(effectivePayout)}</div>
    </div>
    <button class="u-buy" ${!canStart ? 'disabled' : ''}>${isActive ? 'Working...' : 'Craft'}</button>
  `;
  if (canStart) {
    row.querySelector('.u-buy').addEventListener('click', () => startProject(proj));
  }
  return row;
}

function renderSellFiberRow() {
  const amount = Math.min(10, state.fiber);
  const row = document.createElement('div');
  row.className = 'upgrade-row';
  row.innerHTML = `
    <span class="u-emoji">${icon('fiber', 22) || 'ðŸŒ¿'}</span>
    <div class="u-info">
      <div class="u-name">Sell Fiber</div>
      <div class="u-desc">Sell up to 10 fiber at $2 each</div>
    </div>
    <button class="sell-btn" ${amount <= 0 ? 'disabled' : ''}>Sell ${amount > 0 ? amount : 0}</button>
  `;
  if (amount > 0) {
    row.querySelector('.sell-btn').addEventListener('click', () => sellFiber());
  }
  return row;
}

function renderPane(containerId, rateSummaryId, sections) {
  const body = el(containerId);

  // preserve the rate summary element
  while (body.children.length > 1) body.removeChild(body.lastChild);

  sections.forEach(section => {
    if (section.label) {
      const lbl = document.createElement('div');
      lbl.className = 'section-label';
      lbl.textContent = section.label;
      body.appendChild(lbl);
    }
    if (section.custom) {
      body.appendChild(section.custom());
      return;
    }
    section.items.forEach(item => {
      if (section.type === 'project') {
        body.appendChild(renderProjectRow(item));
      } else {
        body.appendChild(renderUpgradeRow(item));
      }
    });
  });
}

function renderStudioProgress() {
  const body = el('studio-body');
  const existing = body.querySelector('.progress-wrap');
  const existingStatus = body.querySelector('.project-status');

  if (state.activeProject) {
    const pct = Math.min(100, (state.activeProject.elapsed / state.activeProject.duration) * 100);

    if (!existing) {
      // insert progress bar after rate summary
      const wrap = document.createElement('div');
      wrap.className = 'progress-wrap';
      wrap.innerHTML = `<div class="progress-bar"></div><div class="progress-text"></div>`;
      body.children[0].after(wrap);

      const status = document.createElement('div');
      status.className = 'project-status';
      wrap.after(status);
    }

    const wrap = body.querySelector('.progress-wrap');
    const bar = wrap.querySelector('.progress-bar');
    const text = wrap.querySelector('.progress-text');
    const status = body.querySelector('.project-status');

    bar.style.width = pct + '%';
    text.textContent = `${state.activeProject.name} â€” ${Math.round(pct)}%`;
    const remaining = state.activeProject.duration - state.activeProject.elapsed;
    status.textContent = remaining > 0 ? `${remaining}s remaining â†’ $${fmt(state.activeProject.payout)}` : 'Complete!';
  } else {
    if (existing) existing.remove();
    if (existingStatus) existingStatus.remove();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTRY BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchCountry(id) {
  if (!state.unlockedCountries.includes(id)) return;
  state.currentCountry = id;
  updateUI();
}

function unlockCountry(id) {
  const country = COUNTRIES.find(c => c.id === id);
  if (!country) return;
  const discount = isBuffActive('country_discount') ? 0.80 : 1;
  const cost = Math.floor(country.cost * discount);
  if (state.cash < cost) return;
  if (state.unlockedCountries.includes(id)) return;
  state.cash -= cost;
  state.unlockedCountries.push(id);
  state.currentCountry = id;
  showToast(`${country.flag} ${country.name} unlocked!`);
  updateUI();
}

let mapInitialized = false;
function updateCountryBar() {
  const bar = el('country-bar');
  const showBar = state.unlockedCountries.length > 1 || state.cash >= 1000000;
  bar.style.display = showBar ? 'block' : 'none';
  document.querySelector('.grid').classList.toggle('with-country-bar', showBar);
  if (!showBar) return;

  // One-time: render the decorative background
  if (!mapInitialized) {
    mapInitialized = true;
    bar.innerHTML = `
      <svg class="map-svg" viewBox="0 0 200 100" preserveAspectRatio="none">
        <path d="M0,85 Q25,70 50,80 T100,75 T150,80 T200,70 L200,100 L0,100 Z" fill="rgba(139,125,96,.06)"/>
        <path d="M0,90 Q30,78 60,88 T120,82 T180,88 T200,80 L200,100 L0,100 Z" fill="rgba(139,125,96,.08)"/>
      </svg>
      <svg class="map-yarn-trail" viewBox="0 0 100 100" preserveAspectRatio="none" id="yarn-trails"></svg>
    `;
  }

  // Remove old pins (keep SVGs)
  bar.querySelectorAll('.map-pin').forEach(p => p.remove());

  // Compute evenly spaced positions for pins
  const total = COUNTRIES.length;
  const positions = COUNTRIES.map((_, i) => ({
    x: 8 + i * (84 / (total - 1)),
    y: 50 + (i % 2 === 0 ? -8 : 8)
  }));

  // Draw yarn trails between unlocked countries
  const trails = el('yarn-trails');
  trails.innerHTML = '';
  const unlockedIdxs = COUNTRIES.map((c, i) => state.unlockedCountries.includes(c.id) ? i : -1).filter(i => i >= 0);
  for (let j = 1; j < unlockedIdxs.length; j++) {
    const a = positions[unlockedIdxs[j - 1]], b = positions[unlockedIdxs[j]];
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', a.x); line.setAttribute('y1', a.y);
    line.setAttribute('x2', b.x); line.setAttribute('y2', b.y);
    trails.appendChild(line);
  }

  // Render pins
  COUNTRIES.forEach((c, i) => {
    const pos = positions[i];
    const isUnlocked = state.unlockedCountries.includes(c.id);
    const isActive = state.currentCountry === c.id;
    const discount = isBuffActive('country_discount') ? 0.80 : 1;
    const cost = Math.floor(c.cost * discount);
    const canAfford = state.cash >= cost;

    const pin = document.createElement('div');
    pin.className = 'map-pin' + (isActive ? ' active' : '') + (!isUnlocked ? ' locked' : '') + (!isUnlocked && canAfford ? ' affordable' : '');
    pin.style.left = pos.x + '%';
    pin.style.top = pos.y + '%';

    const color = isUnlocked ? (c.pinColor || 'var(--accent)') : '#999';
    pin.innerHTML = `
      <div class="pin-marker">
        <svg viewBox="0 0 20 26"><path d="M10 0C4.5 0 0 4.5 0 10c0 7.5 10 16 10 16s10-8.5 10-16C20 4.5 15.5 0 10 0z" fill="${color}"/><circle cx="10" cy="9" r="5" fill="rgba(255,255,255,.5)"/></svg>
        <span class="pin-flag"></span>
      </div>
      <span class="pin-label">${c.name}</span>
      ${!isUnlocked ? `<span class="pin-cost">${discount < 1 ? '<s>$'+fmt(c.cost)+'</s> ' : ''}$${fmt(cost)}</span>` : ''}
    `;

    if (isUnlocked) {
      pin.addEventListener('click', () => switchCountry(c.id));
    } else if (canAfford) {
      pin.addEventListener('click', () => unlockCountry(c.id));
    }
    bar.appendChild(pin);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateUI() {
  // global resources
  const ids = ['res-cash', 'res-fiber', 'res-skeins', 'res-fos'];
  const vals = ['$' + fmt(state.cash), fmt(state.fiber), fmt(state.skeins), fmt(state.fos)];
  ids.forEach((id, i) => {
    const e = el(id);
    const prev = e.textContent;
    e.textContent = vals[i];
    if (prev !== vals[i]) pulseVal(e);
  });

  const country = getActiveCountry();

  // â”€â”€ Pasture â”€â”€ (shows effective fiber rate with passives/tiers)
  let fiberRate = 0;
  getAllPastureUpgrades().forEach(u => { fiberRate += getAnimalTotalFiber(u.id, u.fiberPerSec); });
  fiberRate += getFlatPassiveFiber();
  fiberRate = Math.floor(fiberRate);
  el('rate-pasture').textContent = `+${fmt(fiberRate)} fiber/s`;
  const pastureSections = [];
  if (state.currentCountry === 'home') {
    pastureSections.push({ items: PASTURE_UPGRADES });
  } else if (country.animals) {
    pastureSections.push({ label: country.name + ' Animals', items: country.animals });
  }
  pastureSections.push({ label: 'Special', items: PASTURE_SPECIAL });
  renderPane('pasture-body', 'rate-pasture', pastureSections);

  // â”€â”€ Mill â”€â”€ (shows effective rate with mill speed passive)
  const millSpd = getMillSpeedMultiplier();
  const processRate = Math.floor(getAllMillProcessing().reduce((s, u) => s + getOwned(u.id) * u.processPerSec, 0) * millSpd);
  el('rate-mill').textContent = `Processing: ${fmt(processRate)} fiber â†’ ${fmt(processRate)} skeins/s` +
    (state.dyeMultiplier > 1 ? ` (${state.dyeMultiplier}x dye!)` : '');
  const millSections = [
    { label: 'Processing', items: MILL_PROCESSING },
  ];
  if (country.millProcessing) millSections.push({ label: country.name + ' Processing', items: country.millProcessing });
  millSections.push({ label: 'Dyeing', items: MILL_DYE });
  if (country.millDye) millSections.push({ label: country.name + ' Dyeing', items: country.millDye });
  renderPane('mill-body', 'rate-mill', millSections);

  // â”€â”€ Shop â”€â”€ (shows effective rate with passive multipliers)
  const sellRate = getAllShopUpgrades().reduce((s, u) => s + getOwned(u.id) * u.skeinsPerSec, 0);
  const shopPriceMult = getPassiveShopPriceMultiplier() * getPassiveIncomeMultiplier();
  const pricePerSkein = Math.floor(5 * state.dyeMultiplier * shopPriceMult);
  const cashRate = sellRate * pricePerSkein + Math.floor((getOwned('sable') > 0 ? 500 : 0) * getPassiveIncomeMultiplier()) + Math.floor(getFlatPassiveCash() * getPassiveIncomeMultiplier());
  el('rate-shop').textContent = `Selling: ${fmt(sellRate)} skeins/s â€” $${fmt(cashRate)}/s`;
  const shopSections = [
    { label: 'Fiber Sales', items: SHOP_FIBER },
    { custom: renderSellFiberRow },
    { label: 'Sales Upgrades', items: SHOP_UPGRADES },
  ];
  if (country.shopUpgrades) shopSections.push({ label: country.name + ' Sales', items: country.shopUpgrades });
  shopSections.push({ label: 'Special', items: SHOP_SPECIAL });
  renderPane('shop-body', 'rate-shop', shopSections);

  // â”€â”€ Studio â”€â”€
  if (state.activeProject) {
    const remaining = state.activeProject.duration - state.activeProject.elapsed;
    el('rate-studio').textContent = `Crafting: ${state.activeProject.name} (${remaining}s)`;
  } else {
    el('rate-studio').textContent = 'No project in progress';
  }
  const studioSections = [
    { label: 'Projects', type: 'project', items: STUDIO_PROJECTS },
  ];
  if (country.studioProjects) studioSections.push({ label: country.name + ' Projects', type: 'project', items: country.studioProjects });
  studioSections.push({ label: 'Upgrades', items: STUDIO_UPGRADE });
  if (country.studioUpgrade) studioSections.push({ label: country.name + ' Upgrades', items: country.studioUpgrade });
  studioSections.push({ label: 'Special', items: STUDIO_SPECIAL });
  renderPane('studio-body', 'rate-studio', studioSections);
  renderStudioProgress();

  // â”€â”€ Update all card backs â”€â”€
  updatePastureBack();
  updateMillBack();
  updateCityMap();
  updateStudioBack();

  // â”€â”€ Country bar â”€â”€
  updateCountryBar();

  // â”€â”€ Active buff indicators â”€â”€
  updateBuffIndicators();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUFF INDICATORS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const BUFF_LABELS = {
  double_all_production: { emoji:'ðŸ’¨', label:'2x All' },
  triple_fiber:          { emoji:'ðŸŒªï¸', label:'3x Fiber' },
  double_fiber:          { emoji:'âœ‚ï¸', label:'2x Fiber' },
  double_shop_price:     { emoji:'ðŸ’ƒ', label:'2x Shop' },
  fast_autocraft:        { emoji:'âš”ï¸', label:'Fast Craft' },
  country_discount:      { emoji:'ðŸ§­', label:'-20% Countries' },
};

function updateBuffIndicators() {
  const container = el('buff-indicators');
  const now = Date.now();
  const activeKeys = Object.keys(state.activeBuffs).filter(k => now < state.activeBuffs[k].expiresAt);
  const parts = [];
  activeKeys.forEach(key => {
    const info = BUFF_LABELS[key] || { emoji:'âš¡', label:key };
    const remaining = Math.ceil((state.activeBuffs[key].expiresAt - now) / 1000);
    parts.push(`<span class="buff-pill">${info.emoji} ${info.label} ${remaining}s</span>`);
  });
  if (state.goldenFleece) {
    parts.push('<span class="buff-pill">ðŸŒŸ Golden Fleece (next project)</span>');
  }
  container.innerHTML = parts.join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD BACK RENDERERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Pasture: rolling hills with animals + day/night sky â”€â”€
let pastureAnimalEls = []; // stable pool of DOM elements
let pastureAnimalKey = ''; // serialised count key to detect changes
let farmerEl = null;       // farmer span when husbander is owned

function randomAnimalPos() {
  return { left: 5 + Math.random() * 85, top: 10 + Math.random() * 65 };
}

function wanderAnimals() {
  pastureAnimalEls.forEach(span => {
    const prevLeft = parseFloat(span.style.left) || 50;
    const pos = randomAnimalPos();
    span.style.transform = pos.left > prevLeft ? 'scaleX(-1)' : 'scaleX(1)';
    span.style.left = pos.left + '%';
    span.style.top = pos.top + '%';
  });
  // farmer wanders too
  if (farmerEl) {
    const prevLeft = parseFloat(farmerEl.style.left) || 50;
    const pos = randomAnimalPos();
    farmerEl.style.transform = pos.left > prevLeft ? 'scaleX(-1)' : 'scaleX(1)';
    farmerEl.style.left = pos.left + '%';
    farmerEl.style.top = pos.top + '%';
  }
}

function updatePastureBack() {
  // Sky colour based on real time
  const hour = new Date().getHours();
  let skyColor;
  if (hour >= 6 && hour < 8) skyColor = 'linear-gradient(180deg,#fdd8a5 0%,#fceabb 50%,#d6e2c8 100%)'; // dawn
  else if (hour >= 8 && hour < 17) skyColor = 'linear-gradient(180deg,#a8d0e6 0%,#d6e8f0 40%,#e4ecda 100%)'; // day
  else if (hour >= 17 && hour < 20) skyColor = 'linear-gradient(180deg,#e8a87c 0%,#ddb892 40%,#d6e2c8 100%)'; // sunset
  else skyColor = 'linear-gradient(180deg,#2c3e6b 0%,#4a5a80 40%,#6b7a60 100%)'; // night
  el('pasture-sky').style.background = skyColor;

  // Build desired animal list (current country only)
  const country = getActiveCountry();
  const visibleAnimals = state.currentCountry === 'home' ? PASTURE_UPGRADES : (country.animals || []);
  const desired = [];
  let total = 0;
  visibleAnimals.forEach(u => {
    const count = getOwned(u.id);
    const tiers = getAnimalTierArray(u.id);
    const show = Math.min(count, 8);
    for (let i = 0; i < show; i++) desired.push({ emoji: u.emoji, id: u.id, tier: tiers[i] || 0 });
    total += count;
  });

  // Only rebuild DOM if animal counts/tiers changed
  const key = desired.map(d => d.emoji + d.id + d.tier).join(',');
  if (key !== pastureAnimalKey) {
    pastureAnimalKey = key;
    const container = el('pasture-animals');
    container.innerHTML = '';
    pastureAnimalEls = [];
    // assign names â€” grow the list as needed
    while (state.animalNames.length < desired.length) {
      const nameIdx = state.animalNames.length % ANIMAL_NAMES.length;
      state.animalNames.push(ANIMAL_NAMES[nameIdx]);
    }
    desired.forEach((d, i) => {
      const span = document.createElement('span');
      span.className = 'scene-animal';
      if (d.tier > 0) span.classList.add('tier-' + d.tier);
      span.innerHTML = icon(d.id, 22) || d.emoji;
      span.title = state.animalNames[i] + (d.tier > 0 ? ' (' + TIER_DEFS[d.tier - 1].name + ')' : '');
      span.dataset.animalId = d.id;
      span.dataset.animalIndex = i;
      const pos = randomAnimalPos();
      span.style.left = pos.left + '%';
      span.style.top = pos.top + '%';
      container.appendChild(span);
      pastureAnimalEls.push(span);
    });
  }

  // Farmer appears when husbander is owned
  const container2 = el('pasture-animals');
  if (getOwned('husbander') > 0 && !farmerEl) {
    farmerEl = document.createElement('span');
    farmerEl.className = 'scene-farmer';
    farmerEl.innerHTML = icon('husbander', 22) || 'ðŸ‘¨â€ðŸŒ¾';
    farmerEl.title = 'The Husbander';
    const fpos = randomAnimalPos();
    farmerEl.style.left = fpos.left + '%';
    farmerEl.style.top = fpos.top + '%';
    container2.appendChild(farmerEl);
  } else if (getOwned('husbander') === 0 && farmerEl) {
    farmerEl.remove();
    farmerEl = null;
  }

  const info = el('pasture-info');
  if (total > 0 && state.animalNames.length > 0) {
    const featuredName = state.animalNames[Math.floor(Math.random() * Math.min(total, state.animalNames.length))];
    const others = total - 1;
    info.textContent = others > 0 ? `${featuredName} and ${others} friend${others !== 1 ? 's' : ''} grazing` : `${featuredName} is grazing`;
  } else {
    info.textContent = 'Your pasture awaits...';
  }
}

// â”€â”€ Mill: conveyor dots that flow when processing â”€â”€
let conveyorInterval = null;
let lastProcessRate = -1;
let lastMillFiber = -1;
let lastMillSkeins = -1;
function updateMillBack() {
  const processRate = getAllMillProcessing().reduce((s, u) => s + getOwned(u.id) * u.processPerSec, 0);
  el('mill-rate-label').textContent = processRate > 0
    ? `Spinning ${fmt(processRate)} fiber/s`
    : 'No equipment yet';

  // Wheel visibility
  const wheel = el('mill-wheel');
  wheel.style.opacity = processRate > 0 ? '1' : '.25';
  wheel.style.animationDuration = processRate > 10 ? '1.5s' : '3s';

  // Fiber & skein piles
  const fiberCount = Math.min(5, Math.ceil(state.fiber / 50));
  const skeinCount = Math.min(5, Math.ceil(state.skeins / 50));
  if (fiberCount !== lastMillFiber) {
    lastMillFiber = fiberCount;
    const pile = el('mill-fiber-pile');
    pile.innerHTML = '';
    for (let i = 0; i < fiberCount; i++) pile.insertAdjacentHTML('beforeend', '<span>' + (icon('fiber', 16) || 'ðŸŒ¿') + '</span>');
  }
  if (skeinCount !== lastMillSkeins) {
    lastMillSkeins = skeinCount;
    const pile = el('mill-skein-pile');
    pile.innerHTML = '';
    for (let i = 0; i < skeinCount; i++) pile.insertAdjacentHTML('beforeend', '<span>' + (icon('skeins', 16) || 'ðŸ§¶') + '</span>');
  }

  // Dye vat
  const hasDye = getOwned('kettle') > 0 || getOwned('speckle') > 0;
  const vat = el('mill-dye-vat');
  vat.innerHTML = getOwned('speckle') > 0 ? (icon('speckle', 28) || 'ðŸŽ¨') : (icon('kettle', 28) || 'ðŸ«•');
  vat.classList.toggle('active', hasDye);

  // Manage conveyor dots â€” only update if rate changed
  if (processRate !== lastProcessRate) {
    lastProcessRate = processRate;
    if (conveyorInterval) clearInterval(conveyorInterval);
    const conveyor = el('mill-conveyor');
    conveyor.querySelectorAll('.conv-dot').forEach(d => d.remove());
    if (processRate > 0) {
      const spawnRate = Math.max(300, 2000 / Math.min(processRate, 20));
      conveyorInterval = setInterval(() => {
        const dot = document.createElement('div');
        dot.className = 'conv-dot';
        dot.style.animationDuration = (1.5 + Math.random()) + 's';
        dot.style.top = (30 + Math.random() * 40) + '%';
        conveyor.appendChild(dot);
        setTimeout(() => dot.remove(), 3000);
      }, spawnRate);
    }
  }
}

// â”€â”€ Shop: Yarn District City Map â”€â”€
const YARN_COLORS = ['#d4a5a5','#c4b7d4','#b5c4a8','#f0d6a8','#a8c4d4','#d4c4a8','#c4a8b8','#a8b8c4','#d4b8a8','#b8d4c0'];
const CUSTOMER_EMOJIS = ['ðŸ§‘â€ðŸ¦°','ðŸ‘©â€ðŸ¦±','ðŸ§“','ðŸ‘©','ðŸ‘¨â€ðŸ¦³','ðŸ§‘â€ðŸ¦²','ðŸ‘©â€ðŸ¦°','ðŸ‘¨'];
let cityBuildingKey = '';
let cityFoKey = '';

function buildCityBuilding(shop) {
  const windowCount = shop.size === 'large' ? 4 : shop.size === 'medium' ? 2 : 1;
  let windows = '';
  for (let i = 0; i < windowCount; i++) windows += '<div class="city-building-window"></div>';
  const chimney = shop.chimneySmoke
    ? '<div class="city-chimney"><div class="city-smoke"></div></div>' : '';
  return `
    <div class="city-building-glow" style="background:radial-gradient(circle,${shop.buildingColor}55 0%,transparent 70%)"></div>
    <div style="position:relative">
      ${chimney}
      <div class="city-building-roof" style="background:${shop.roofColor}"></div>
      <div class="city-building-body" style="background:${shop.buildingColor}">
        ${windows}
        <div class="city-building-door"></div>
      </div>
    </div>
    <div class="city-building-sign">${shop.name}</div>
  `;
}

function updateCityMap() {
  const container = el('city-buildings');
  const visible = CITY_SHOPS.filter(s => s.openCondition());
  const key = visible.map(s => s.id).join(',');

  if (key !== cityBuildingKey) {
    cityBuildingKey = key;
    container.innerHTML = '';
    visible.forEach(shop => {
      const bldg = document.createElement('div');
      const isActive = shop.upgradeIds.some(id => getOwned(id) > 0);
      bldg.className = 'city-building ' + shop.size + (isActive ? ' active' : ' idle');
      bldg.dataset.shopId = shop.id;
      bldg.style.left = shop.mapX + '%';
      bldg.style.top = shop.mapY + '%';
      bldg.style.setProperty('--bldg-glow', shop.buildingColor + '88');
      bldg.innerHTML = buildCityBuilding(shop);
      bldg.addEventListener('click', () => openShopDetail(shop.id));
      container.appendChild(bldg);
    });
  } else {
    container.querySelectorAll('.city-building').forEach(bldg => {
      const shop = CITY_SHOPS.find(s => s.id === bldg.dataset.shopId);
      if (shop) {
        const isActive = shop.upgradeIds.some(id => getOwned(id) > 0);
        bldg.classList.toggle('active', isActive);
        bldg.classList.toggle('idle', !isActive);
      }
    });
  }

  // City info bar: status + FO display
  const totalShops = visible.length;
  const activeShops = visible.filter(s => s.upgradeIds.some(id => getOwned(id) > 0)).length;
  const sellRate = getAllShopUpgrades().reduce((s, u) => s + getOwned(u.id) * u.skeinsPerSec, 0);
  let infoHTML = '';
  if (sellRate > 0) {
    infoHTML = `<span>${activeShops}/${totalShops} shops open \u2014 ${fmt(sellRate)} skeins/s</span>`;
  } else if (totalShops > 0) {
    infoHTML = '<span>Your yarn district is taking shape...</span>';
  } else {
    infoHTML = '<span>Your yarn district awaits...</span>';
  }
  const foKey = JSON.stringify(state.foTypes);
  if (foKey !== cityFoKey) {
    cityFoKey = foKey;
  }
  let foHTML = '';
  getAllStudioProjects().forEach(proj => {
    const count = state.foTypes[proj.id] || 0;
    if (count > 0) {
      foHTML += `<span class="fo-item" title="${proj.name}">${icon(proj.id, 12) || proj.emoji}<span class="fo-badge">x${count}</span></span>`;
    }
  });
  infoHTML += foHTML;
  el('city-info').innerHTML = infoHTML;
}

function spawnCityCustomer() {
  const sellRate = getAllShopUpgrades().reduce((s, u) => s + getOwned(u.id) * u.skeinsPerSec, 0);
  if (sellRate <= 0) return;
  const ambient = el('city-ambient');
  if (ambient.children.length > 5) return;
  const c = document.createElement('span');
  c.className = 'city-customer';
  c.textContent = CUSTOMER_EMOJIS[Math.floor(Math.random() * CUSTOMER_EMOJIS.length)];
  const dur = 4 + Math.random() * 3;
  c.style.setProperty('--walk-dur', dur + 's');
  c.style.bottom = (8 + Math.random() * 30) + '%';
  ambient.appendChild(c);
  setTimeout(() => c.remove(), (dur + 1) * 1000);
}

// â”€â”€ Shop Detail Modal â”€â”€

function makeShopSection(emoji, title, contentHTML) {
  const sec = document.createElement('div');
  sec.className = 'shop-section';
  sec.innerHTML = `
    <div class="shop-section-icon">${emoji}</div>
    <div class="shop-section-body">
      <div class="shop-section-label">${title}</div>
      <div class="shop-section-content">${contentHTML}</div>
    </div>
  `;
  return sec;
}

function openShopDetail(shopId) {
  const shop = CITY_SHOPS.find(s => s.id === shopId);
  if (!shop) return;

  const detail = el('shop-detail');
  detail.style.setProperty('--shop-color', shop.buildingColor);
  detail.style.setProperty('--shop-roof', shop.roofColor);

  // Header
  el('shop-detail-header').innerHTML = `
    <div class="shop-detail-emoji">${shop.chimneySmoke ? '\u2615' : shop.size === 'large' ? '\ud83c\udfdb\ufe0f' : '\ud83c\udfea'}</div>
    <div class="shop-detail-name">${shop.name}</div>
    <div class="shop-detail-tagline">${shop.flavorText}</div>
  `;

  // Scene: mini shelf with yarn balls + browsing customers
  const scene = el('shop-detail-scene');
  scene.style.background = `linear-gradient(180deg,${shop.buildingColor} 0%,rgba(255,255,255,.3) 100%)`;
  let sceneHTML = '<div class="shop-detail-shelf">';
  const ballCount = Math.min(Math.max(5, Math.floor(state.skeins / 20)), 25);
  for (let i = 0; i < ballCount; i++) {
    sceneHTML += `<div class="shop-mini-ball" style="background:${YARN_COLORS[i % YARN_COLORS.length]};animation-delay:${(-Math.random() * 2).toFixed(1)}s"></div>`;
  }
  sceneHTML += '</div>';
  const custCount = 2 + Math.floor(Math.random() * 2);
  for (let i = 0; i < custCount; i++) {
    const cEmoji = CUSTOMER_EMOJIS[Math.floor(Math.random() * CUSTOMER_EMOJIS.length)];
    const left = 15 + Math.random() * 60;
    const dur = 2.5 + Math.random() * 2;
    sceneHTML += `<div class="shop-mini-customer" style="left:${left}%;--browse-dur:${dur.toFixed(1)}s;animation-delay:${(-Math.random() * 2).toFixed(1)}s">${cEmoji}</div>`;
  }
  scene.innerHTML = sceneHTML;

  // Sections
  const sections = el('shop-detail-sections');
  sections.innerHTML = '';

  // Inventory
  const ownedCount = shop.upgradeIds.reduce((sum, id) => sum + getOwned(id), 0);
  const invName = shop.upgradeIds.map(id => {
    const u = getAllShopUpgrades().find(x => x.id === id) || { name: id };
    return u.name;
  }).join(', ');
  const invHTML = ownedCount > 0
    ? `<div>${invName} (${ownedCount} owned)</div>`
    : `<div class="shop-stat-dim">Buy <strong>${invName}</strong> from the shop to get started!</div>`;
  sections.appendChild(makeShopSection('\ud83e\uddf6', 'Inventory', invHTML));

  // Now Playing
  const song = shop.music[Math.floor(Math.random() * shop.music.length)];
  sections.appendChild(makeShopSection('\ud83c\udfb5', 'Now Playing',
    `<span class="shop-music-note">\u266a</span><em>${song}</em>`));

  // Events This Month
  const eventHTML = shop.events.map(e => `<div class="shop-event-item">\ud83d\udcc5 ${e}</div>`).join('');
  sections.appendChild(makeShopSection('\ud83d\udccb', 'This Month', eventHTML));

  // Revenue
  const revenue = shop.upgradeIds.reduce((sum, id) => {
    const u = getAllShopUpgrades().find(x => x.id === id);
    return sum + (u ? getOwned(id) * (u.skeinsPerSec || 0) : 0);
  }, 0);
  const shopMult = getPassiveShopPriceMultiplier();
  const incomeMult = getPassiveIncomeMultiplier();
  const cashPerSec = revenue > 0 ? Math.floor(revenue * 5 * state.dyeMultiplier * shopMult * incomeMult) : 0;
  const revHTML = revenue > 0
    ? `<div class="shop-stat">${fmt(revenue)} skeins/s \u2014 $${fmt(cashPerSec)}/s</div>`
    : `<div class="shop-stat-dim">Purchase <strong>${invName}</strong> from the shop front to start selling!</div>`;
  sections.appendChild(makeShopSection('\ud83d\udcb0', 'Revenue', revHTML));

  el('shop-overlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeShopDetail() {
  el('shop-overlay').classList.remove('active');
  document.body.style.overflow = '';
}

// â”€â”€ Studio: fabric grows with project progress, confetti on completion â”€â”€
let lastStudioFoKey = '';
function updateStudioBack() {
  const fabric = el('studio-fabric');
  const label = el('studio-back-label');
  const foCount = el('studio-fo-count');
  const yarnBall = el('studio-yarn-ball');

  if (state.activeProject) {
    const pct = state.activeProject.elapsed / state.activeProject.duration;
    const maxH = 65;
    fabric.style.height = Math.floor(pct * maxH) + 'px';
    const neededLines = Math.floor(pct * 10);
    while (fabric.children.length < neededLines) {
      const line = document.createElement('div');
      line.className = 'stitch-line';
      fabric.appendChild(line);
    }
    label.textContent = `Knitting: ${state.activeProject.name}...`;
    // Yarn ball shrinks as project progresses
    const scale = 1 - pct * 0.8;
    yarnBall.style.transform = `scale(${scale.toFixed(2)})`;
    yarnBall.style.opacity = '1';
  } else {
    fabric.style.height = '0px';
    fabric.innerHTML = '';
    label.textContent = 'Waiting for a project...';
    yarnBall.style.transform = 'scale(1)';
    yarnBall.style.opacity = state.fos > 0 ? '.4' : '1';
  }

  foCount.textContent = state.fos > 0 ? `${state.fos} finished object${state.fos !== 1 ? 's' : ''} crafted` : '';

  // FO gallery
  const foKey = JSON.stringify(state.foTypes);
  if (foKey !== lastStudioFoKey) {
    lastStudioFoKey = foKey;
    const gallery = el('studio-fo-gallery');
    gallery.innerHTML = '';
    getAllStudioProjects().forEach(proj => {
      const count = state.foTypes[proj.id] || 0;
      if (count > 0) {
        const item = document.createElement('span');
        item.className = 'fo-gallery-item';
        item.innerHTML = `${icon(proj.id, 16) || proj.emoji}<span class="fo-gallery-count">x${count}</span>`;
        item.title = proj.name;
        gallery.appendChild(item);
      }
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function tick() {
  // 1. Advance active build
  if (state.activeBuild) {
    state.activeBuild.elapsed++;
    if (state.activeBuild.elapsed >= state.activeBuild.duration) {
      completeBuild(state.activeBuild.id);
      state.activeBuild = null;
    }
  }

  // 2. Animal Husbander â€” auto-buy (interval reduced by akita passive)
  if (getOwned('husbander') > 0) {
    state.husbandryTimer++;
    let husbandInterval = 60;
    const akitaBonus = getPassiveBonus('akitainu');
    if (akitaBonus > 0) husbandInterval = Math.max(10, Math.floor(60 * (1 - akitaBonus)));
    if (state.husbandryTimer >= husbandInterval && state.activeBuild === null) {
      const allAnimals = getAllPastureUpgrades();
      let best = null;
      for (let i = allAnimals.length - 1; i >= 0; i--) {
        const u = allAnimals[i];
        const cost = getCost(u.baseCost, u.id);
        if (state.cash >= cost) { best = u; break; }
      }
      if (best) {
        startBuild(best.id, best.baseCost);
        state.husbandryTimer = 0;
      }
    }
  }

  // 3. Pasture: generate fiber (with passive/tier/buff multipliers)
  let fiberBuffMult = 1;
  if (isBuffActive('double_all_production')) fiberBuffMult *= 2;
  if (isBuffActive('triple_fiber')) fiberBuffMult *= 3;
  else if (isBuffActive('double_fiber')) fiberBuffMult *= 2;
  getAllPastureUpgrades().forEach(u => {
    state.fiber += Math.floor(getAnimalTotalFiber(u.id, u.fiberPerSec) * fiberBuffMult);
  });
  state.fiber += Math.floor(getFlatPassiveFiber() * fiberBuffMult);

  // 4. Fiber Merchant: auto-sell fiber at $2 each (before mill)
  if (getOwned('fibermerchant') > 0) {
    const fiberSold = Math.min(5, state.fiber);
    state.fiber -= fiberSold;
    state.cash += fiberSold * 2;
  }

  // 5. Mill: convert fiber â†’ skeins (with mill speed + buff multipliers)
  let millMult = getMillSpeedMultiplier();
  if (isBuffActive('double_all_production')) millMult *= 2;
  const processRate = Math.floor(getAllMillProcessing().reduce((s, u) => s + getOwned(u.id) * u.processPerSec, 0) * millMult);
  const processed = Math.min(processRate, state.fiber);
  state.fiber -= processed;
  let skeinsGained = processed;
  const iceBonus = getPassiveBonus('icelandic');
  if (iceBonus > 0) skeinsGained += Math.floor(processed * iceBonus);
  state.skeins += skeinsGained;

  // 6. Studio: advance active project (with passive/buff multipliers)
  if (state.activeProject) {
    state.activeProject.elapsed += isBuffActive('double_all_production') ? 2 : 1;
    if (state.activeProject.elapsed >= state.activeProject.duration) {
      let payout = state.activeProject.payout * getProjectPayoutMultiplier() * getPassiveIncomeMultiplier();
      const dyeBonus = getPassiveBonus('vicuna');
      if (dyeBonus > 0) payout *= (1 + dyeBonus);
      if (state.goldenFleece) { payout *= 5; state.goldenFleece = false; }
      state.cash += Math.floor(payout);
      state.fos++;
      state.foTypes[state.activeProject.id] = (state.foTypes[state.activeProject.id] || 0) + 1;
      spawnCompletionEmoji(state.activeProject.id, state.activeProject.emoji);
      state.activeProject = null;
    }
  }

  // 6b. Auto-crafter (interval reduced by Viking Rally buff)
  if (getOwned('autocrafter') > 0 && !state.activeProject) {
    state.autocraftTimer++;
    const craftInterval = isBuffActive('fast_autocraft') ? 2 : 10;
    if (state.autocraftTimer >= craftInterval) {
      const affordable = getAllStudioProjects().filter(p => state.skeins >= p.skeinCost);
      if (affordable.length > 0) {
        const pick = affordable[Math.floor(Math.random() * affordable.length)];
        startProject(pick);
        state.autocraftTimer = 0;
      }
    }
  } else if (state.activeProject) {
    state.autocraftTimer = 0;
  }

  // 7. Shop: sell skeins (with passive/buff multipliers)
  let shopMult = getPassiveShopPriceMultiplier();
  if (isBuffActive('double_shop_price')) shopMult *= 2;
  const incomeMult = getPassiveIncomeMultiplier();
  const baseSellRate = getAllShopUpgrades().reduce((s, u) => s + getOwned(u.id) * u.skeinsPerSec, 0);
  const effectiveSellRate = isBuffActive('double_all_production') ? baseSellRate * 2 : baseSellRate;
  const sold = Math.min(effectiveSellRate, state.skeins);
  state.skeins -= sold;
  state.cash += Math.floor(sold * 5 * state.dyeMultiplier * shopMult * incomeMult);

  // 8. S.A.B.L.E. + wombat passive income
  if (getOwned('sable') > 0) state.cash += Math.floor(500 * incomeMult);
  const flatCash = getFlatPassiveCash();
  if (flatCash > 0) state.cash += Math.floor(flatCash * incomeMult);

  // Clean expired buffs
  const now = Date.now();
  for (const key of Object.keys(state.activeBuffs)) {
    if (now >= state.activeBuffs[key].expiresAt) delete state.activeBuffs[key];
  }

  updateUI();
  checkMilestones();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDIO BACK: COMPLETION EMOJIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function spawnCompletionEmoji(id, emoji) {
  const container = el('studio-scene');
  // big emoji pop
  const span = document.createElement('span');
  span.className = 'completion-emoji';
  span.innerHTML = icon(id, 32) || emoji;
  span.style.left = (30 + Math.random() * 40) + '%';
  span.style.bottom = '35%';
  container.appendChild(span);
  setTimeout(() => span.remove(), 2000);

  // confetti burst
  const confettiColors = ['#d4a5a5','#c4b7d4','#b5c4a8','#f0d6a8','#e8a87c','#a8d0e6'];
  for (let i = 0; i < 18; i++) {
    const c = document.createElement('div');
    c.className = 'confetti';
    c.style.background = confettiColors[i % confettiColors.length];
    c.style.left = '50%';
    c.style.top = '40%';
    const angle = (Math.PI * 2 / 18) * i;
    const dist = 40 + Math.random() * 60;
    c.style.setProperty('--cx', Math.cos(angle) * dist + 'px');
    c.style.setProperty('--cy', Math.sin(angle) * dist - 30 + 'px');
    c.style.animationDelay = (Math.random() * 0.15) + 's';
    container.appendChild(c);
    setTimeout(() => c.remove(), 1500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MILESTONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let toastTimeout = null;
function showToast(msg) {
  const toast = el('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  if (toastTimeout) clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => toast.classList.remove('show'), 3500);
}

function checkMilestones() {
  MILESTONES.forEach(m => {
    if (!state.milestonesHit[m.id] && m.test()) {
      state.milestonesHit[m.id] = true;
      showToast(m.msg);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE / LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SAVE_KEY = 'fleece_to_fashion_save';
const SAVE_VERSION = 2;

function saveGame() {
  state.lastSaveTime = Date.now();
  const saveData = {
    version: SAVE_VERSION,
    timestamp: Date.now(),
    state: JSON.parse(JSON.stringify(state)),
  };
  try {
    localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
  } catch (e) {
    console.warn('Save failed:', e);
  }
}

function loadGame() {
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return false;
    const saveData = JSON.parse(raw);
    if (!saveData.version || saveData.version > SAVE_VERSION) return false;
    const s = saveData.state;

    state.cash = s.cash ?? 50;
    state.fiber = s.fiber ?? 0;
    state.skeins = s.skeins ?? 0;
    state.fos = s.fos ?? 0;
    state.owned = s.owned ?? {};
    state.dyeMultiplier = s.dyeMultiplier ?? 1;
    state.activeProject = s.activeProject ?? null;
    state.activeBuild = s.activeBuild ?? null;
    state.husbandryTimer = s.husbandryTimer ?? 0;
    state.autocraftTimer = s.autocraftTimer ?? 0;
    state.milestonesHit = s.milestonesHit ?? {};
    state.animalNames = s.animalNames ?? [];
    state.foTypes = s.foTypes ?? {};
    state.lastSaveTime = s.lastSaveTime ?? Date.now();
    state.currentCountry = s.currentCountry ?? 'home';
    state.unlockedCountries = s.unlockedCountries ?? ['home'];
    state.animalTiers = s.animalTiers ?? {};
    state.abilityCooldowns = s.abilityCooldowns ?? {};
    state.activeBuffs = s.activeBuffs ?? {};
    state.goldenFleece = s.goldenFleece ?? false;

    // v1 â†’ v2 migration: convert type-level tiers to per-instance arrays
    if (saveData.version < 2) {
      const oldTiers = { ...state.animalTiers };
      state.animalTiers = {};
      for (const [id, tier] of Object.entries(oldTiers)) {
        const owned = getOwned(id);
        if (owned > 0) state.animalTiers[id] = new Array(owned).fill(tier);
      }
      // Create arrays for animals with owned > 0 but no tier entry
      getAllPastureUpgrades().forEach(u => {
        if (isAnimalId(u.id) && getOwned(u.id) > 0 && !state.animalTiers[u.id]) {
          state.animalTiers[u.id] = new Array(getOwned(u.id)).fill(0);
        }
      });
    }

    return saveData.timestamp;
  } catch (e) {
    console.warn('Load failed:', e);
    return false;
  }
}

function applyOfflineProgress(saveTimestamp) {
  const elapsed = Math.min(Math.floor((Date.now() - saveTimestamp) / 1000), 86400);
  if (elapsed <= 0) return 0;

  // Complete in-progress build
  if (state.activeBuild) {
    const rem = state.activeBuild.duration - state.activeBuild.elapsed;
    if (rem <= elapsed) {
      completeBuild(state.activeBuild.id);
      state.activeBuild = null;
    } else {
      state.activeBuild.elapsed += elapsed;
    }
  }

  // Complete in-progress project (with passive multipliers)
  if (state.activeProject) {
    const rem = state.activeProject.duration - state.activeProject.elapsed;
    if (rem <= elapsed) {
      let payout = state.activeProject.payout * getProjectPayoutMultiplier() * getPassiveIncomeMultiplier();
      const dyeBonus = getPassiveBonus('vicuna');
      if (dyeBonus > 0) payout *= (1 + dyeBonus);
      state.cash += Math.floor(payout);
      state.fos++;
      state.foTypes[state.activeProject.id] = (state.foTypes[state.activeProject.id] || 0) + 1;
      state.activeProject = null;
    } else {
      state.activeProject.elapsed += elapsed;
    }
  }

  // Bulk-apply steady-state rates (all unlocked countries, with passive multipliers â€” no buffs offline)
  const fiberRate = getAllPastureUpgrades().reduce((s, u) => s + getAnimalTotalFiber(u.id, u.fiberPerSec), 0)
    + getFlatPassiveFiber();
  const millMult = getMillSpeedMultiplier();
  const processRate = Math.floor(getAllMillProcessing().reduce((s, u) => s + getOwned(u.id) * u.processPerSec, 0) * millMult);
  const shopMult = getPassiveShopPriceMultiplier();
  const incomeMult = getPassiveIncomeMultiplier();
  const sellRate = getAllShopUpgrades().reduce((s, u) => s + getOwned(u.id) * u.skeinsPerSec, 0);
  const fiberMerchantRate = getOwned('fibermerchant') > 0 ? 5 : 0;
  const sableIncome = getOwned('sable') > 0 ? 500 : 0;
  const flatCash = getFlatPassiveCash();

  const netFiberIn = fiberRate - fiberMerchantRate;
  const effectiveProcess = Math.min(processRate, Math.max(0, netFiberIn));
  const netFiber = netFiberIn - effectiveProcess;

  const iceBonus = getPassiveBonus('icelandic');
  state.fiber += Math.max(0, netFiber * elapsed);
  const skeinsProduced = Math.floor(effectiveProcess * elapsed * (1 + iceBonus));
  const skeinsSold = Math.min(sellRate * elapsed, state.skeins + skeinsProduced);
  state.skeins += skeinsProduced - skeinsSold;
  state.cash += fiberMerchantRate * 2 * elapsed;
  state.cash += Math.floor(skeinsSold * 5 * state.dyeMultiplier * shopMult * incomeMult);
  state.cash += Math.floor(sableIncome * incomeMult * elapsed);
  state.cash += Math.floor(flatCash * incomeMult * elapsed);

  // Clear any buffs that expired while offline
  const now = Date.now();
  for (const key of Object.keys(state.activeBuffs)) {
    if (now >= state.activeBuffs[key].expiresAt) delete state.activeBuffs[key];
  }

  return elapsed;
}

function resetGame() {
  if (!confirm('Reset all progress? This cannot be undone.')) return;
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEATHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentWeather = 'clear';
let weatherInterval = null;

function pickWeather() {
  const month = new Date().getMonth(); // 0-11
  const isWinter = month === 11 || month <= 1;
  const r = Math.random();
  if (isWinter) {
    if (r < 0.30) currentWeather = 'snow';
    else if (r < 0.50) currentWeather = 'rain';
    else if (r < 0.70) currentWeather = 'cloudy';
    else currentWeather = 'clear';
  } else {
    if (r < 0.25) currentWeather = 'rain';
    else if (r < 0.50) currentWeather = 'cloudy';
    else currentWeather = 'clear';
  }
  renderWeather();
}

function renderWeather() {
  const layer = el('weather-layer');
  layer.innerHTML = '';
  // always show clouds for cloudy/rain/snow
  if (currentWeather !== 'clear') {
    for (let i = 0; i < 3; i++) {
      const cloud = document.createElement('div');
      cloud.className = 'cloud';
      layer.appendChild(cloud);
    }
  }
  // rain or snow particles
  if (currentWeather === 'rain' || currentWeather === 'snow') {
    if (weatherInterval) clearInterval(weatherInterval);
    weatherInterval = setInterval(() => {
      if (layer.querySelectorAll('.raindrop,.snowflake').length > 15) return;
      const p = document.createElement('div');
      if (currentWeather === 'rain') {
        p.className = 'raindrop';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDuration = (0.6 + Math.random() * 0.6) + 's';
        setTimeout(() => p.remove(), 1500);
      } else {
        p.className = 'snowflake';
        p.textContent = 'â€¢';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDuration = (3 + Math.random() * 3) + 's';
        setTimeout(() => p.remove(), 6000);
      }
      layer.appendChild(p);
    }, currentWeather === 'rain' ? 150 : 400);
  } else {
    if (weatherInterval) { clearInterval(weatherInterval); weatherInterval = null; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENE INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initScenes() {
  // Mill: generate spokes
  const wheel = el('mill-wheel');
  for (let i = 0; i < 8; i++) {
    const spoke = document.createElement('div');
    spoke.className = 'wheel-spoke';
    spoke.style.transform = `rotate(${i * 45}deg)`;
    wheel.appendChild(spoke);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKER TAPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Shuffle deck â€” cycles through all messages before reshuffling, no back-to-back repeats
let tickerDeck = [];
let lastTickerMsg = '';
function nextTickerMsg() {
  // 30% chance to show a country-specific message when on a non-home country
  const countryMsgs = COUNTRY_TICKER[state.currentCountry];
  if (countryMsgs && Math.random() < 0.3) {
    const msg = countryMsgs[Math.floor(Math.random() * countryMsgs.length)];
    if (msg !== lastTickerMsg) { lastTickerMsg = msg; return msg; }
  }
  if (tickerDeck.length === 0) {
    tickerDeck = [...TICKER_MESSAGES];
    // Fisher-Yates shuffle
    for (let i = tickerDeck.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [tickerDeck[i], tickerDeck[j]] = [tickerDeck[j], tickerDeck[i]];
    }
    // if first in new deck matches last shown, swap with a random later one
    if (tickerDeck[0] === lastTickerMsg && tickerDeck.length > 1) {
      const swap = 1 + Math.floor(Math.random() * (tickerDeck.length - 1));
      [tickerDeck[0], tickerDeck[swap]] = [tickerDeck[swap], tickerDeck[0]];
    }
  }
  lastTickerMsg = tickerDeck.pop();
  return lastTickerMsg;
}
function cycleTicker() {
  const ticker = el('ticker');
  ticker.classList.add('fade');
  setTimeout(() => {
    ticker.textContent = nextTickerMsg();
    ticker.classList.remove('fade');
  }, 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ABILITY & TIER ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Legacy wrappers â€” delegate to per-instance functions
function getAnimalTierCost(animalId) {
  const tiers = getAnimalTierArray(animalId);
  if (tiers.length === 0) return Infinity;
  const minTier = Math.min(...tiers);
  return getInstanceTierCost(animalId, minTier);
}

function upgradeAnimalTier(animalId) {
  upgradeNextInstance(animalId);
}

function activateAbility(animalId) {
  const p = ANIMAL_POWERS[animalId];
  if (!p?.ability || getOwned(animalId) === 0) return;
  if (getAbilityCooldownRemaining(animalId) > 0) return;
  const ab = p.ability;
  const now = Date.now();
  state.abilityCooldowns[animalId] = now + ab.cooldown * 1000;

  switch (ab.effect) {
    case 'instant_fiber_60s':
    case 'instant_fiber_120s': {
      const secs = ab.effect === 'instant_fiber_120s' ? 120 : 60;
      let total = 0;
      getAllPastureUpgrades().forEach(u => { total += getAnimalTotalFiber(u.id, u.fiberPerSec); });
      total += getFlatPassiveFiber();
      const grant = Math.floor(total * secs);
      state.fiber += grant;
      showToast(`${ab.emoji} ${ab.name}! +${fmt(grant)} fiber`);
      break;
    }
    case 'double_shop_price':
      state.activeBuffs.double_shop_price = { expiresAt: now + ab.duration * 1000 };
      showToast(`${ab.emoji} ${ab.name}! 2x shop price for ${ab.duration}s`);
      break;
    case 'double_all_production':
      state.activeBuffs.double_all_production = { expiresAt: now + ab.duration * 1000 };
      showToast(`${ab.emoji} ${ab.name}! 2x all production for ${ab.duration}s`);
      break;
    case 'instant_complete':
      if (state.activeBuild) {
        completeBuild(state.activeBuild.id);
        state.activeBuild = null;
        showToast(`${ab.emoji} ${ab.name}! Build completed!`);
      } else if (state.activeProject) {
        state.cash += Math.floor(state.activeProject.payout);
        state.fos++;
        state.foTypes[state.activeProject.id] = (state.foTypes[state.activeProject.id] || 0) + 1;
        state.activeProject = null;
        showToast(`${ab.emoji} ${ab.name}! Project completed!`);
      } else {
        state.abilityCooldowns[animalId] = 0;
        showToast('Nothing to headbutt!');
      }
      break;
    case 'triple_fiber':
      state.activeBuffs.triple_fiber = { expiresAt: now + ab.duration * 1000 };
      showToast(`${ab.emoji} ${ab.name}! 3x fiber for ${ab.duration}s`);
      break;
    case 'instant_cash_30s': {
      const sellRate = getAllShopUpgrades().reduce((s, u) => s + getOwned(u.id) * u.skeinsPerSec, 0);
      const cashPerSec = sellRate * 5 * state.dyeMultiplier * getPassiveShopPriceMultiplier() * getPassiveIncomeMultiplier()
        + (getOwned('sable') > 0 ? 500 : 0) + getFlatPassiveCash();
      const grant = Math.floor(cashPerSec * 30);
      state.cash += grant;
      showToast(`${ab.emoji} ${ab.name}! +$${fmt(grant)}`);
      break;
    }
    case 'instant_convert_fiber': {
      const converted = state.fiber;
      state.skeins += converted;
      state.fiber = 0;
      showToast(`${ab.emoji} ${ab.name}! ${fmt(converted)} fiber â†’ skeins`);
      break;
    }
    case 'next_project_5x':
      state.goldenFleece = true;
      showToast(`${ab.emoji} ${ab.name}! Next project pays 5x!`);
      break;
    case 'fast_autocraft':
      state.activeBuffs.fast_autocraft = { expiresAt: now + ab.duration * 1000 };
      showToast(`${ab.emoji} ${ab.name}! Rapid crafting for ${ab.duration}s!`);
      break;
    case 'country_discount':
      state.activeBuffs.country_discount = { expiresAt: now + ab.duration * 1000 };
      showToast(`${ab.emoji} ${ab.name}! -20% country costs for ${ab.duration}s!`);
      break;
    case 'double_fiber':
      state.activeBuffs.double_fiber = { expiresAt: now + ab.duration * 1000 };
      showToast(`${ab.emoji} ${ab.name}! 2x fiber for ${ab.duration}s!`);
      break;
    case 'instant_sell_3x': {
      const sk = state.skeins;
      const price = 5 * state.dyeMultiplier * getPassiveShopPriceMultiplier() * getPassiveIncomeMultiplier() * 3;
      state.cash += Math.floor(sk * price);
      state.skeins = 0;
      showToast(`${ab.emoji} ${ab.name}! Sold ${fmt(sk)} skeins at 3x!`);
      break;
    }
    case 'instant_buy_5': {
      let bought = 0;
      for (let i = 0; i < 5; i++) {
        const allAnimals = getAllPastureUpgrades();
        let best = null;
        for (let j = allAnimals.length - 1; j >= 0; j--) {
          const u = allAnimals[j];
          const cost = getCost(u.baseCost, u.id);
          if (state.cash >= cost) { best = u; break; }
        }
        if (best) {
          state.cash -= getCost(best.baseCost, best.id);
          state.owned[best.id] = getOwned(best.id) + 1;
          if (isAnimalId(best.id)) {
            if (!state.animalTiers[best.id]) state.animalTiers[best.id] = [];
            state.animalTiers[best.id].push(0);
          }
          bought++;
        }
      }
      showToast(`${ab.emoji} ${ab.name}! ${bought} animals purchased!`);
      break;
    }
  }
  updateUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHARACTER SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let charRotation = 0;
let charAutoRotate = true;
let charAutoRotateRAF = null;
let charDragging = false;
let charDragStartX = 0;
let charDragStartRotation = 0;
let charParticleInterval = null;

let charCurrentAnimalId = null;
let charCooldownInterval = null;

function renderCharPassives(animalId) {
  const c = el('char-passives');
  c.innerHTML = '';
  const p = ANIMAL_POWERS[animalId];
  if (!p?.passive) return;
  const owned = getOwned(animalId);
  c.innerHTML = `<div class="char-passive-name">${p.passive.name}</div>
    <div class="char-passive-desc">${p.passive.desc}</div>
    <div class="char-passive-thresholds">${p.passive.thresholds.map(t => {
      const active = owned >= t.count;
      return `<div class="char-passive-threshold${active ? ' active' : ''}">
        <span class="cpt-count">${t.count} owned</span>
        <span class="cpt-label">${t.label}</span>
        <span class="cpt-check">${active ? '&#10003;' : '&#9711;'}</span>
      </div>`;
    }).join('')}</div>`;
}

function renderCharAbility(animalId) {
  const wrap = el('char-ability-wrap');
  const p = ANIMAL_POWERS[animalId];
  if (!p?.ability || getOwned(animalId) === 0) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';
  const ab = p.ability;
  el('char-ability-name').textContent = `${ab.emoji} ${ab.name}`;
  el('char-ability-desc').textContent = ab.desc;
  const btn = el('char-ability-btn');
  const btnText = el('char-ability-btn-text');
  const cdBar = el('char-ability-cd-bar');
  const cdFill = el('char-ability-cd-fill');
  const remaining = getAbilityCooldownRemaining(animalId);
  if (remaining > 0) {
    btn.disabled = true;
    btnText.textContent = `${remaining}s`;
    cdBar.style.display = 'block';
    cdFill.style.width = ((remaining / ab.cooldown) * 100) + '%';
  } else {
    btn.disabled = false;
    btnText.textContent = 'Activate';
    cdBar.style.display = 'none';
  }
  btn.onclick = () => { activateAbility(animalId); renderCharAbility(animalId); };
}

function renderCharTierUpgrade(animalId) {
  const wrap = el('char-tier-upgrade');
  const p = ANIMAL_POWERS[animalId];
  if (!p?.tiers || getOwned(animalId) === 0) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'flex';

  const tiers = getAnimalTierArray(animalId);
  const TIER_COLORS = ['rgba(255,255,255,0.2)', '#cd7f32', '#c0c0c0', '#ffd700'];

  // Per-instance dot indicators
  let html = '<div class="tier-distribution">';
  tiers.forEach((t, i) => {
    html += `<span class="tier-dot" style="background:${TIER_COLORS[t]}" title="Instance ${i+1}: ${t === 0 ? 'No tier' : TIER_DEFS[t-1].name}"></span>`;
  });
  html += '</div>';

  // Summary text
  const counts = [0, 0, 0, 0];
  tiers.forEach(t => counts[t]++);
  const parts = [];
  if (counts[0]) parts.push(`${counts[0]} base`);
  if (counts[1]) parts.push(`${counts[1]} Bronze`);
  if (counts[2]) parts.push(`${counts[2]} Silver`);
  if (counts[3]) parts.push(`${counts[3]} Gold`);
  html += `<div class="tier-summary">${parts.join(' / ')}</div>`;

  el('char-tier-stars').innerHTML = html;

  // "Upgrade Next" button
  const btn = el('char-tier-btn');
  const minTier = tiers.length > 0 ? Math.min(...tiers) : 0;
  if (minTier >= 3) {
    btn.textContent = 'ALL MAX';
    btn.disabled = true;
    btn.classList.add('maxed');
  } else {
    const cost = getInstanceTierCost(animalId, minTier);
    btn.textContent = `${TIER_DEFS[minTier].name} $${fmt(cost)}`;
    btn.disabled = state.cash < cost;
    btn.classList.remove('maxed');
    btn.onclick = () => {
      upgradeNextInstance(animalId);
      renderCharTierUpgrade(animalId);
      // Refresh fiber display
      const u = getAllPastureUpgrades().find(x => x.id === animalId);
      if (u) {
        const eff = Math.floor(getAnimalTotalFiber(animalId, u.fiberPerSec) / Math.max(1, getOwned(animalId)));
        el('char-fiber-val').textContent = fmt(eff);
      }
      // Refresh tier badge
      const t2 = getAnimalTierArray(animalId);
      const maxT = t2.length > 0 ? Math.max(...t2) : 0;
      const vibe = getAnimalVibe(animalId);
      el('char-tier').textContent = maxT > 0 ? `${vibe.tier} ${'â˜…'.repeat(maxT)}` : vibe.tier;
    };
  }
}

function openCharScreen(animalId, animalIndex) {
  charCurrentAnimalId = animalId;
  const allUpgrades = getAllPastureUpgrades();
  const upgradeData = allUpgrades.find(u => u.id === animalId);
  if (!upgradeData) return;

  const vibe = getAnimalVibe(animalId);
  const animalName = state.animalNames[animalIndex] || 'Unknown';
  const owned = getOwned(animalId);

  let origin = 'Home Farm';
  COUNTRIES.forEach(c => {
    if (c.animals && c.animals.some(a => a.id === animalId)) origin = c.name;
  });

  const modal = el('char-modal');
  modal.style.setProperty('--char-bg', vibe.gradient);
  modal.style.setProperty('--char-glow-color', vibe.glowColor);
  modal.style.setProperty('--char-tier-color', vibe.tierColor);
  modal.style.setProperty('--char-particle-color', vibe.particleColor);

  // Tier badge with highest tier stars
  const tierArr = getAnimalTierArray(animalId);
  const maxTier = tierArr.length > 0 ? Math.max(...tierArr) : 0;
  el('char-tier').textContent = maxTier > 0 ? `${vibe.tier} ${'â˜…'.repeat(maxTier)}` : vibe.tier;
  el('char-tier').style.background = vibe.tierColor;

  el('char-emoji').innerHTML = icon(upgradeData.id, 80) || upgradeData.emoji;
  el('char-name').textContent = animalName;
  el('char-breed').textContent = upgradeData.name;
  el('char-tagline').textContent = vibe.tagline;
  el('char-owned-val').textContent = owned;
  el('char-origin-val').textContent = origin;
  el('char-flavor').textContent = vibe.personality;

  // Effective fiber rate (average per animal with per-instance tiers)
  const totalFiber = getAnimalTotalFiber(animalId, upgradeData.fiberPerSec);
  const effectiveFiber = owned > 0 ? Math.floor(totalFiber / owned) : upgradeData.fiberPerSec;
  el('char-fiber-val').textContent = fmt(effectiveFiber);

  el('char-emoji').style.animation = `char-idle-${vibe.idleAnimation} 3s ease-in-out infinite`;

  const maxFiber = 2000;
  const fiberPct = Math.min(100, (effectiveFiber / maxFiber) * 100);
  const fiberFill = el('char-stat-fiber');
  fiberFill.style.width = '0%';
  requestAnimationFrame(() => { fiberFill.style.width = fiberPct + '%'; });

  // Render powers UI
  renderCharPassives(animalId);
  renderCharAbility(animalId);
  renderCharTierUpgrade(animalId);

  charRotation = 0;
  charAutoRotate = true;
  updateCharRotation();

  el('char-overlay').classList.add('active');
  document.body.style.overflow = 'hidden';

  startCharParticles(vibe);
  startAutoRotate();

  const hint = el('char-drag-hint');
  hint.style.animation = 'none';
  requestAnimationFrame(() => { hint.style.animation = 'char-hint-fade 3s ease 1.5s both'; });

  // Cooldown refresh interval
  if (charCooldownInterval) clearInterval(charCooldownInterval);
  charCooldownInterval = setInterval(() => {
    if (charCurrentAnimalId) renderCharAbility(charCurrentAnimalId);
  }, 1000);
}

function closeCharScreen() {
  el('char-overlay').classList.remove('active');
  document.body.style.overflow = '';
  stopCharParticles();
  stopAutoRotate();
  charCurrentAnimalId = null;
  if (charCooldownInterval) { clearInterval(charCooldownInterval); charCooldownInterval = null; }
}

function updateCharRotation() {
  const rad = charRotation * Math.PI / 180;
  const tx = Math.sin(rad) * 8;
  const ry = Math.sin(rad) * 15;
  const sc = 1 + Math.sin(rad * 2) * 0.03;
  el('char-animal').style.transform = `translateX(${tx.toFixed(1)}px) rotateY(${ry.toFixed(1)}deg) scale(${sc.toFixed(3)})`;
  el('char-platform').style.transform = `rotateX(60deg) rotateZ(${charRotation}deg)`;
}

function startAutoRotate() {
  let lastTime = performance.now();
  function step(now) {
    if (!el('char-overlay').classList.contains('active')) return;
    if (charAutoRotate) {
      const dt = (now - lastTime) / 1000;
      charRotation += 30 * dt;
      updateCharRotation();
    }
    lastTime = now;
    charAutoRotateRAF = requestAnimationFrame(step);
  }
  charAutoRotateRAF = requestAnimationFrame(step);
}

function stopAutoRotate() {
  if (charAutoRotateRAF) { cancelAnimationFrame(charAutoRotateRAF); charAutoRotateRAF = null; }
}

function onCharDragStart(e) {
  charDragging = true;
  charAutoRotate = false;
  charDragStartX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
  charDragStartRotation = charRotation;
  e.preventDefault();
}
function onCharDragMove(e) {
  if (!charDragging) return;
  const clientX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
  charRotation = charDragStartRotation + (clientX - charDragStartX) * 0.8;
  updateCharRotation();
}
function onCharDragEnd() {
  if (!charDragging) return;
  charDragging = false;
  setTimeout(() => { if (!charDragging) charAutoRotate = true; }, 2000);
}

function startCharParticles(vibe) {
  stopCharParticles();
  const container = el('char-particles');
  container.innerHTML = '';
  charParticleInterval = setInterval(() => {
    if (container.children.length > 12) return;
    const useEmoji = vibe.particleEmoji[0] !== '~';
    const p = document.createElement('div');
    if (useEmoji) {
      p.className = 'char-particle';
      p.textContent = vibe.particleEmoji[Math.floor(Math.random() * vibe.particleEmoji.length)];
    } else {
      p.className = 'char-particle-puff';
    }
    p.style.left = (20 + Math.random() * 60) + '%';
    p.style.top = (30 + Math.random() * 40) + '%';
    const angle = Math.random() * Math.PI * 2;
    const dist = 40 + Math.random() * 60;
    p.style.setProperty('--px', Math.cos(angle) * dist + 'px');
    p.style.setProperty('--py', (Math.sin(angle) * dist - 30) + 'px');
    p.style.animationDuration = (3 + Math.random() * 3) + 's';
    container.appendChild(p);
    setTimeout(() => p.remove(), parseFloat(p.style.animationDuration) * 1000 + 500);
  }, 400);
}

function stopCharParticles() {
  if (charParticleInterval) { clearInterval(charParticleInterval); charParticleInterval = null; }
  const c = document.getElementById('char-particles');
  if (c) c.innerHTML = '';
}

// Event listeners
document.addEventListener('click', (e) => {
  const animal = e.target.closest('.scene-animal');
  if (!animal) return;
  const id = animal.dataset.animalId;
  const idx = parseInt(animal.dataset.animalIndex, 10);
  if (id) openCharScreen(id, idx);
});

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && el('shop-overlay').classList.contains('active')) closeShopDetail();
  else if (e.key === 'Escape' && el('char-overlay').classList.contains('active')) closeCharScreen();
});

el('char-overlay').addEventListener('click', (e) => {
  if (e.target === el('char-overlay')) closeCharScreen();
});
el('char-close').addEventListener('click', closeCharScreen);

el('shop-overlay').addEventListener('click', (e) => {
  if (e.target === el('shop-overlay')) closeShopDetail();
});
el('shop-detail-close').addEventListener('click', closeShopDetail);

const charStage = el('char-stage');
charStage.addEventListener('mousedown', onCharDragStart);
document.addEventListener('mousemove', onCharDragMove);
document.addEventListener('mouseup', onCharDragEnd);
charStage.addEventListener('touchstart', onCharDragStart, { passive: false });
document.addEventListener('touchmove', onCharDragMove, { passive: false });
document.addEventListener('touchend', onCharDragEnd);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

initScenes();
pickWeather();

// Load saved game
const saveTimestamp = loadGame();
if (saveTimestamp) {
  const offlineSecs = applyOfflineProgress(saveTimestamp);
  if (offlineSecs > 60) {
    setTimeout(() => showToast(`Welcome back! ${Math.floor(offlineSecs / 60)}min of offline progress applied.`), 500);
  }
}

updateUI();
setInterval(tick, 1000);
setInterval(cycleTicker, 10000);
setInterval(spawnCityCustomer, 2000);
setInterval(wanderAnimals, 3000);
setInterval(pickWeather, 60000);
setInterval(saveGame, 30000);
window.addEventListener('beforeunload', saveGame);
</script>
</body>
</html>
